[{"id":"bf97828f.e0d5","type":"tab","label":"Washmachine State Machine ","disabled":false,"info":""},{"id":"ebed6492.dd9558","type":"tab","label":"Entrance node","disabled":false,"info":""},{"id":"2159e868.08f748","type":"tab","label":"Presence detection","disabled":false,"info":""},{"id":"117ae75e.a5f4b9","type":"tab","label":"Livingroom node","disabled":false,"info":""},{"id":"b5887534.3c6f4","type":"tab","label":"Balcony node","disabled":false,"info":""},{"id":"474b74d5.8d1c2c","type":"tab","label":"Attic node","disabled":false,"info":""},{"id":"c7dd94f4.6cfe98","type":"tab","label":"Bedroom node","disabled":false,"info":""},{"id":"890e444f.7e4898","type":"tab","label":"Reminder node","disabled":false,"info":""},{"id":"8874c4d3.200988","type":"tab","label":"General settings","disabled":false,"info":""},{"id":"372c6a0a.5b6fa6","type":"tab","label":"Statistics","disabled":false,"info":""},{"id":"f2d0d6f7.e3639","type":"tab","label":"Super Lamp Network","disabled":false,"info":""},{"id":"e9df2fe6.24247","type":"tab","label":"Terrace node","disabled":false,"info":""},{"id":"e67c6dfd.2c6b98","type":"mqtt-broker","z":"","name":"mosquitto","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"9a2a32a2.fb4ce","type":"ui_tab","z":"","name":"House control","icon":"home","order":1},{"id":"cc52bacb.554398","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#007eb1","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#007eb1","edited":true},"page-titlebar-backgroundColor":{"value":"#007eb1","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#00b4fd","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#007eb1","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"f933085d.8cad7","type":"ui_group","z":"","name":"Attic","tab":"9a2a32a2.fb4ce","disp":true,"width":"4","collapse":false},{"id":"22dbe042.537a68","type":"ui_tab","z":"","name":"Graphs","icon":"fa-signal","order":8},{"id":"fb91ed0a.105588","type":"ui_group","z":"","name":"Attic","tab":"22dbe042.537a68","disp":true,"width":"12","collapse":false},{"id":"66bb6238.405dac","type":"ui_group","z":"","name":"Livingroom","tab":"9a2a32a2.fb4ce","disp":true,"width":"4","collapse":false},{"id":"e70be721.600c28","type":"ui_group","z":"","name":"Livingroom","tab":"22dbe042.537a68","disp":true,"width":"12","collapse":false},{"id":"4406aa4.a2328d4","type":"ui_group","z":"","name":"Washmachine","tab":"22dbe042.537a68","disp":true,"width":"12","collapse":false},{"id":"c086012c.2407d8","type":"ui_group","z":"","name":"Who is at home?","tab":"9a2a32a2.fb4ce","disp":true,"width":"4","collapse":false},{"id":"59f1345a.5292fc","type":"ifttt-key","z":""},{"id":"dab75ed.980752","type":"ifttt-key","z":""},{"id":"75b5c45e.52e19c","type":"ui_spacer","name":"spacer","group":"e70be721.600c28","order":2,"width":1,"height":1},{"id":"c4f8e805.745818","type":"ui_group","z":"","name":"Bedroom","tab":"9a2a32a2.fb4ce","disp":true,"width":"4","collapse":false},{"id":"de3873be.99eeb","type":"ui_group","z":"","name":"Bedroom","tab":"22dbe042.537a68","disp":true,"width":"12","collapse":false},{"id":"6ab69360.278fbc","type":"ui_group","z":"","name":"Alarm","tab":"f908e3f7.c340e8","order":3,"disp":true,"width":"6","collapse":false},{"id":"d5304c8f.46869","type":"ui_group","z":"","name":"Silent mode","tab":"dd59a7f5.332858","disp":true,"width":"6","collapse":false},{"id":"3e60f547.b8d2f2","type":"ui_tab","z":"","name":"Attic thermostat","icon":"fa-thermometer-half ","order":2},{"id":"a6f19742.9f9e28","type":"ui_group","z":"","name":"Temperature","tab":"3e60f547.b8d2f2","disp":true,"width":"6","collapse":false},{"id":"cb4cc6fb.fdeeb8","type":"ui_group","z":"","name":"Timer","tab":"3e60f547.b8d2f2","disp":true,"width":"6","collapse":false},{"id":"dd59a7f5.332858","type":"ui_tab","z":"","name":"Configuration","icon":"fa-cog","order":7},{"id":"5db64310.9cdc4c","type":"ui_group","z":"","name":"Entrance","tab":"dd59a7f5.332858","order":2,"disp":true,"width":"6","collapse":false},{"id":"a8d5eefe.34189","type":"ui_group","z":"","name":"Balcony","tab":"dd59a7f5.332858","disp":true,"width":"6","collapse":false},{"id":"6d09be01.9f773","type":"ui_tab","z":"","name":"Statistics","icon":"fa-bug","order":9},{"id":"5ea35a44.fd3e34","type":"ui_group","z":"","name":"Entrance","tab":"6d09be01.9f773","order":2,"disp":true,"width":"6","collapse":false},{"id":"bbf7ff0.aeff5","type":"ui_group","z":"","name":"General","tab":"6d09be01.9f773","order":1,"disp":true,"width":"6","collapse":false},{"id":"b08803e9.31eb7","type":"ui_group","z":"","name":"Livingroom","tab":"6d09be01.9f773","order":3,"disp":true,"width":"6","collapse":false},{"id":"fdf24e3d.60209","type":"ui_group","z":"","name":"Bedroom","tab":"6d09be01.9f773","order":4,"disp":true,"width":"6","collapse":false},{"id":"dadda8b2.d4ca58","type":"ui_group","z":"","name":"Attic","tab":"6d09be01.9f773","order":5,"disp":true,"width":"6","collapse":false},{"id":"efcd26a0.d476d8","type":"ui_group","z":"","name":"Balcony","tab":"6d09be01.9f773","order":6,"disp":true,"width":"6","collapse":false},{"id":"4fe1af04.48d038","type":"ui_tab","z":"","name":"Livingroom lamps","icon":"fa-lightbulb-o","order":3},{"id":"ba930eb2.97191","type":"ui_group","z":"","name":"Lamp 1","tab":"4fe1af04.48d038","disp":true,"width":"6","collapse":false},{"id":"c221d889.38444","type":"ui_group","z":"","name":"Lamp 2","tab":"4fe1af04.48d038","disp":true,"width":"6","collapse":false},{"id":"7e057122.d766d8","type":"ui_group","z":"","name":"General","tab":"4fe1af04.48d038","disp":true,"width":"6","collapse":false},{"id":"8a259194.fed238","type":"ui_group","z":"","name":"Livingroom 1","tab":"4fe1af04.48d038","disp":true,"width":"6","collapse":false},{"id":"af9ce26a.3ce9b","type":"ui_group","z":"","name":"Livingroom 2","tab":"4fe1af04.48d038","disp":true,"width":"6","collapse":false},{"id":"6544dec1.16bc18","type":"ui_tab","z":"","name":"Terrace","icon":"fa-sun-o","order":5},{"id":"f585547a.bc35d8","type":"ui_group","z":"","name":"Default","tab":"6544dec1.16bc18","disp":true,"width":"6","collapse":false},{"id":"24098ce9.c81324","type":"ui_group","z":"","name":"LED Control","tab":"f908e3f7.c340e8","order":1,"disp":true,"width":"6","collapse":false},{"id":"f908e3f7.c340e8","type":"ui_tab","z":"","name":"Bedroom","icon":"fa-bed","order":4},{"id":"f194e702.838568","type":"ui_group","z":"","name":"Status","tab":"f908e3f7.c340e8","order":2,"disp":true,"width":"6","collapse":false},{"id":"7a0b13b6.143704","type":"ui_spacer","name":"spacer","group":"af0bbd1a.14a428","order":3,"width":1,"height":1},{"id":"63104382.eabef4","type":"ui_group","z":"","name":"OTA URLs","tab":"dd59a7f5.332858","disp":true,"width":"6","collapse":false},{"id":"e38ea83b.bc08","type":"ui_tab","z":"","name":"Reminders","icon":"fa-bell","order":6},{"id":"1c273207.0a0e3e","type":"ui_group","z":"","name":"General","tab":"e38ea83b.bc08","disp":true,"width":"12","collapse":false},{"id":"9bf50add.2132b8","type":"ui_group","z":"","name":"Graph","tab":"f908e3f7.c340e8","disp":true,"width":"12","collapse":false},{"id":"7f57cfa9.8614c","type":"ui_group","z":"","name":"Lamp network connection","tab":"22dbe042.537a68","disp":true,"width":"12","collapse":false},{"id":"98675b2a.e610b","type":"ui_group","z":"","name":"Guest","tab":"dd59a7f5.332858","disp":true,"width":"6","collapse":false},{"id":"4e0c77b8.37f488","type":"mqtt in","z":"ebed6492.dd9558","name":"Entrance detected","topic":"entrance_node/entrance_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":250,"y":440,"wires":[["f53b4f52.67e86","148f668e.b854e1","daa475e4.0ed7b8","5d92a4d6.91dbcc","e99de301.15d258"]]},{"id":"507ec549.9ae4dc","type":"debug","z":"117ae75e.a5f4b9","name":"Livingroom: temperature msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":630,"y":120,"wires":[]},{"id":"99febe78.752c88","type":"ui_gauge","z":"117ae75e.a5f4b9","name":"Temperature","group":"66bb6238.405dac","order":1,"width":"4","height":"3","gtype":"gage","title":"Temperature","label":"ÂºC","format":"{{value}}","min":"6","max":"30","colors":["#50b500","#e6df00","#ca3838"],"seg1":"17","seg2":"23","x":570,"y":180,"wires":[]},{"id":"97f23e9.3872b4","type":"mqtt in","z":"117ae75e.a5f4b9","name":"Temperature","topic":"livingroom_node/temperature","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":180,"wires":[["99febe78.752c88","a76268f2.7063c8","507ec549.9ae4dc"]]},{"id":"a76268f2.7063c8","type":"ui_chart","z":"117ae75e.a5f4b9","name":"Temperature graph","group":"e70be721.600c28","order":2,"width":"12","height":"6","label":"Temperature chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"6","ymax":"30","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":590,"y":260,"wires":[[],[]]},{"id":"deac84a9.4d6a","type":"exec","z":"ebed6492.dd9558","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1950,"y":960,"wires":[[],[],[]]},{"id":"9ec1170f.11f26","type":"function","z":"ebed6492.dd9558","name":"Check presence status","func":"var datetime = new Date();\n\n\nvar last_detection_raul = global.get(\"last_entrance_raul\") || 0;\nvar last_detection_cris = global.get(\"last_entrance_cris\") || 0;\nvar last_detection_guest = global.get(\"last_entrance_guest\") || 0;\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\n\nvar raul_greeted = global.get(\"raul_greeted\") || 0;\nvar cris_greeted = global.get(\"cris_greeted\") || 0;\nvar guest_greeted = global.get(\"guest_greeted\")|| 0;\n\nvar timedif_raul = datetime - last_detection_raul;\nvar timedif_cris = datetime - last_detection_cris;\nvar timedif_guest = datetime - last_detection_guest;\n\nvar new_msg = {payload: \"\", greet_raul: false, greet_cris: false, greet_guest: false, greet_generic: false}\n\nvar count_detected = 0\n\nif( (timedif_raul < detection_threshold) && !raul_greeted)\n{\n    new_msg.greet_raul = true;\n    global.set(\"raul_greeted\",true);\n}\nelse if(timedif_raul > detection_threshold) count_detected++\n\nif( (timedif_cris < detection_threshold) && !cris_greeted)\n{\n    new_msg.greet_cris = true;\n    global.set(\"cris_greeted\",true);\n}\nelse if(timedif_cris > detection_threshold) count_detected++\n\nif( (timedif_guest < detection_threshold) && !guest_greeted)\n{\n    new_msg.greet_guest = true;\n    global.set(\"guest_greeted\",true);\n}\nelse if(timedif_guest > detection_threshold) count_detected++\n\n\nif(count_detected == 3) new_msg.greet_generic = true\n\nreturn new_msg;","outputs":1,"noerr":0,"x":520,"y":780,"wires":[["6747c69a.a341b","c1efedcc.2e5b2","2bbb5601.618a22","49746e12.2f502"]]},{"id":"350e6f41.2f4d18","type":"mqtt in","z":"117ae75e.a5f4b9","name":"Humidity","topic":"livingroom_node/humidity","qos":"2","broker":"e67c6dfd.2c6b98","x":180,"y":400,"wires":[["f50ae8de.008998","20a2754e.2bab2a"]]},{"id":"f50ae8de.008998","type":"ui_chart","z":"117ae75e.a5f4b9","name":"Humidity graph","group":"e70be721.600c28","order":2,"width":"12","height":"6","label":"Humidity chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"100","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":580,"y":480,"wires":[[],[]]},{"id":"dd329880.bb98d8","type":"debug","z":"2159e868.08f748","name":"Presence detector: Cristina presence msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":680,"y":480,"wires":[]},{"id":"1a5f5835.3b5fc8","type":"ui_gauge","z":"474b74d5.8d1c2c","name":"Temperature","group":"f933085d.8cad7","order":1,"width":"4","height":"3","gtype":"gage","title":"Temperature","label":"ÂºC","format":"{{value}}","min":"6","max":"40","colors":["#50b500","#e6df00","#ca3838"],"seg1":"14","seg2":"25","x":550,"y":100,"wires":[]},{"id":"43d45f81.b8264","type":"mqtt in","z":"474b74d5.8d1c2c","name":"Temperature","topic":"attic_node/temperature","qos":"2","broker":"e67c6dfd.2c6b98","x":150,"y":120,"wires":[["1a5f5835.3b5fc8","48311a24.2c3164","1ada0611.9932ea"]]},{"id":"48311a24.2c3164","type":"ui_chart","z":"474b74d5.8d1c2c","name":"Temperature graph","group":"fb91ed0a.105588","order":2,"width":"12","height":"6","label":"Temperature chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"6","ymax":"40","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":550,"y":180,"wires":[[],[]]},{"id":"128a997c.264bc7","type":"mqtt in","z":"474b74d5.8d1c2c","name":"Humidity","topic":"attic_node/humidity","qos":"2","broker":"e67c6dfd.2c6b98","x":150,"y":260,"wires":[["189f07db.4c1848"]]},{"id":"189f07db.4c1848","type":"ui_chart","z":"474b74d5.8d1c2c","name":"Humidity graph","group":"fb91ed0a.105588","order":2,"width":"12","height":"6","label":"Humidity chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"100","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":540,"y":260,"wires":[[],[]]},{"id":"3e3075e8.5acb3a","type":"function","z":"474b74d5.8d1c2c","name":"Heating control","func":"\nvar heating = global.get(\"attic_heating\") || 0;\nvar target_temperature = flow.get(\"target_temperature\") || 0;\nvar temperature = flow.get(\"current_temperature\") || 0;\n\nvar hysteresis = 0.5\n\nif(heating)\n{\n    if(temperature < (target_temperature - hysteresis))\n    {\n        msg.payload = 1;\n        msg.topic = \"ON\";\n    }\n    else if (temperature > (target_temperature + hysteresis))\n    {\n        msg.payload = 0;\n        msg.topic = \"OFF\";\n    }\n    \n}\n\nelse\n{\n    msg.payload = 0;\n    msg.topic = \"OFF\";\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":520,"wires":[["f00f4a32.a96ca8","563bfd10.79e274"]]},{"id":"f00f4a32.a96ca8","type":"state-machine","z":"474b74d5.8d1c2c","name":"Heating SM","triggerProperty":"topic","triggerPropertyType":"msg","stateProperty":"topic","statePropertyType":"msg","outputStateChangeOnly":false,"throwException":false,"states":["OFF","OFF_SENT","ON","ON_SENT"],"transitions":[{"name":"ON","from":"OFF","to":"ON"},{"name":"ON","from":"ON","to":"ON_SENT"},{"name":"ON","from":"ON_SENT","to":"ON_SENT"},{"name":"ON","from":"OFF_SENT","to":"ON"},{"name":"OFF","from":"OFF","to":"OFF_SENT"},{"name":"OFF","from":"ON","to":"OFF"},{"name":"OFF","from":"ON_SENT","to":"OFF"},{"name":"OFF","from":"OFF_SENT","to":"OFF_SENT"}],"x":590,"y":520,"wires":[["b7dcb55c.4f5d58"]]},{"id":"b7dcb55c.4f5d58","type":"switch","z":"474b74d5.8d1c2c","name":"Switch","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"ON","vt":"str"},{"t":"eq","v":"OFF","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":770,"y":520,"wires":[["c4da8a3f.006c48","b5956062.8f48a"],["f8443444.7b9a78","d27f0769.52728"],[]],"outputLabels":["","message.topic = ",""]},{"id":"c4da8a3f.006c48","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"heating_on_1","key":"dab75ed.980752","x":1000,"y":380,"wires":[]},{"id":"f8443444.7b9a78","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"heating_off_1","key":"dab75ed.980752","x":1000,"y":560,"wires":[]},{"id":"b5956062.8f48a","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"heating_on_2","key":"dab75ed.980752","x":1000,"y":420,"wires":[]},{"id":"d27f0769.52728","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"heating_off_2","key":"dab75ed.980752","x":1000,"y":600,"wires":[]},{"id":"f4e4aee8.5fdf","type":"mqtt in","z":"117ae75e.a5f4b9","name":"Light amount","topic":"livingroom_node/light","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":620,"wires":[["655e7a2a.e6b76c"]]},{"id":"17307404.62e40c","type":"ui_gauge","z":"117ae75e.a5f4b9","name":"Light amount","group":"66bb6238.405dac","order":1,"width":"4","height":"3","gtype":"wave","title":"Light","label":"Lx","format":"{{value}}","min":0,"max":"100","colors":["#50b500","#e6df00","#ca3838"],"seg1":"","seg2":"","x":670,"y":620,"wires":[]},{"id":"46673997.207908","type":"ui_chart","z":"117ae75e.a5f4b9","name":"Light graph","group":"e70be721.600c28","order":2,"width":"12","height":"6","label":"Light chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"1000","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":670,"y":720,"wires":[[],[]]},{"id":"f05aa3b6.aa445","type":"function","z":"117ae75e.a5f4b9","name":"Set light amount ","func":"\nglobal.set(\"light_amount_livingroom\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":800,"wires":[[]]},{"id":"148f668e.b854e1","type":"function","z":"ebed6492.dd9558","name":"Livingroom lightning","func":"\nmsg.payload = global.get(\"light_amount_livingroom\") || 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":520,"wires":[["7465616.21b242"]]},{"id":"7465616.21b242","type":"switch","z":"ebed6492.dd9558","name":"Light threshold","property":"payload","propertyType":"msg","rules":[{"t":"lt","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":740,"y":520,"wires":[["e190d33f.e2bd58","d5417207.7c2a7"]]},{"id":"e190d33f.e2bd58","type":"ifttt out","z":"ebed6492.dd9558","eventName":"livingroom_on","key":"dab75ed.980752","x":940,"y":480,"wires":[]},{"id":"d05927ef.6c313","type":"debug","z":"117ae75e.a5f4b9","name":"Received msg: light amount","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":720,"y":560,"wires":[]},{"id":"655e7a2a.e6b76c","type":"json","z":"117ae75e.a5f4b9","name":"Json converter","property":"payload","action":"","pretty":false,"x":420,"y":620,"wires":[["d05927ef.6c313","17307404.62e40c","46673997.207908","f05aa3b6.aa445"]]},{"id":"23ae531b.65f60c","type":"mqtt in","z":"2159e868.08f748","name":"Cristina presence","topic":"presence_detection/cristina","qos":"2","broker":"e67c6dfd.2c6b98","x":170,"y":480,"wires":[["7d6fd9e5.99b2d8","dd329880.bb98d8"]]},{"id":"7d6fd9e5.99b2d8","type":"function","z":"2159e868.08f748","name":"Set payload Cris","func":"\nvar datetime = new Date()\n\nglobal.set(\"last_detection_cris\", datetime)\n\nvar last_entrance_cris = global.get(\"last_entrance_cris\") || 0;\nvar threshold = global.get(\"detection_threshold\") || 0;\n\nvar timedif = datetime - last_entrance_cris;\n\nif(timedif > 1.5*threshold) global.set(\"cris_greeted\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":580,"wires":[["a174ad79.3acee"]]},{"id":"e531f37a.06057","type":"inject","z":"2159e868.08f748","name":"Periodical trigger","topic":"","payload":"","payloadType":"date","repeat":"120","crontab":"","once":true,"onceDelay":"1","x":170,"y":1160,"wires":[["90d5ace0.044e48","97ff935d.fc163"]]},{"id":"a174ad79.3acee","type":"function","z":"2159e868.08f748","name":"Check payload Cris","func":"var datetime = new Date()\n\nvar last_detection = global.get(\"last_detection_cris\") || 0;\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\n\nvar time_since_last_detection = datetime - last_detection\nnode.error(time_since_last_detection)\n\nif( time_since_last_detection > detection_threshold )\n{\n    msg.payload = false\n    msg.topic = \"Exit: \"\n    global.set(\"presence_cris\",false)\n}\nelse\n{\n    msg.payload = true\n    msg.topic = \"Came: \"\n    global.set(\"presence_cris\",true)\n}\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":640,"wires":[["95381fe2.77e998","4bdf1aa7.04fa2c"]]},{"id":"4bdf1aa7.04fa2c","type":"ui_switch","z":"2159e868.08f748","name":"","label":"Cristina","tooltip":"","group":"c086012c.2407d8","order":1,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":830,"y":640,"wires":[[]]},{"id":"97ff935d.fc163","type":"exec","z":"2159e868.08f748","command":"/home/pi/Projects/presence_detection_node/presence_detection_safe","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Test exec python","x":470,"y":1800,"wires":[["9629243a.357b4"],["9629243a.357b4"],[]]},{"id":"9629243a.357b4","type":"debug","z":"2159e868.08f748","name":"Presence detector: Script output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":820,"y":1800,"wires":[]},{"id":"95381fe2.77e998","type":"switch","z":"2159e868.08f748","name":"Event at change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":860,"y":580,"wires":[["92173b4.7e4a048","91026b1a.9357f"]]},{"id":"8cd3f97a.0ece5","type":"ifttt out","z":"2159e868.08f748","eventName":"cris_at_home","key":"dab75ed.980752","x":1290,"y":440,"wires":[]},{"id":"50736ad7.194944","type":"inject","z":"2159e868.08f748","name":"Triger once at start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":190,"y":100,"wires":[["ff29f6b0.14a5e"]]},{"id":"ff29f6b0.14a5e","type":"function","z":"2159e868.08f748","name":"Set initial values","func":"\nvar datetime = new Date()\nvar detection_threshold = 120000\n\nglobal.set(\"last_detection_cris\", datetime - detection_threshold)\nglobal.set(\"last_detection_raul\", datetime - detection_threshold)\nglobal.set(\"last_detection_guest\", datetime - detection_threshold)\nglobal.set(\"last_entrance_cris\", datetime - detection_threshold)\nglobal.set(\"last_entrance_raul\", datetime - detection_threshold)\nglobal.set(\"last_entrance_guest\", datetime - detection_threshold)\n\nglobal.set(\"presence_raul\",false)\nglobal.set(\"presence_cris\",false)\nglobal.set(\"presence_guest\",false)\nglobal.set(\"detection_threshold\", detection_threshold)\n\nglobal.set(\"advertisement_done\",0);\n\nglobal.set(\"cris_greeted\",false);\nglobal.set(\"raul_greeted\",false);\nglobal.set(\"guest_greeted\",false);\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":100,"wires":[[]]},{"id":"92173b4.7e4a048","type":"switch","z":"2159e868.08f748","name":"Decide IN/OUT","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":580,"wires":[["8cd3f97a.0ece5","39a494ba.8b5db4","3bd9c0a9.da2f98"],["203ef608.48d912","39a494ba.8b5db4"]]},{"id":"4b889642.5ca4f8","type":"debug","z":"2159e868.08f748","name":"Presence detector: Raul presence msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":690,"y":340,"wires":[]},{"id":"27e74b14.c15394","type":"mqtt in","z":"2159e868.08f748","name":"Raul presence","topic":"presence_detection/raul","qos":"2","broker":"e67c6dfd.2c6b98","x":170,"y":340,"wires":[["f906dfbd.a19478","4b889642.5ca4f8"]]},{"id":"f906dfbd.a19478","type":"function","z":"2159e868.08f748","name":"Set payload Raul","func":"\nvar datetime = new Date()\n\nglobal.set(\"last_detection_raul\", datetime)\n\nvar last_entrance_raul = global.get(\"last_entrance_raul\") || 0;\nvar threshold = global.get(\"detection_threshold\") || 0;\n\nvar timedif = datetime - last_entrance_raul;\n\nif(timedif > 1.5*threshold) global.set(\"raul_greeted\",false);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":400,"wires":[["e0f78272.3b36f"]]},{"id":"203ef608.48d912","type":"ifttt out","z":"2159e868.08f748","eventName":"cris_left_home","key":"dab75ed.980752","x":1290,"y":700,"wires":[]},{"id":"39a494ba.8b5db4","type":"ui_text","z":"2159e868.08f748","group":"c086012c.2407d8","order":2,"width":0,"height":0,"name":"Last entrance","label":"{{msg.topic}}","format":"{{msg.timestamp}}","layout":"row-spread","x":1300,"y":580,"wires":[]},{"id":"e0f78272.3b36f","type":"function","z":"2159e868.08f748","name":"Check payload Raul","func":"var datetime = new Date()\n\nvar last_detection = global.get(\"last_detection_raul\") || 0;\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\n\nvar time_since_last_detection = datetime - last_detection\nnode.error(time_since_last_detection)\n\nif( time_since_last_detection > detection_threshold )\n{\n    msg.payload = false\n    msg.topic = \"Exit: \"\n    global.set(\"presence_raul\",false)\n}\nelse\n{\n    msg.payload = true\n    msg.topic = \"Came: \"\n    global.set(\"presence_raul\",true)\n}\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":980,"wires":[["1e715a44.ae3406","c7f2a410.f87d98"]]},{"id":"c7f2a410.f87d98","type":"ui_switch","z":"2159e868.08f748","name":"","label":"Raul","tooltip":"","group":"c086012c.2407d8","order":3,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":860,"y":980,"wires":[[]]},{"id":"1e715a44.ae3406","type":"switch","z":"2159e868.08f748","name":"Event at change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":860,"y":920,"wires":[["4cf56a45.3215e4","91026b1a.9357f"]]},{"id":"4cf56a45.3215e4","type":"switch","z":"2159e868.08f748","name":"Decide IN/OUT","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1070,"y":920,"wires":[["3baea57d.279b9a","2cd7df9b.240538","4a73f0eb.a54dc8"],["2cd7df9b.240538","d3a72d5d.144ba8"]]},{"id":"4a73f0eb.a54dc8","type":"ifttt out","z":"2159e868.08f748","eventName":"raul_at_home","key":"59f1345a.5292fc","x":1290,"y":780,"wires":[]},{"id":"d3a72d5d.144ba8","type":"ifttt out","z":"2159e868.08f748","eventName":"raul_left_home","key":"59f1345a.5292fc","x":1290,"y":1040,"wires":[]},{"id":"2cd7df9b.240538","type":"ui_text","z":"2159e868.08f748","group":"c086012c.2407d8","order":4,"width":0,"height":0,"name":"Last entrance","label":"{{msg.topic}}","format":"{{msg.timestamp}}","layout":"row-spread","x":1280,"y":920,"wires":[]},{"id":"3baea57d.279b9a","type":"function","z":"2159e868.08f748","name":"Set greet message Raul","func":"var datetime = new Date()\n\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\nvar entrance_detection_time = global.get(\"entrance_detection_time\") || 0;\n\nvar timedif = datetime - entrance_detection_time\n\nvar raul_greeted = global.get(\"raul_greeted\") || 0;\n\nnode.error(timedif)\n\nvar new_msg = {payload: \"\", greet: false}\n\n\nif((timedif < detection_threshold) && !raul_greeted)\n{\n    new_msg.greet = true;\n    global.set(\"raul_greeted\",true);\n}\n\n\nglobal.set(\"last_entrance_raul\", datetime)\n\nnew_msg.payload = \" -e hello -p raul\"\n\nreturn new_msg;","outputs":1,"noerr":0,"x":1490,"y":820,"wires":[["754dcbb5.b7d90c"]]},{"id":"754dcbb5.b7d90c","type":"switch","z":"2159e868.08f748","name":"Decide to greet","property":"greet","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1730,"y":820,"wires":[["bbd96316.eee1"]]},{"id":"6747c69a.a341b","type":"switch","z":"ebed6492.dd9558","name":"Greet Raul","property":"greet_raul","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":780,"wires":[["cce373dc.a3d11"]]},{"id":"e99de301.15d258","type":"exec","z":"ebed6492.dd9558","command":"xset -display :0 dpms force on","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Activate display","x":680,"y":260,"wires":[[],[],[]]},{"id":"f53b4f52.67e86","type":"debug","z":"ebed6492.dd9558","name":"Entrance detected msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":630,"y":340,"wires":[]},{"id":"5ab38fbc.273dd","type":"switch","z":"2159e868.08f748","name":"Decide to greet","property":"greet","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1730,"y":500,"wires":[["bbd96316.eee1"]]},{"id":"3bd9c0a9.da2f98","type":"function","z":"2159e868.08f748","name":"Set greet message Cris","func":"var datetime = new Date()\n\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\nvar entrance_detection_time = global.get(\"entrance_detection_time\") || 0;\n\nvar cris_greeted = global.get(\"cris_greeted\") || 0;\n\n\nvar timedif = datetime - entrance_detection_time\n\nvar new_msg = {payload: \"\", greet: false}\n\n\nif( (timedif < detection_threshold) && !cris_greeted)\n{\n    new_msg.greet = true;\n    global.set(\"cris_greeted\",true);\n}\n\nglobal.set(\"last_entrance_cris\", datetime)\n\n\nnew_msg.payload = \" -e hello -p cris \"\n\n\nreturn new_msg;","outputs":1,"noerr":0,"x":1510,"y":500,"wires":[["5ab38fbc.273dd"]]},{"id":"c398ba15.9f2f2","type":"inject","z":"474b74d5.8d1c2c","name":"Periodical trigger","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":true,"onceDelay":"1","x":130,"y":520,"wires":[["3e3075e8.5acb3a"]]},{"id":"1ada0611.9932ea","type":"function","z":"474b74d5.8d1c2c","name":"Set flow temperature variable","func":"\nflow.set(\"current_temperature\", msg.payload)\n\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":40,"wires":[[]]},{"id":"20a2754e.2bab2a","type":"debug","z":"117ae75e.a5f4b9","name":"Livingroom: humidity msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":610,"y":340,"wires":[]},{"id":"d5417207.7c2a7","type":"function","z":"ebed6492.dd9558","name":"Generate lamp message","func":"var lamp_network_state = global.get(\"lamp_network_state\") || 0;\nvar mask = global.get(\"lamp_network_mask\") || 0;\n\nif(mask == 0) mask = 255;\nif(lamp_network_state == 0) lamp_network_state = 1;\n\nmsg = {payload:\n  {\n    mode:lamp_network_state,\n    id_mask:mask\n  }}\n\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":560,"wires":[["6f6f40ba.9ef69"]]},{"id":"b9b7d351.746f1","type":"mqtt in","z":"474b74d5.8d1c2c","name":"Door status","topic":"attic_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":140,"y":1080,"wires":[["389fa415.2c9c14","7f2524e0.3ee86c","80fc9511.8371b8"]]},{"id":"7f2524e0.3ee86c","type":"switch","z":"474b74d5.8d1c2c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":900,"wires":[["f0e68611.aada","69302bb7.907d8c","3a1c218c.52f42e"],["f291f4b3.18162","eb238879.60d558","c7369d51.a54bc8"]]},{"id":"f0e68611.aada","type":"function","z":"474b74d5.8d1c2c","name":"Get light amount","func":"\nmsg.payload = flow.get(\"light_amount_attic\") || 0;\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":800,"wires":[["a83c212e.c3bfb","a1ebe83e.9fa508"]]},{"id":"a1ebe83e.9fa508","type":"debug","z":"474b74d5.8d1c2c","name":"Computed payload: light amount","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1320,"y":780,"wires":[]},{"id":"a83c212e.c3bfb","type":"switch","z":"474b74d5.8d1c2c","name":"Switch lights ON","property":"payload","propertyType":"msg","rules":[{"t":"lt","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1220,"y":840,"wires":[["4163d10d.3ccf9"]]},{"id":"389fa415.2c9c14","type":"function","z":"474b74d5.8d1c2c","name":"Set payload","func":"\n\nif(msg.payload == \"1\") msg.payload = \"CLOSED\"\nelse if(msg.payload == \"0\") msg.payload = \"OPEN\"\nelse msg.payload = \"ERROR\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":1300,"wires":[[]]},{"id":"80fc9511.8371b8","type":"debug","z":"474b74d5.8d1c2c","name":"Door status","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":310,"y":1360,"wires":[]},{"id":"40cde5b6.6afc2c","type":"mqtt in","z":"474b74d5.8d1c2c","name":"Light amount","topic":"attic_node/light","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":1800,"wires":[["9d36233a.e5b7d8"]]},{"id":"9d36233a.e5b7d8","type":"json","z":"474b74d5.8d1c2c","name":"Json converter","property":"payload","action":"","pretty":false,"x":380,"y":1800,"wires":[["e9086c.e03b8f98","3ac98cc6.48cac4","6b42f25a.ef459c","92ffcb25.dd0258"]]},{"id":"3ac98cc6.48cac4","type":"ui_gauge","z":"474b74d5.8d1c2c","name":"Light amount","group":"f933085d.8cad7","order":1,"width":"4","height":"3","gtype":"wave","title":"Light","label":"Lx","format":"{{value}}","min":0,"max":"100","colors":["#50b500","#e6df00","#ca3838"],"seg1":"","seg2":"","x":630,"y":1800,"wires":[]},{"id":"e9086c.e03b8f98","type":"debug","z":"474b74d5.8d1c2c","name":"Received msg: light amount","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":660,"y":1700,"wires":[]},{"id":"6b42f25a.ef459c","type":"function","z":"474b74d5.8d1c2c","name":"Set light amount ","func":"\nflow.set(\"light_amount_attic\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":2000,"wires":[[]]},{"id":"672ff9fc.aedb88","type":"inject","z":"ebed6492.dd9558","name":"Triger once at start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":210,"y":60,"wires":[["497dbc37.43a664","420e4ed9.762a"]]},{"id":"497dbc37.43a664","type":"function","z":"ebed6492.dd9558","name":"Set initial values","func":"\nglobal.set(\"entrance_detection_time\",0);\n\nflow.set(\"long_time_open_published\",false);\nflow.set(\"open_time\",0);\nflow.set(\"threshold_open_time\",300000);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":60,"wires":[[]]},{"id":"420e4ed9.762a","type":"exec","z":"ebed6492.dd9558","command":"/home/pi/Projects/configure_wakeup.sh","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"Setup display","x":450,"y":140,"wires":[[],[],[]]},{"id":"6cf44f39.ae3cb","type":"mqtt in","z":"ebed6492.dd9558","name":"Door status","topic":"entrance_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":130,"y":1300,"wires":[["6c46fc6e.0263d4","c769c234.0c9c8"]]},{"id":"c769c234.0c9c8","type":"function","z":"ebed6492.dd9558","name":"Set door status","func":"\nif(msg.payload == \"1\")\n{\n    var datetime = new Date();\n    flow.set(\"door_open\",true)\n    flow.set(\"open_time\", datetime)\n    flow.set(\"long_time_open_published\",false)\n}\nelse\n{\n    flow.set(\"door_open\",false)\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":1300,"wires":[[]]},{"id":"6c46fc6e.0263d4","type":"debug","z":"ebed6492.dd9558","name":"Door status msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":340,"y":1380,"wires":[]},{"id":"cce373dc.a3d11","type":"function","z":"ebed6492.dd9558","name":"Create greet command Raul","func":"\nmsg.payload = \" -e hello -p raul\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":780,"wires":[["b40c7bfe.d1b458"]]},{"id":"68a6b468.0c3afc","type":"mqtt in","z":"ebed6492.dd9558","name":"Pressure detected","topic":"entrance_node/pressure_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":150,"y":1480,"wires":[["f66468fa.103f2"]]},{"id":"f66468fa.103f2","type":"debug","z":"ebed6492.dd9558","name":"Pressure detected msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":410,"y":1480,"wires":[]},{"id":"c1efedcc.2e5b2","type":"switch","z":"ebed6492.dd9558","name":"Greet Cris","property":"greet_cris","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":740,"y":900,"wires":[["b68eff01.757ce8"]]},{"id":"b68eff01.757ce8","type":"function","z":"ebed6492.dd9558","name":"Create greet command Cris","func":"\nmsg.payload = \" -e hello -p cris\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":900,"wires":[["b40c7bfe.d1b458"]]},{"id":"6c35e958.3fd8f","type":"function","z":"ebed6492.dd9558","name":"Check presence status","func":"var datetime = new Date();\n\nvar presence_raul = global.get(\"presence_raul\") || 0;\nvar presence_cris = global.get(\"presence_cris\") || 0;\nvar presence_guest = global.get(\"presence_guest\") || 0;\n\nvar presence_count = 0;\nif(presence_raul) presence_count++;\nif(presence_cris) presence_count++;\nif(presence_guest) presence_count++;\n\nvar new_msg = {payload: \"\", farewell_type: \"GENERIC\"}\n\nif(presence_count > 1)\n{\n    new_msg.farewell_type = \"GENERIC\"\n}\n\nelse if(presence_raul)\n{\n    new_msg.farewell_type = \"RAUL\"\n}\n\nelse if(presence_cris)\n{\n    new_msg.farewell_type = \"CRIS\"\n}\n\nelse if (presence_guest)\n{\n    new_msg.farewell_type = \"GUEST\"\n}\n\n\nreturn new_msg;","outputs":1,"noerr":0,"x":540,"y":1040,"wires":[["401b534e.7af5a4","4053ffa2.6d4c78"]]},{"id":"401b534e.7af5a4","type":"switch","z":"ebed6492.dd9558","name":"Select farewell type","property":"farewell_type","propertyType":"msg","rules":[{"t":"eq","v":"GENERIC","vt":"str"},{"t":"eq","v":"CRIS","vt":"str"},{"t":"eq","v":"RAUL","vt":"str"},{"t":"eq","v":"GUEST","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":770,"y":1040,"wires":[["777b6dd9.0192cc"],["120f8e62.a6f0da"],["9e2b0674.9d7718"],["c0825a6e.c66b78"]]},{"id":"777b6dd9.0192cc","type":"function","z":"ebed6492.dd9558","name":"Create goodbye command generic","func":"\nmsg.payload = \" -e goodbye -p generic\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":980,"wires":[["b40c7bfe.d1b458"]]},{"id":"120f8e62.a6f0da","type":"function","z":"ebed6492.dd9558","name":"Create goodbye command Cris","func":"\nmsg.payload = \" -e goodbye -p cris\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":1040,"wires":[["b40c7bfe.d1b458"]]},{"id":"9e2b0674.9d7718","type":"function","z":"ebed6492.dd9558","name":"Create goodbye command Raul","func":"\nmsg.payload = \" -e goodbye -p raul\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":1100,"wires":[["b40c7bfe.d1b458"]]},{"id":"d1abd7bb.a7ff78","type":"mqtt in","z":"2159e868.08f748","name":"Entrance detected","topic":"entrance_node/entrance_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":160,"y":1800,"wires":[[]]},{"id":"4053ffa2.6d4c78","type":"debug","z":"ebed6492.dd9558","name":"Exit detected msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":750,"y":1220,"wires":[]},{"id":"2bbb5601.618a22","type":"switch","z":"ebed6492.dd9558","name":"Greet Generic","property":"greet_generic","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":760,"y":620,"wires":[["4727fe80.14bbe"]]},{"id":"4727fe80.14bbe","type":"function","z":"ebed6492.dd9558","name":"Create greet command Generic","func":"\nmsg.payload = \" -e hello -p generic\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":620,"wires":[["b40c7bfe.d1b458"]]},{"id":"70da5525.02f034","type":"exec","z":"2159e868.08f748","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2350,"y":680,"wires":[[],[],[]]},{"id":"69302bb7.907d8c","type":"function","z":"474b74d5.8d1c2c","name":"Create attic open command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_door_open.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":860,"wires":[["7ff6be95.7783e"]]},{"id":"f291f4b3.18162","type":"function","z":"474b74d5.8d1c2c","name":"Create attic closed command","func":"\n\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_door_closed.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":980,"wires":[["7ff6be95.7783e"]]},{"id":"ed44b118.d7267","type":"exec","z":"474b74d5.8d1c2c","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2000,"y":1060,"wires":[["be9d1b2.13b05e8"],["be9d1b2.13b05e8"],["be9d1b2.13b05e8"]]},{"id":"80e98b96.f73bd8","type":"function","z":"474b74d5.8d1c2c","name":"Create attic light command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_light_on.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1630,"y":920,"wires":[["d850db0c.cc99f8"]]},{"id":"92ffcb25.dd0258","type":"ui_chart","z":"474b74d5.8d1c2c","name":"Light  graph","group":"fb91ed0a.105588","order":2,"width":"12","height":"6","label":"Light chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"1000","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":630,"y":1900,"wires":[[],[]]},{"id":"3a1c218c.52f42e","type":"function","z":"474b74d5.8d1c2c","name":"Create attic temperature command","func":"var temperature = flow.get(\"current_temperature\") || 0;;\n\n\n\nmsg.payload = \" -t \\\"La temperatura del Ã¡tico es de \"\nmsg.payload += temperature\nmsg.payload += \" grados \\\"\"\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":920,"wires":[["d850db0c.cc99f8"]]},{"id":"72cecc3e.3a0064","type":"debug","z":"c7dd94f4.6cfe98","name":"Bedroom: temperature msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":560,"y":380,"wires":[]},{"id":"65139ae.995c664","type":"ui_gauge","z":"c7dd94f4.6cfe98","name":"Temperature","group":"c4f8e805.745818","order":1,"width":"4","height":"3","gtype":"gage","title":"Temperature","label":"ÂºC","format":"{{value}}","min":"6","max":"30","colors":["#50b500","#e6df00","#ca3838"],"seg1":"","seg2":"","x":510,"y":460,"wires":[]},{"id":"14d34504.a29f8b","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Temperature","topic":"bedroom_node/temperature","qos":"2","broker":"e67c6dfd.2c6b98","x":130,"y":460,"wires":[["65139ae.995c664","2e38c87a.474258","72cecc3e.3a0064"]]},{"id":"2e38c87a.474258","type":"ui_chart","z":"c7dd94f4.6cfe98","name":"Temperature graph","group":"de3873be.99eeb","order":2,"width":"12","height":"6","label":"Temperature chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"6","ymax":"30","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":530,"y":540,"wires":[[],[]]},{"id":"70911ecd.686ce","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Humidity","topic":"bedroom_node/humidity","qos":"2","broker":"e67c6dfd.2c6b98","x":120,"y":680,"wires":[["8108336e.09982","6d2926b7.23ca58"]]},{"id":"8108336e.09982","type":"ui_chart","z":"c7dd94f4.6cfe98","name":"Humidity graph","group":"de3873be.99eeb","order":2,"width":"12","height":"6","label":"Humidity chart","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"100","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":520,"y":760,"wires":[[],[]]},{"id":"6d2926b7.23ca58","type":"debug","z":"c7dd94f4.6cfe98","name":"Bedroom: humidity msg","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":550,"y":620,"wires":[]},{"id":"e83e3202.f1107","type":"ui_switch","z":"c7dd94f4.6cfe98","name":"Alarm clock","label":"Alarm enabled","tooltip":"","group":"6ab69360.278fbc","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":1210,"y":940,"wires":[["fe368086.0abdd"]]},{"id":"fe368086.0abdd","type":"function","z":"c7dd94f4.6cfe98","name":"Set payload","func":"flow.set(\"alarm_on\", msg.payload)\n\nif(msg.payload == 1) flow.set(\"alarm_triggered\",false)\n\nreturn msg;","outputs":1,"noerr":0,"x":1410,"y":940,"wires":[[]]},{"id":"6219b92e.37e468","type":"ui_text","z":"c7dd94f4.6cfe98","group":"6ab69360.278fbc","order":3,"width":0,"height":0,"name":"","label":"Alarm time","format":"{{msg.payload}}","layout":"row-spread","x":710,"y":1080,"wires":[]},{"id":"c80eea27.861628","type":"function","z":"c7dd94f4.6cfe98","name":"Set target time","func":"\nvar hours = flow.get(\"alarm_hour\") || 0;\nvar minutes = flow.get(\"alarm_minute\") || 0;\n\nvar total_time = \"\"\nif(hours < 10) total_time += \"0\"\ntotal_time += hours\ntotal_time += \":\"\nif(minutes < 10) total_time += \"0\"\ntotal_time += minutes\n\nmsg.payload = total_time\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":1080,"wires":[["6219b92e.37e468"]]},{"id":"b5387a3e.a9bf98","type":"ui_slider","z":"c7dd94f4.6cfe98","name":"","label":"Hour","tooltip":"","group":"6ab69360.278fbc","order":3,"width":0,"height":0,"passthru":false,"outs":"end","topic":"","min":0,"max":"23","step":1,"x":110,"y":1040,"wires":[["b90ed98f.c9d7b8"]]},{"id":"31dcd95d.4db386","type":"ui_slider","z":"c7dd94f4.6cfe98","name":"","label":"Minutes","tooltip":"","group":"6ab69360.278fbc","order":3,"width":0,"height":0,"passthru":false,"outs":"end","topic":"minutes","min":0,"max":"59","step":1,"x":120,"y":1100,"wires":[["cb69a2fa.4ba22"]]},{"id":"b90ed98f.c9d7b8","type":"function","z":"c7dd94f4.6cfe98","name":"Set payload","func":"\n\nflow.set(\"alarm_hour\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":1040,"wires":[["c80eea27.861628"]]},{"id":"cb69a2fa.4ba22","type":"function","z":"c7dd94f4.6cfe98","name":"Set payload","func":"\nflow.set(\"alarm_minute\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":1100,"wires":[["c80eea27.861628"]]},{"id":"c1434509.364b3","type":"function","z":"c7dd94f4.6cfe98","name":"Color","func":"\nmsg = {payload:\n      {\n        r:255,\n        g:170,\n        b:20\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":1600,"wires":[["6d5274c7.9ce2ac","7bda9d94.449c94","d93064ed.ce5c68"]]},{"id":"6d5274c7.9ce2ac","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp color request","topic":"bedroom_node/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":890,"y":1600,"wires":[]},{"id":"269796cc.d3a52a","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":300,"y":1620,"wires":[["ac40773.7341708"]]},{"id":"fe74ff20.ab6388","type":"function","z":"c7dd94f4.6cfe98","name":"Set ON","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1400,"wires":[["fa9c48ff.e5a18","3062801b.e941f8"]]},{"id":"fa9c48ff.e5a18","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp state request","topic":"bedroom_node/light_state","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":570,"y":1400,"wires":[]},{"id":"c1a18880.bf2978","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp intensity request","topic":"bedroom_node/light_intensity","qos":"0","retain":"","broker":"e67c6dfd.2c6b98","x":580,"y":1460,"wires":[]},{"id":"ac40773.7341708","type":"function","z":"c7dd94f4.6cfe98","name":"Dim","func":"\nmsg = {payload:\n      {\n        req:-1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":1680,"wires":[["c1a18880.bf2978","2db8b74a.3895d"]]},{"id":"7bda9d94.449c94","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":1660,"wires":[["cbff9a4f.df20f"]]},{"id":"cbff9a4f.df20f","type":"function","z":"c7dd94f4.6cfe98","name":"Color","func":"\nmsg = {payload:\n      {\n        r:255,\n        g:70,\n        b:20\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":1720,"wires":[["9afd62fb.fe0b5","6d5274c7.9ce2ac"]]},{"id":"9afd62fb.fe0b5","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":1780,"wires":[["c15d7dad.5ffbb8"]]},{"id":"c15d7dad.5ffbb8","type":"function","z":"c7dd94f4.6cfe98","name":"Color","func":"\nmsg = {payload:\n      {\n        r:255,\n        g:60,\n        b:20\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":1840,"wires":[["ae32d180.57d168","6d5274c7.9ce2ac"]]},{"id":"ae32d180.57d168","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":1900,"wires":[["e9bafd13.6bd1"]]},{"id":"e9bafd13.6bd1","type":"function","z":"c7dd94f4.6cfe98","name":"Intensity","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":1960,"wires":[["c36b5d92.b58228","3b36e29e.376af6"]]},{"id":"c36b5d92.b58228","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":2020,"wires":[["255020fd.f95a5"]]},{"id":"255020fd.f95a5","type":"function","z":"c7dd94f4.6cfe98","name":"Color","func":"\nmsg = {payload:\n      {\n        r:255,\n        g:70,\n        b:20\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":2080,"wires":[["6e17ca13.1ac8e4","6d5274c7.9ce2ac"]]},{"id":"6e17ca13.1ac8e4","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":2140,"wires":[["cbc63f30.4699c"]]},{"id":"cbc63f30.4699c","type":"function","z":"c7dd94f4.6cfe98","name":"Intensity","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":2200,"wires":[["65842b5e.128f6c","3b36e29e.376af6"]]},{"id":"65842b5e.128f6c","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":2260,"wires":[["30943ee.9c09942"]]},{"id":"30943ee.9c09942","type":"function","z":"c7dd94f4.6cfe98","name":"Intensity","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":2320,"wires":[["edf5ad17.20a34","3b36e29e.376af6"]]},{"id":"edf5ad17.20a34","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":2380,"wires":[["a5abf177.c541f"]]},{"id":"183de458.0f07e4","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":1540,"wires":[["c1434509.364b3"]]},{"id":"3b36e29e.376af6","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp intensity request","topic":"bedroom_node/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":900,"y":1720,"wires":[]},{"id":"be9d1b2.13b05e8","type":"debug","z":"474b74d5.8d1c2c","name":"Audio node output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2420,"y":1060,"wires":[]},{"id":"7ff6be95.7783e","type":"delay","z":"474b74d5.8d1c2c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1270,"y":1060,"wires":[["d850db0c.cc99f8"]]},{"id":"52160879.c1c838","type":"function","z":"c7dd94f4.6cfe98","name":"Check alarm due","func":"var datetime = new Date()\n\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\n\nvar target_hour = flow.get(\"alarm_hour\") || 0;\nvar target_minute = flow.get(\"alarm_minute\") || 0;\n\nvar alarm_on = flow.get(\"alarm_on\") || 0;\n\nvar alarm_triggered = flow.get(\"alarm_triggered\") || 0;\n\nnode.error(target_minute)\nnode.error(minutes)\n\nmsg.payload = 0\n\nif(alarm_on && !alarm_triggered)\n{\n    if(target_hour == hours)\n    {\n        if(Math.abs(target_minute - minutes) < 2)\n        {\n            msg.payload = 1\n            flow.set(\"alarm_triggered\",true)\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":1220,"wires":[["d3598b98.aa6768","b90a3bb.b58cdc8"]]},{"id":"a5abf177.c541f","type":"function","z":"c7dd94f4.6cfe98","name":"Intensity","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":2440,"wires":[["3b36e29e.376af6","d93064ed.ce5c68","515c6b6c.d65454"]]},{"id":"89b327e.dcd6bd8","type":"inject","z":"c7dd94f4.6cfe98","name":"Periodical trigger","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":"1","x":130,"y":1220,"wires":[["52160879.c1c838"]]},{"id":"d3598b98.aa6768","type":"switch","z":"c7dd94f4.6cfe98","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":340,"y":1320,"wires":[["fe74ff20.ab6388"]]},{"id":"69e31b6e.0ac0b4","type":"exec","z":"c7dd94f4.6cfe98","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1530,"y":1840,"wires":[[],[],[]]},{"id":"b90a3bb.b58cdc8","type":"debug","z":"c7dd94f4.6cfe98","name":"Bedroom: alarm due check","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":660,"y":1220,"wires":[]},{"id":"d93064ed.ce5c68","type":"function","z":"c7dd94f4.6cfe98","name":"Create greet command Wakeup","func":"\nmsg.payload = \" -e wakeup -p generic\"\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":1840,"wires":[["f5dd49d1.644bf8"]]},{"id":"2db8b74a.3895d","type":"counter-loop","z":"c7dd94f4.6cfe98","name":"Wakeup loop","counter":"wakeup_loop","counterType":"flow","initial":0,"initialType":"num","operator":"lt","termination":"5","terminationType":"num","increment":1,"incrementType":"num","x":310,"y":1540,"wires":[["183de458.0f07e4"],["269796cc.d3a52a"]]},{"id":"515c6b6c.d65454","type":"function","z":"c7dd94f4.6cfe98","name":"Disable alarm","func":"\nmsg.payload = 0;\nflow.set(\"wakeup_loop\",null);\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":940,"wires":[["e83e3202.f1107"]]},{"id":"3062801b.e941f8","type":"function","z":"c7dd94f4.6cfe98","name":"Disable alarm","func":"\nmsg.payload = 0;\nflow.set(\"wakeup_loop\",null);\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1480,"wires":[["2db8b74a.3895d"]]},{"id":"66301bf4.a20ba4","type":"mqtt in","z":"ebed6492.dd9558","name":"Exit detected","topic":"entrance_node/exit_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":130,"y":1040,"wires":[["4cdfe2b6.b8d17c"]]},{"id":"4cdfe2b6.b8d17c","type":"delay","z":"ebed6492.dd9558","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":330,"y":1040,"wires":[["6c35e958.3fd8f"]]},{"id":"9a53b1e5.4ad4e","type":"ui_text","z":"474b74d5.8d1c2c","group":"cb4cc6fb.fdeeb8","order":3,"width":0,"height":0,"name":"","label":"Heating starts at","format":"{{msg.payload}}","layout":"row-spread","x":810,"y":2180,"wires":[]},{"id":"86197d06.7ae438","type":"function","z":"474b74d5.8d1c2c","name":"Set target time","func":"\nvar hours = flow.get(\"heating_start_hour\") || 0;\nvar minutes = flow.get(\"heating_start_minute\") || 0;\n\nvar total_time = \"\"\nif(hours < 10) total_time += \"0\"\ntotal_time += hours\ntotal_time += \":\"\nif(minutes < 10) total_time += \"0\"\ntotal_time += minutes\n\nmsg.payload = total_time\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":2180,"wires":[["9a53b1e5.4ad4e"]]},{"id":"f68354e1.0c4cd","type":"ui_slider","z":"474b74d5.8d1c2c","name":"","label":"Hour","tooltip":"","group":"cb4cc6fb.fdeeb8","order":3,"width":0,"height":0,"passthru":false,"outs":"end","topic":"","min":0,"max":"24","step":1,"x":200,"y":2140,"wires":[["6089fae3.02d01c"]]},{"id":"ea9b6c68.f42d38","type":"ui_slider","z":"474b74d5.8d1c2c","name":"","label":"Minutes","tooltip":"","group":"cb4cc6fb.fdeeb8","order":3,"width":0,"height":0,"passthru":false,"outs":"end","topic":"minutes","min":0,"max":"60","step":1,"x":210,"y":2200,"wires":[["ab1d2d85.9a1aa8"]]},{"id":"6089fae3.02d01c","type":"function","z":"474b74d5.8d1c2c","name":"Set payload","func":"\n\nflow.set(\"heating_start_hour\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":2140,"wires":[["86197d06.7ae438"]]},{"id":"ab1d2d85.9a1aa8","type":"function","z":"474b74d5.8d1c2c","name":"Set payload","func":"\nflow.set(\"heating_start_minute\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":2200,"wires":[["86197d06.7ae438"]]},{"id":"17daefb2.179eb","type":"ui_switch","z":"474b74d5.8d1c2c","name":"","label":"Heating system","tooltip":"","group":"a6f19742.9f9e28","order":3,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":540,"y":2520,"wires":[["594bc926.204e48"]]},{"id":"1a763ac8.87355d","type":"ui_slider","z":"474b74d5.8d1c2c","name":"","label":"Temp","tooltip":"","group":"a6f19742.9f9e28","order":3,"width":0,"height":0,"passthru":false,"outs":"end","topic":"","min":0,"max":"30","step":1,"x":210,"y":2860,"wires":[["64d31ad6.11c7a4"]]},{"id":"594bc926.204e48","type":"function","z":"474b74d5.8d1c2c","name":"Set heating ","func":"\nglobal.set(\"attic_heating\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":2520,"wires":[[]]},{"id":"64d31ad6.11c7a4","type":"function","z":"474b74d5.8d1c2c","name":"Set target temperature","func":"\nflow.set(\"target_temperature\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":2860,"wires":[["ba242a26.c46af"]]},{"id":"ba242a26.c46af","type":"ui_text","z":"474b74d5.8d1c2c","group":"a6f19742.9f9e28","order":3,"width":0,"height":0,"name":"Target temperature","label":"Target temperature: ","format":"{{msg.payload}}","layout":"row-right","x":730,"y":2860,"wires":[]},{"id":"b743c847.594e48","type":"ui_switch","z":"474b74d5.8d1c2c","name":"Enable program","label":"Enable program","tooltip":"","group":"cb4cc6fb.fdeeb8","order":3,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":540,"y":2460,"wires":[["b3f7be57.3b3998"]]},{"id":"b3f7be57.3b3998","type":"function","z":"474b74d5.8d1c2c","name":"Set program","func":"\nflow.set(\"program\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":2460,"wires":[[]]},{"id":"c347e012.47f81","type":"mqtt in","z":"b5887534.3c6f4","name":"Balcony door","topic":"livingroom_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":230,"y":120,"wires":[["35482719.1eb4f","f9c10cce.a70818"]]},{"id":"35482719.1eb4f","type":"function","z":"b5887534.3c6f4","name":"Set balcony_door_open","func":"\nif(msg.payload == \"1\")\n{\n    flow.set(\"balcony_door_open\", true)\n    var datetime = new Date();\n    flow.set(\"last_balcony_open\", datetime)\n    flow.set(\"long_time_open_published\", false)\n}\nelse \n{\n    flow.set(\"balcony_door_open\", false)\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":120,"wires":[[]]},{"id":"c3886d9a.46a2d","type":"inject","z":"b5887534.3c6f4","name":"Once at start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":230,"y":340,"wires":[["967416b7.0c1b68"]]},{"id":"967416b7.0c1b68","type":"function","z":"b5887534.3c6f4","name":"Set balcony_door_open initial","func":"\nvar datetime = new Date();\n\nflow.set(\"balcony_door_open\", false)\nflow.set(\"balcony_open_threshold\", 300000)\nflow.set(\"last_balcony_open\", datetime)\nflow.set(\"balcony_open_advertised\", false)\n\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":340,"wires":[[]]},{"id":"f9c10cce.a70818","type":"function","z":"b5887534.3c6f4","name":"Create balcony open/closed command","func":"\n\nif(msg.payload == \"1\")\n{\n    msg.payload = \" -f /home/pi/Projects/audio_node/sounds/balcony_door_open.mp3\"\n}\nelse\n{\n    msg.payload = \" -f /home/pi/Projects/audio_node/sounds/balcony_door_closed.mp3\"\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":220,"wires":[["8e994503.0a1b08"]]},{"id":"cf2450e9.e5b3f8","type":"exec","z":"b5887534.3c6f4","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1810,"y":520,"wires":[[],[],[]]},{"id":"7840007b.9fc5b","type":"openweathermap in","z":"b5887534.3c6f4","name":"Weather","wtype":"forecast","lon":"9.117092","lat":"48.814441","city":"","country":"","language":"en","x":260,"y":560,"wires":[["99be305a.0b765","27eab929.3addb6"]]},{"id":"99be305a.0b765","type":"debug","z":"b5887534.3c6f4","name":"Current weather","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":480,"y":520,"wires":[]},{"id":"ea9ccec.bc125b","type":"inject","z":"474b74d5.8d1c2c","name":"Periodical trigger","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":"1","x":250,"y":2620,"wires":[["12bb878a.a726d"]]},{"id":"12bb878a.a726d","type":"function","z":"474b74d5.8d1c2c","name":"Check heating due","func":"var datetime = new Date()\n\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\n\nvar target_hour = flow.get(\"heating_start_hour\") || 0;\nvar target_minute = flow.get(\"heating_start_minute\") || 0;\n\nvar program = flow.get(\"program\") || 0;\nvar heating_started = global.get(\"attic_heating\") || 0;\n\nmsg.payload = false\n\nif(program && !heating_started)\n{\n    if(target_hour == hours)\n    {\n        if(Math.abs(target_minute - minutes) < 2)\n        {\n            msg.payload = true\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":2620,"wires":[["58982be2.b7ac1c","2e31f896.b4bfd"]]},{"id":"58982be2.b7ac1c","type":"debug","z":"474b74d5.8d1c2c","name":"Bedroom: alarm due check","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":810,"y":2680,"wires":[]},{"id":"2e31f896.b4bfd","type":"switch","z":"474b74d5.8d1c2c","name":"Check heating due","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":260,"y":2520,"wires":[["17daefb2.179eb"]]},{"id":"563bfd10.79e274","type":"debug","z":"474b74d5.8d1c2c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":580,"y":620,"wires":[]},{"id":"daa475e4.0ed7b8","type":"delay","z":"ebed6492.dd9558","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":620,"wires":[["9ec1170f.11f26"]]},{"id":"4163d10d.3ccf9","type":"delay","z":"474b74d5.8d1c2c","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1430,"y":840,"wires":[["80e98b96.f73bd8","bf4fc66c.82be"]]},{"id":"9d7dc7b4.41cf48","type":"inject","z":"ebed6492.dd9558","name":"Check every minute","topic":"","payload":"","payloadType":"date","repeat":"360","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1600,"wires":[["5b49e9c.2a0ad18"]]},{"id":"5b49e9c.2a0ad18","type":"function","z":"ebed6492.dd9558","name":"Check door status","func":"\nvar door_open = flow.get(\"door_open\") || 0;\nvar long_time_open_published = flow.get(\"long_time_open_published\") || 0;\nvar long_time_open_detection = flow.get(\"long_time_open_detection\") || 0;\n\nmsg.payload = false\n\nif(long_time_open_detection && door_open && !long_time_open_published)\n{\n    var open_time = flow.get(\"open_time\") || 0;\n    var datetime = new Date()\n    var timedif = Math.abs(datetime - open_time);\n    var threshold = flow.get(\"threshold_open_time\") || 0;\n\n    if(timedif > threshold)\n    {\n        msg.payload = true\n        flow.set(\"long_time_open_published\",true)\n    }\n    \n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":1600,"wires":[["48324486.068e0c"]]},{"id":"48324486.068e0c","type":"switch","z":"ebed6492.dd9558","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":1600,"wires":[["1d499007.1dddb","e8cd57c0.3a3ce8"]]},{"id":"1d499007.1dddb","type":"function","z":"ebed6492.dd9558","name":"Create long time open command","func":"\nmsg.payload = \" -t \\\"La puerta de casa lleva mucho tiempo abierta\\\"\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":1600,"wires":[["b40c7bfe.d1b458"]]},{"id":"fbda6fa0.4a3bb","type":"ui_switch","z":"ebed6492.dd9558","name":"Entrance long time open detection","label":"Entrance long time open detection","tooltip":"","group":"5db64310.9cdc4c","order":0,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":200,"y":1680,"wires":[["286364bc.81cfdc"]]},{"id":"286364bc.81cfdc","type":"function","z":"ebed6492.dd9558","name":"Set door open detection","func":"\nflow.set(\"long_time_open_detection\",msg.payload);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":1680,"wires":[[]]},{"id":"e8cd57c0.3a3ce8","type":"ifttt out","z":"ebed6492.dd9558","eventName":"entrance_long_time_open","key":"dab75ed.980752","x":930,"y":1660,"wires":[]},{"id":"b440c46e.1e47b8","type":"ui_switch","z":"8874c4d3.200988","name":"Silent mode","label":"Silent mode (no audio notifications)","tooltip":"","group":"d5304c8f.46869","order":1,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":490,"y":680,"wires":[["70df8137.a2171"]]},{"id":"70df8137.a2171","type":"function","z":"8874c4d3.200988","name":"Set silent mode","func":"\nif(msg.payload == 1) global.set(\"silent_mode\", true)\nelse global.set(\"silent_mode\", false)\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":680,"wires":[[]]},{"id":"d850db0c.cc99f8","type":"switch","z":"474b74d5.8d1c2c","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1680,"y":1060,"wires":[["ed44b118.d7267"]]},{"id":"3d6ac3b8.67fe9c","type":"ui_text","z":"8874c4d3.200988","group":"d5304c8f.46869","order":6,"width":0,"height":0,"name":"","label":"Start time","format":"{{msg.payload}}","layout":"row-spread","x":760,"y":160,"wires":[]},{"id":"3127e266.1ad69e","type":"function","z":"8874c4d3.200988","name":"Set target time","func":"\nvar hours = flow.get(\"silent_mode_start_hour\") || 0;\nvar minutes = flow.get(\"silent_mode_start_minute\") || 0;\n\nvar total_time = \"\"\nif(hours < 10) total_time += \"0\"\ntotal_time += hours\ntotal_time += \":\"\nif(minutes < 10) total_time += \"0\"\ntotal_time += minutes\n\nmsg.payload = total_time\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":160,"wires":[["3d6ac3b8.67fe9c"]]},{"id":"2a8cee4e.590672","type":"ui_slider","z":"8874c4d3.200988","name":"","label":"Hour","tooltip":"","group":"d5304c8f.46869","order":4,"width":0,"height":0,"passthru":false,"outs":"end","topic":"","min":0,"max":"23","step":1,"x":170,"y":120,"wires":[["29e77503.4548ea"]]},{"id":"825c5734.6c5128","type":"ui_slider","z":"8874c4d3.200988","name":"","label":"Minutes","tooltip":"","group":"d5304c8f.46869","order":5,"width":0,"height":0,"passthru":false,"outs":"end","topic":"minutes","min":0,"max":"59","step":1,"x":180,"y":180,"wires":[["b8b96e26.4b7a1"]]},{"id":"29e77503.4548ea","type":"function","z":"8874c4d3.200988","name":"Set start hour","func":"\n\nflow.set(\"silent_mode_start_hour\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":120,"wires":[["3127e266.1ad69e"]]},{"id":"b8b96e26.4b7a1","type":"function","z":"8874c4d3.200988","name":"Set start minute","func":"\nflow.set(\"silent_mode_start_minute\", msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":180,"wires":[["3127e266.1ad69e"]]},{"id":"33ac8afb.89fe16","type":"ui_text","z":"8874c4d3.200988","group":"d5304c8f.46869","order":3,"width":0,"height":0,"name":"","label":"Silent mode start time","format":"","layout":"row-spread","x":220,"y":60,"wires":[]},{"id":"d8f3bfc5.bc729","type":"ui_text","z":"8874c4d3.200988","group":"d5304c8f.46869","order":10,"width":0,"height":0,"name":"","label":"End time","format":"{{msg.payload}}","layout":"row-spread","x":760,"y":360,"wires":[]},{"id":"bd814b70.54caf8","type":"function","z":"8874c4d3.200988","name":"Set target time","func":"\nvar hours = flow.get(\"silent_mode_end_hour\") || 0;\nvar minutes = flow.get(\"silent_mode_end_minute\") || 0;\n\nvar total_time = \"\"\nif(hours < 10) total_time += \"0\"\ntotal_time += hours\ntotal_time += \":\"\nif(minutes < 10) total_time += \"0\"\ntotal_time += minutes\n\nmsg.payload = total_time\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":360,"wires":[["d8f3bfc5.bc729"]]},{"id":"359132a2.9257ce","type":"ui_slider","z":"8874c4d3.200988","name":"","label":"Hour","tooltip":"","group":"d5304c8f.46869","order":8,"width":0,"height":0,"passthru":false,"outs":"end","topic":"","min":0,"max":"23","step":1,"x":170,"y":320,"wires":[["18d8e3f3.f6b6bc"]]},{"id":"8f947c0f.78ef3","type":"ui_slider","z":"8874c4d3.200988","name":"","label":"Minutes","tooltip":"","group":"d5304c8f.46869","order":9,"width":0,"height":0,"passthru":false,"outs":"end","topic":"minutes","min":0,"max":"59","step":1,"x":180,"y":380,"wires":[["bcebcf2a.43082"]]},{"id":"18d8e3f3.f6b6bc","type":"function","z":"8874c4d3.200988","name":"Set end hour","func":"\n\nflow.set(\"silent_mode_end_hour\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":320,"wires":[["bd814b70.54caf8"]]},{"id":"bcebcf2a.43082","type":"function","z":"8874c4d3.200988","name":"Set end minute","func":"\nflow.set(\"silent_mode_end_minute\", msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":380,"wires":[["bd814b70.54caf8"]]},{"id":"ba5e023d.209ba","type":"ui_text","z":"8874c4d3.200988","group":"d5304c8f.46869","order":7,"width":0,"height":0,"name":"","label":"Silent mode end time","format":"","layout":"row-spread","x":220,"y":260,"wires":[]},{"id":"540071b.236b69","type":"ui_switch","z":"8874c4d3.200988","name":"Programmed silent mode","label":"Programmed silent mode","tooltip":"","group":"d5304c8f.46869","order":2,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":230,"y":540,"wires":[["398247de.cfd6b8"]]},{"id":"398247de.cfd6b8","type":"function","z":"8874c4d3.200988","name":"Set programmed silent mode","func":"\n\nflow.set(\"programmed_silent_mode\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":540,"wires":[[]]},{"id":"bc2f1192.024b","type":"inject","z":"8874c4d3.200988","name":"Periodical trigger","topic":"","payload":"","payloadType":"date","repeat":"60","crontab":"","once":false,"onceDelay":"1","x":210,"y":780,"wires":[["57c65ada.309404"]]},{"id":"57c65ada.309404","type":"function","z":"8874c4d3.200988","name":"Check heating due","func":"var datetime = new Date()\n\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\n\nvar target_start_hour = flow.get(\"silent_mode_start_hour\") || 0;\nvar target_start_minute = flow.get(\"silent_mode_start_minute\") || 0;\nvar target_end_hour = flow.get(\"silent_mode_end_hour\") || 0;\nvar target_end_minute = flow.get(\"silent_mode_end_minute\") || 0;\n\n\nvar program = flow.get(\"programmed_silent_mode\") || 0;\n\n\nmsg.payload = 99\n\nif(program)\n{\n    msg.payload = 98\n    if(target_start_hour == hours)\n    {\n        if(Math.abs(target_start_minute - minutes) < 2)\n        {\n            msg.payload = 1\n        }\n    }\n    if(target_end_hour == hours)\n    {\n        if(Math.abs(target_end_minute - minutes) < 2)\n        {\n            msg.payload = 0\n        }\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":780,"wires":[["26f58f9b.126cd","1c1474db.331d9b"]]},{"id":"26f58f9b.126cd","type":"debug","z":"8874c4d3.200988","name":"Bedroom: alarm due check","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":770,"y":840,"wires":[]},{"id":"1c1474db.331d9b","type":"switch","z":"8874c4d3.200988","name":"Check heating due","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":220,"y":680,"wires":[["b440c46e.1e47b8"],["b440c46e.1e47b8"],[]]},{"id":"d19395ae.cb6ea8","type":"inject","z":"b5887534.3c6f4","name":"Check every minute","topic":"","payload":"","payloadType":"date","repeat":"360","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":680,"wires":[["30ccc12d.1be04e"]]},{"id":"30ccc12d.1be04e","type":"function","z":"b5887534.3c6f4","name":"Check door status","func":"\nvar door_open = flow.get(\"balcony_door_open\") || 0;\nvar long_time_open_published = flow.get(\"long_time_open_published\") || 0;\nvar long_time_open_detection = flow.get(\"long_time_open_detection\") || 0;\n\nmsg.payload = false\n\nif(long_time_open_detection && door_open && !long_time_open_published)\n{\n    var open_time = flow.get(\"open_time\") || 0;\n    var datetime = new Date()\n    var timedif = Math.abs(datetime - open_time);\n    var threshold = flow.get(\"balcony_open_threshold\") || 0;\n\n    if(timedif > threshold)\n    {\n        msg.payload = true\n        flow.set(\"long_time_open_published\",true)\n    }\n    \n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":680,"wires":[["f244167e.329688"]]},{"id":"f244167e.329688","type":"switch","z":"b5887534.3c6f4","name":"","property":"payload","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":790,"y":680,"wires":[["b05f5685.1fb738","cbcc6656.472218"]]},{"id":"b05f5685.1fb738","type":"function","z":"b5887534.3c6f4","name":"Create long time open warning","func":"\nmsg.payload = \" -t \\\"La puerta de la terraza lleva mucho tiempo abierta\\\"\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":680,"wires":[["8e994503.0a1b08"]]},{"id":"a020dbc4.d75358","type":"ui_switch","z":"b5887534.3c6f4","name":"Balcony long time open detection","label":"Balcony long time open detection","tooltip":"","group":"a8d5eefe.34189","order":0,"width":0,"height":0,"passthru":false,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":300,"y":760,"wires":[["40e5baa1.f39a24"]]},{"id":"40e5baa1.f39a24","type":"function","z":"b5887534.3c6f4","name":"Set balcony open detection","func":"\nflow.set(\"long_time_open_detection\",msg.payload);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":760,"wires":[[]]},{"id":"cbcc6656.472218","type":"ifttt out","z":"b5887534.3c6f4","eventName":"balcony_long_time_open","key":"dab75ed.980752","x":1030,"y":740,"wires":[]},{"id":"b40c7bfe.d1b458","type":"switch","z":"ebed6492.dd9558","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1590,"y":960,"wires":[["deac84a9.4d6a"]]},{"id":"bbd96316.eee1","type":"switch","z":"2159e868.08f748","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":2010,"y":680,"wires":[["70da5525.02f034"]]},{"id":"8e994503.0a1b08","type":"switch","z":"b5887534.3c6f4","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1410,"y":520,"wires":[["cf2450e9.e5b3f8"]]},{"id":"3b6b73fc.6afb7c","type":"exec","z":"8874c4d3.200988","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":770,"y":980,"wires":[[],[],[]]},{"id":"4c3e2e03.f881f","type":"function","z":"8874c4d3.200988","name":"Set reminder","func":"\nmsg.payload = \" -d\"\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":980,"wires":[["3b6b73fc.6afb7c"]]},{"id":"5d92a4d6.91dbcc","type":"function","z":"ebed6492.dd9558","name":"Set entrance detection time","func":"var datetime = new Date();\n\nglobal.set(\"entrance_detection_time\", datetime)\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":440,"wires":[[]]},{"id":"766e9e40.80541","type":"inject","z":"8874c4d3.200988","name":"Trigger once","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"0.1","x":230,"y":1100,"wires":[["de1c24e7.05d828"]]},{"id":"de1c24e7.05d828","type":"function","z":"8874c4d3.200988","name":"Set initial values","func":"\nglobal.set(\"silent_mode\", false)\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":1100,"wires":[[]]},{"id":"90d5ace0.044e48","type":"delay","z":"2159e868.08f748","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":380,"y":800,"wires":[["a174ad79.3acee","e0f78272.3b36f","e9c74b28.518da8"]]},{"id":"27eab929.3addb6","type":"function","z":"b5887534.3c6f4","name":"Get rain next 3h","func":"var rain_sum = 0\n\nfor(i=0; i<2; i++)\n{\n    var rain_object = msg.payload[i].rain\n    if (typeof rain_object != 'undefined') rain_sum += rain_object[\"3h\"]\n}\n\nglobal.set(\"rain_forecast\",rain_sum)\n\n\nmsg.payload = rain_sum\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":600,"wires":[["c5ce9646.364798","e9113476.afdad8"]]},{"id":"c5ce9646.364798","type":"debug","z":"b5887534.3c6f4","name":"Current weather","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":740,"y":600,"wires":[]},{"id":"bf4adeac.6021a","type":"mqtt in","z":"2159e868.08f748","name":"Pressure detected","topic":"entrance_node/pressure_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":160,"y":1900,"wires":[["97ff935d.fc163"]]},{"id":"5eccfaaf.96a934","type":"mqtt in","z":"b5887534.3c6f4","name":"Exit detected","topic":"entrance_node/exit_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":230,"y":900,"wires":[["50a0f202.5180fc"]]},{"id":"ebd3069.baa82f8","type":"function","z":"b5887534.3c6f4","name":"Create balcony open reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/balcony_door_reminder.mp3\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1080,"y":900,"wires":[["8e994503.0a1b08"]]},{"id":"50a0f202.5180fc","type":"switch","z":"b5887534.3c6f4","name":"Switch warning","property":"balcony_door_open","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":480,"y":900,"wires":[["563aa127.0a3d8"]]},{"id":"563aa127.0a3d8","type":"switch","z":"b5887534.3c6f4","name":"Switch rain forecast","property":"rain_forecast","propertyType":"global","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":730,"y":900,"wires":[["831af4a9.6d2638"],["ebd3069.baa82f8"]]},{"id":"831af4a9.6d2638","type":"function","z":"b5887534.3c6f4","name":"Create rain reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/balcony_rain_reminder.mp3\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1130,"y":960,"wires":[["8e994503.0a1b08"]]},{"id":"e6613c22.1a33f","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"entrance_reboots\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"entrance_reboots\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":280,"wires":[["58023466.e89f2c","20e9133d.f39f9c"]]},{"id":"58023466.e89f2c","type":"ui_text","z":"372c6a0a.5b6fa6","group":"5ea35a44.fd3e34","order":2,"width":0,"height":0,"name":"Entrance last reboot","label":"Last reboot ","format":"{{msg.timestamp}}","layout":"row-spread","x":780,"y":280,"wires":[]},{"id":"20e9133d.f39f9c","type":"ui_text","z":"372c6a0a.5b6fa6","group":"5ea35a44.fd3e34","order":3,"width":0,"height":0,"name":"Num reboots entrance","label":"Num reboots","format":"{{msg.payload}}","layout":"row-spread","x":780,"y":340,"wires":[]},{"id":"72de6414.f81ffc","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Entrance reboot detected","topic":"entrance_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":280,"wires":[["e6613c22.1a33f","dcdc0948.82fe88"]]},{"id":"ec59a67d.d17df8","type":"ui_button","z":"372c6a0a.5b6fa6","name":"Reset","group":"bbf7ff0.aeff5","order":4,"width":"5","height":"1","passthru":false,"label":"Reset all","tooltip":"","color":"","bgcolor":"","icon":"","payload":"-1","payloadType":"num","topic":"","x":110,"y":140,"wires":[["e58e5124.21603"]]},{"id":"e58e5124.21603","type":"function","z":"372c6a0a.5b6fa6","name":"Set initial values","func":"\nflow.set(\"entrance_reboots\",-1);\nflow.set(\"attic_reboots\",-1);\nflow.set(\"livingroom_reboots\",-1);\nflow.set(\"bedroom_reboots\",-1);\nflow.set(\"balcony_reboots\",-1);\n\nflow.set(\"entrance_reconnects\",-1);\nflow.set(\"bedroom_reconnects\",-1);\nflow.set(\"attic_reconnects\",-1);\nflow.set(\"livingroom_reconnects\",-1);\nflow.set(\"balcony_reconnects\",-1);\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["e6613c22.1a33f","5ee2a405.25d3bc","938ee2ef.64d77","f97365c.c735f98","d3deda28.1ac2a8","a8500866.fedfd8","4b2108c6.143d","d4f0af73.85aa68","fee97bce.0d246","bf9e2d9d.196528"]]},{"id":"dcdc0948.82fe88","type":"debug","z":"372c6a0a.5b6fa6","name":"Entrance reboot detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":470,"y":340,"wires":[]},{"id":"5ee2a405.25d3bc","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\n\nvar count = flow.get(\"livingroom_reboots\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"livingroom_reboots\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":440,"wires":[["5aabe764.cb2cf8","2df29e54.49cb62"]]},{"id":"5aabe764.cb2cf8","type":"ui_text","z":"372c6a0a.5b6fa6","group":"b08803e9.31eb7","order":2,"width":0,"height":0,"name":"Livingroom last reboot","label":"Last reboot ","format":"{{msg.timestamp}}","layout":"row-spread","x":780,"y":440,"wires":[]},{"id":"2df29e54.49cb62","type":"ui_text","z":"372c6a0a.5b6fa6","group":"b08803e9.31eb7","order":3,"width":0,"height":0,"name":"Num reboots livingroom","label":"Num reboots","format":"{{msg.payload}}","layout":"row-spread","x":790,"y":500,"wires":[]},{"id":"7132060d.655728","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Livingroom reboot detected","topic":"livingroom_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":200,"y":440,"wires":[["5ee2a405.25d3bc","95c0a592.6a66b8"]]},{"id":"95c0a592.6a66b8","type":"debug","z":"372c6a0a.5b6fa6","name":"Livingroom reboot detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":480,"y":500,"wires":[]},{"id":"938ee2ef.64d77","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"bedroom_reboots\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"bedroom_reboots\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":600,"wires":[["bec5a771.590068","7f45f2a4.9dfd6c"]]},{"id":"bec5a771.590068","type":"ui_text","z":"372c6a0a.5b6fa6","group":"fdf24e3d.60209","order":2,"width":0,"height":0,"name":"Bedroom last reboot","label":"Last reboot ","format":"{{msg.timestamp}}","layout":"row-spread","x":780,"y":600,"wires":[]},{"id":"7f45f2a4.9dfd6c","type":"ui_text","z":"372c6a0a.5b6fa6","group":"fdf24e3d.60209","order":3,"width":0,"height":0,"name":"Num reboots bedroom","label":"Num reboots","format":"{{msg.payload}}","layout":"row-spread","x":780,"y":660,"wires":[]},{"id":"696ccb52.708fe4","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Bedroom reboot detected","topic":"bedroom_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":600,"wires":[["938ee2ef.64d77","4b108abb.285ff4"]]},{"id":"4b108abb.285ff4","type":"debug","z":"372c6a0a.5b6fa6","name":"Bedroom reboot detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":470,"y":660,"wires":[]},{"id":"f97365c.c735f98","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"attic_reboots\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"attic_reboots\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":760,"wires":[["2eeb8ed5.a93552","f9a0e1b1.bef23"]]},{"id":"2eeb8ed5.a93552","type":"ui_text","z":"372c6a0a.5b6fa6","group":"dadda8b2.d4ca58","order":2,"width":0,"height":0,"name":"Attic last reboot","label":"Last reboot ","format":"{{msg.timestamp}}","layout":"row-spread","x":760,"y":760,"wires":[]},{"id":"f9a0e1b1.bef23","type":"ui_text","z":"372c6a0a.5b6fa6","group":"dadda8b2.d4ca58","order":3,"width":0,"height":0,"name":"Num reboots attic","label":"Num reboots","format":"{{msg.payload}}","layout":"row-spread","x":770,"y":820,"wires":[]},{"id":"9d4cbe94.72281","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Attic reboot detected","topic":"attic_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":180,"y":760,"wires":[["f97365c.c735f98","5d655473.b50cac"]]},{"id":"5d655473.b50cac","type":"debug","z":"372c6a0a.5b6fa6","name":"Attic reboot detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":460,"y":820,"wires":[]},{"id":"d3deda28.1ac2a8","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"balcony_reboots\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"balcony_reboots\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":450,"y":920,"wires":[["58b811f4.8e969","9cc7dffe.226ab"]]},{"id":"58b811f4.8e969","type":"ui_text","z":"372c6a0a.5b6fa6","group":"efcd26a0.d476d8","order":2,"width":0,"height":0,"name":"Balcony last reboot","label":"Last reboot ","format":"{{msg.timestamp}}","layout":"row-spread","x":770,"y":920,"wires":[]},{"id":"9cc7dffe.226ab","type":"ui_text","z":"372c6a0a.5b6fa6","group":"efcd26a0.d476d8","order":3,"width":0,"height":0,"name":"Num reboots balcony","label":"Num reboots","format":"{{msg.payload}}","layout":"row-spread","x":780,"y":980,"wires":[]},{"id":"ea7d2c5c.1a836","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Balcony reboot detected","topic":"balcony_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":190,"y":920,"wires":[["d3deda28.1ac2a8","9a3005d9.7b6a28"]]},{"id":"9a3005d9.7b6a28","type":"debug","z":"372c6a0a.5b6fa6","name":"Balcony reboot detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":470,"y":980,"wires":[]},{"id":"ddd3dd05.a34cf8","type":"mqtt in","z":"bf97828f.e0d5","name":"Washmachine consumption","topic":"smart_washmachine/consumption","qos":"2","broker":"e67c6dfd.2c6b98","x":280,"y":500,"wires":[["e95c82bf.9b1b58"]]},{"id":"b1aa8db7.d2eb8","type":"debug","z":"bf97828f.e0d5","name":"Current consumption","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":820,"y":440,"wires":[]},{"id":"e95c82bf.9b1b58","type":"function","z":"bf97828f.e0d5","name":"Set current consumption","func":"var consumption = parseInt(msg.payload);\n\nif(consumption > 900)\n{\n    consumption = 900\n}\n\nflow.set(\"current_consumption\", consumption)\n\nmsg.payload = consumption\n\nreturn msg","outputs":1,"noerr":0,"x":530,"y":500,"wires":[["3ae2e386.a6060c","b1aa8db7.d2eb8"]]},{"id":"e5e7f9bf.30084","type":"inject","z":"bf97828f.e0d5","name":"Check periodically","topic":"","payload":"","payloadType":"date","repeat":"300","crontab":"","once":true,"onceDelay":"1","x":240,"y":620,"wires":[["398db2ac.cdcb86"]]},{"id":"398db2ac.cdcb86","type":"exec","z":"bf97828f.e0d5","command":"/home/pi/Projects/smart_washmachine/smart_washmachine_safe","addpay":false,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":690,"y":620,"wires":[[],[],["ebaef3c9.269698"]]},{"id":"ebaef3c9.269698","type":"delay","z":"bf97828f.e0d5","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1040,"y":620,"wires":[["1c7d91e6.ec250e"]]},{"id":"1c7d91e6.ec250e","type":"function","z":"bf97828f.e0d5","name":"Washmachine SM","func":"\nvar is_working = flow.get(\"is_working\") || 0;\nvar current_consumption = flow.get(\"current_consumption\") || 0;\n\nmsg.payload = \"\"\n\n//Check if it was already working\nif(is_working)\n{\n    //Has finished\n    if(current_consumption == 0)\n    {\n        flow.set(\"is_working\",false);\n        msg.payload = \"FINISHED\";\n    }\n}\n//Not working before\nelse\n{\n    //Has started\n    if(current_consumption > 0)\n    {\n        flow.set(\"is_working\",true);\n        msg.payload = \"STARTED\";\n    }\n}\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":620,"wires":[["8d72b4a4.65ba8"]]},{"id":"8d72b4a4.65ba8","type":"switch","z":"bf97828f.e0d5","name":"Switch state","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"FINISHED","vt":"str"},{"t":"eq","v":"STARTED","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1530,"y":620,"wires":[["50673c81.c9f654","377d0aa5.51a956","fdf56aed.26e258","d4d4ba68.afb4e","f751efd6.723118"],["2059e863.57437","a8829dfb.0d5198","14476ffe.bef51"]],"outputLabels":["","message.topic = "]},{"id":"50673c81.c9f654","type":"function","z":"bf97828f.e0d5","name":"Create washmachine finished command","func":"msg.payload = \" -f /home/pi/Projects/audio_node/sounds/washmachine_finished.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1920,"y":280,"wires":[["3cb4d0b4.39b8e"]]},{"id":"3cb4d0b4.39b8e","type":"switch","z":"bf97828f.e0d5","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":2210,"y":280,"wires":[["305bfb44.af946c"]]},{"id":"305bfb44.af946c","type":"exec","z":"bf97828f.e0d5","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2560,"y":280,"wires":[[],[],[]]},{"id":"377d0aa5.51a956","type":"ifttt out","z":"bf97828f.e0d5","eventName":"washmachine_finished","key":"dab75ed.980752","x":1860,"y":340,"wires":[]},{"id":"fdf56aed.26e258","type":"mqtt out","z":"bf97828f.e0d5","name":"Washmachine finished","topic":"washmachine_node/finished","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1860,"y":500,"wires":[]},{"id":"a8829dfb.0d5198","type":"delay","z":"bf97828f.e0d5","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1680,"y":720,"wires":[["7b3c9d78.56d7cc"]]},{"id":"2059e863.57437","type":"function","z":"bf97828f.e0d5","name":"Parse message. Switch ON","func":"\nmsg = {payload:\n      {\n        req:1\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1880,"y":660,"wires":[["d7f04101.8d9d6"]]},{"id":"7b3c9d78.56d7cc","type":"function","z":"bf97828f.e0d5","name":"Parse message. Blue light","func":"\nmsg = {payload:\n      {\n        r:0,\n        g:0,\n        b:255\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1890,"y":720,"wires":[["141733e1.5c21dc"]]},{"id":"141733e1.5c21dc","type":"mqtt out","z":"bf97828f.e0d5","name":"Lamp color request","topic":"livingroom_node/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2150,"y":720,"wires":[]},{"id":"d7f04101.8d9d6","type":"mqtt out","z":"bf97828f.e0d5","name":"Lamp state request","topic":"livingroom_node/light_state","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2150,"y":660,"wires":[]},{"id":"d4d4ba68.afb4e","type":"function","z":"bf97828f.e0d5","name":"Parse message. Red light","func":"\nmsg = {payload:\n      {\n        r:255,\n        g:0,\n        b:0\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1870,"y":580,"wires":[["7c7b0052.20344"]]},{"id":"7c7b0052.20344","type":"mqtt out","z":"bf97828f.e0d5","name":"Lamp color request","topic":"livingroom_node/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2140,"y":580,"wires":[]},{"id":"6e83b293.8e6624","type":"inject","z":"bf97828f.e0d5","name":"Set initial values","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":"0.1","x":240,"y":720,"wires":[["97e641a9.7e8778"]]},{"id":"97e641a9.7e8778","type":"function","z":"bf97828f.e0d5","name":"Set initial values","func":"\nflow.set(\"current_consumption\", -1)\nflow.set(\"is_working\",false);","outputs":1,"noerr":0,"x":520,"y":720,"wires":[[]]},{"id":"3ae2e386.a6060c","type":"ui_chart","z":"bf97828f.e0d5","name":"Washmachine graph","group":"4406aa4.a2328d4","order":2,"width":"12","height":"6","label":"Washmachine consumption","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"1000","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":820,"y":500,"wires":[[],[]]},{"id":"f751efd6.723118","type":"ifttt out","z":"bf97828f.e0d5","eventName":"washmachine_finished","key":"59f1345a.5292fc","x":1860,"y":420,"wires":[]},{"id":"a8500866.fedfd8","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\n\nvar count = flow.get(\"entrance_reconnects\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"entrance_reconnects\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":1390,"y":280,"wires":[["91421284.fd7ca8","142ce15d.230cf7"]]},{"id":"91421284.fd7ca8","type":"ui_text","z":"372c6a0a.5b6fa6","group":"5ea35a44.fd3e34","order":2,"width":0,"height":0,"name":"Entrance last reconnect","label":"Last reconnect","format":"{{msg.timestamp}}","layout":"row-spread","x":1700,"y":280,"wires":[]},{"id":"142ce15d.230cf7","type":"ui_text","z":"372c6a0a.5b6fa6","group":"5ea35a44.fd3e34","order":3,"width":0,"height":0,"name":"Num reconnects entrance","label":"Num reconnects","format":"{{msg.payload}}","layout":"row-spread","x":1690,"y":340,"wires":[]},{"id":"c667dce2.28d","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Entrance reconnection detected","topic":"entrance_node/reconnect","qos":"2","broker":"e67c6dfd.2c6b98","x":1110,"y":280,"wires":[["a8500866.fedfd8","62bd45b3.7a6c2c"]]},{"id":"62bd45b3.7a6c2c","type":"debug","z":"372c6a0a.5b6fa6","name":"Entrance reconnect detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1380,"y":340,"wires":[]},{"id":"4b2108c6.143d","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"bedroom_reconnects\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"bedroom_reconnects\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":1390,"y":600,"wires":[["37884566.835c2a","8ca0df4e.1faea"]]},{"id":"37884566.835c2a","type":"ui_text","z":"372c6a0a.5b6fa6","group":"fdf24e3d.60209","order":2,"width":0,"height":0,"name":"Bedroom last reconnect","label":"Last reconnect","format":"{{msg.timestamp}}","layout":"row-spread","x":1740,"y":600,"wires":[]},{"id":"8ca0df4e.1faea","type":"ui_text","z":"372c6a0a.5b6fa6","group":"fdf24e3d.60209","order":3,"width":0,"height":0,"name":"Num reconnects bedroom","label":"Num reconnects","format":"{{msg.payload}}","layout":"row-spread","x":1730,"y":660,"wires":[]},{"id":"865886ff.1ae9c8","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Bedroom reboot detected","topic":"bedroom_node/boot","qos":"2","broker":"e67c6dfd.2c6b98","x":1130,"y":600,"wires":[["4b2108c6.143d","45d044d8.c0fbfc"]]},{"id":"45d044d8.c0fbfc","type":"debug","z":"372c6a0a.5b6fa6","name":"Bedroom reconnect detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1420,"y":660,"wires":[]},{"id":"d4f0af73.85aa68","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\n\nvar count = flow.get(\"livingroom_reconnects\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"livingroom_reconnects\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":440,"wires":[["bbdae88a.651f7","c2751d81.38522"]]},{"id":"bbdae88a.651f7","type":"ui_text","z":"372c6a0a.5b6fa6","group":"b08803e9.31eb7","order":2,"width":0,"height":0,"name":"Livingroom last reconnect","label":"Last reconnect ","format":"{{msg.timestamp}}","layout":"row-spread","x":1690,"y":440,"wires":[]},{"id":"c2751d81.38522","type":"ui_text","z":"372c6a0a.5b6fa6","group":"b08803e9.31eb7","order":3,"width":0,"height":0,"name":"Num reconnects livingroom","label":"Num reconnects","format":"{{msg.payload}}","layout":"row-spread","x":1700,"y":500,"wires":[]},{"id":"43143606.4051c","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Livingroom reconnection detected","topic":"livingroom_node/reconnect","qos":"2","broker":"e67c6dfd.2c6b98","x":1120,"y":440,"wires":[["d4f0af73.85aa68","422f4b85.736e1c"]]},{"id":"422f4b85.736e1c","type":"debug","z":"372c6a0a.5b6fa6","name":"Livingroom reconnect detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1390,"y":500,"wires":[]},{"id":"fee97bce.0d246","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"attic_reconnects\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"attic_reconnects\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":760,"wires":[["1e5b8dc.a8927f2","1b7633fc.89f30c"]]},{"id":"1e5b8dc.a8927f2","type":"ui_text","z":"372c6a0a.5b6fa6","group":"dadda8b2.d4ca58","order":2,"width":0,"height":0,"name":"Attic last reconnect","label":"Last reconnect ","format":"{{msg.timestamp}}","layout":"row-spread","x":1670,"y":760,"wires":[]},{"id":"1b7633fc.89f30c","type":"ui_text","z":"372c6a0a.5b6fa6","group":"dadda8b2.d4ca58","order":3,"width":0,"height":0,"name":"Num reconnects attic","label":"Num reconnects","format":"{{msg.payload}}","layout":"row-spread","x":1680,"y":820,"wires":[]},{"id":"8ab0bc86.cc91b","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Attic reconnect detected","topic":"attic_node/reconnect","qos":"2","broker":"e67c6dfd.2c6b98","x":1090,"y":760,"wires":[["fee97bce.0d246","6dba20c5.f03cc"]]},{"id":"6dba20c5.f03cc","type":"debug","z":"372c6a0a.5b6fa6","name":"Attic reconnect detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1370,"y":820,"wires":[]},{"id":"bf9e2d9d.196528","type":"function","z":"372c6a0a.5b6fa6","name":"Set payload","func":"var datetime = new Date()\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\n\nvar count = flow.get(\"balcony_reconnects\") || 0;\n\nmsg.payload = count + 1\n\nflow.set(\"balcony_reconnects\",msg.payload)\n\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":1350,"y":920,"wires":[["ee249bfb.061eb8","dcc04981.2f21d8"]]},{"id":"ee249bfb.061eb8","type":"ui_text","z":"372c6a0a.5b6fa6","group":"efcd26a0.d476d8","order":2,"width":0,"height":0,"name":"Balcony last reconnect","label":"Last reconnect ","format":"{{msg.timestamp}}","layout":"row-spread","x":1680,"y":920,"wires":[]},{"id":"dcc04981.2f21d8","type":"ui_text","z":"372c6a0a.5b6fa6","group":"efcd26a0.d476d8","order":3,"width":0,"height":0,"name":"Num reconnects balcony","label":"Num reconnects","format":"{{msg.payload}}","layout":"row-spread","x":1690,"y":980,"wires":[]},{"id":"ed7cf723.bcea78","type":"mqtt in","z":"372c6a0a.5b6fa6","name":"Balcony reconnect detected","topic":"balcony_node/reconnect","qos":"2","broker":"e67c6dfd.2c6b98","x":1100,"y":920,"wires":[["bf9e2d9d.196528","d3d4d348.77a3a8"]]},{"id":"d3d4d348.77a3a8","type":"debug","z":"372c6a0a.5b6fa6","name":"Balcony reconnect detected","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1380,"y":980,"wires":[]},{"id":"f5dd49d1.644bf8","type":"switch","z":"c7dd94f4.6cfe98","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1190,"y":1840,"wires":[["69e31b6e.0ac0b4"]]},{"id":"14476ffe.bef51","type":"function","z":"bf97828f.e0d5","name":"Create washmachine started command","func":"msg.payload = \" -f /home/pi/Projects/audio_node/sounds/washmachine_started.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1770,"y":800,"wires":[["6c04216b.ece28"]]},{"id":"6c04216b.ece28","type":"switch","z":"bf97828f.e0d5","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":2070,"y":800,"wires":[["580333fb.b59ff4"]]},{"id":"580333fb.b59ff4","type":"exec","z":"bf97828f.e0d5","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2420,"y":800,"wires":[[],[],[]]},{"id":"eb238879.60d558","type":"function","z":"474b74d5.8d1c2c","name":"Create heating reminder command","func":"var heating = global.get(\"attic_heating\") || 0;\n\nif(heating)\n{\n    msg.topic = 1;\n   \n    msg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_heating_reminder.mp3 \"\n\n}\n\nelse\n{\n    msg.topic = 0;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":1060,"wires":[["786f9200.7d931"]]},{"id":"786f9200.7d931","type":"switch","z":"474b74d5.8d1c2c","name":"Switch msg","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1080,"y":1060,"wires":[["7ff6be95.7783e"]]},{"id":"aaf968d3.2da9","type":"ui_colour_picker","z":"f2d0d6f7.e3639","name":"","label":"Lamp color","group":"7e057122.d766d8","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":true,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":7,"width":0,"height":0,"passthru":true,"topic":"","x":770,"y":80,"wires":[["888575ba.8fda48"]]},{"id":"888575ba.8fda48","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = global.get(\"lamp_network_mask\") || 0;\n\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":80,"wires":[["822bb32b.d1bb48"]]},{"id":"822bb32b.d1bb48","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp color request","topic":"lamp_network/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1250,"y":80,"wires":[]},{"id":"230de85.41d2418","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Intensity","tooltip":"","group":"7e057122.d766d8","order":1,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":760,"y":160,"wires":[["c1674ba3.7e6d9"]]},{"id":"c1674ba3.7e6d9","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = global.get(\"lamp_network_mask\") || 0;\n\nmsg = {payload:\n      {\n        intensity:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":160,"wires":[["8ffaaf30.f0dc"]]},{"id":"8ffaaf30.f0dc","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1270,"y":160,"wires":[]},{"id":"84450b8d.719d38","type":"ui_dropdown","z":"f2d0d6f7.e3639","name":"Mode","label":"","tooltip":"","place":"Select option","group":"7e057122.d766d8","order":2,"width":0,"height":0,"passthru":false,"options":[{"label":"OFF","value":0,"type":"num"},{"label":"ON","value":"1","type":"str"},{"label":"TEST_EFFECT","value":"2","type":"str"},{"label":"STREAMING","value":"3","type":"str"},{"label":"RGB LOOP","value":"10","type":"str"},{"label":"FADE IN OUT","value":"11","type":"str"},{"label":"STROBE","value":"12","type":"str"},{"label":"FIRE","value":"13","type":"str"},{"label":"HALLOWEEN EYES","value":"14","type":"str"},{"label":"CYCLON BOUNCE","value":"15","type":"str"},{"label":"TWINKLE","value":"16","type":"str"},{"label":"TWINKLE RANDOM","value":"17","type":"str"},{"label":"SPARKLE","value":"18","type":"str"},{"label":"SNOW SPARKLE","value":"19","type":"str"},{"label":"RUNNING LIGHTS","value":"20","type":"str"},{"label":"COLOR WIPE","value":"21","type":"str"},{"label":"RAINBOW CYCLE","value":"22","type":"str"},{"label":"THEATER CHASE","value":"23","type":"str"},{"label":"THEATER CHASE RAINBOW","value":"24","type":"str"},{"label":"BOUNCING BALLS","value":"25","type":"str"},{"label":"METEOR RAIN","value":"26","type":"str"},{"label":"FADE TO BLACK","value":"27","type":"str"}],"payload":"","topic":"","x":750,"y":400,"wires":[["2c1e73af.45fa14"]]},{"id":"2c1e73af.45fa14","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var mask = global.get(\"lamp_network_mask\") || 0;\n\nglobal.set(\"lamp_network_state\",msg.payload);\n\nmsg = {payload:\n      {\n        mode:msg.payload,\n        id_mask:mask\n      }}\n     \n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":400,"wires":[["80f06def.b86a28"]]},{"id":"80f06def.b86a28","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1260,"y":400,"wires":[]},{"id":"1b13bee3.4c86f1","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Speed","tooltip":"","group":"7e057122.d766d8","order":1,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":750,"y":240,"wires":[["6bee0b3a.1fdf94"]]},{"id":"6bee0b3a.1fdf94","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = global.get(\"lamp_network_mask\") || 0;\n\nmsg = {payload:\n      {\n        speed:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":240,"wires":[["6284f7b.1369088"]]},{"id":"6284f7b.1369088","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/effect_speed","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1270,"y":240,"wires":[]},{"id":"fa2fc4f4.13ec78","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Delay","tooltip":"","group":"7e057122.d766d8","order":1,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":750,"y":320,"wires":[["332e7e36.99b29a"]]},{"id":"332e7e36.99b29a","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = global.get(\"lamp_network_mask\") || 0;\n\nmsg = {payload:\n      {\n        delay:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":320,"wires":[["c65cddc0.7ae86"]]},{"id":"c65cddc0.7ae86","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/effect_delay","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1270,"y":320,"wires":[]},{"id":"80a7786d.393a6","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Init communication request received","topic":"lamp_network/initcomm_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":320,"y":740,"wires":[["9a059bca.7ca418"]]},{"id":"9a059bca.7ca418","type":"delay","z":"f2d0d6f7.e3639","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":610,"y":740,"wires":[["bd52ba4f.1e52e8"]]},{"id":"ffb08a85.05fa08","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode response","topic":"lamp_network/initcommrx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1460,"y":700,"wires":[]},{"id":"5b496a6b.61dbfc","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var ID = 0;\nvar URL = \"default\";\nvar URL_name = \"http://default.local\";\nvar IP = msg.payload.ip;\n\nvar num_resets = flow.get(\"num_resets\") || 0;\nvar num_resets_current = 0;\n\nvar datetime = new Date();\nvar lamp_mode = global.get(\"lamp_network_state\") || 0;\n\nvar msg;\n\nif(msg.payload.mac == \"3C:71:BF:6A:CA:68\")\n{\n   ID = 0;\n   URL = \"lamp1\"\n   URL_name = \"http://lamp1.local\"\n   num_resets[0]++;\n   num_resets_current = num_resets[0];\n}\n\nelse if(msg.payload.mac == \"CC:50:E3:A0:9C:48\")\n{\n    ID = 1;\n    URL = \"lamp2\"\n    URL_name = \"http://lamp2.local\"\n    num_resets[1]++;\n    num_resets_current = num_resets[1];\n}\n\nelse if(msg.payload.mac == \"CC:50:E3:9A:10:5C\")\n{\n    ID = 2;\n    URL = \"livingroom1\"\n    URL_name = \"http://livingroom1.local\"\n    num_resets[2]++;\n    num_resets_current = num_resets[2];\n}\n\nelse if(msg.payload.mac == \"3C:71:BF:42:06:58\")\n{\n    ID = 3;\n    URL = \"livingroom2\"\n    URL_name = \"http://livingroom2.local\"\n    num_resets[3]++;\n    num_resets_current = num_resets[3];\n}\n\nflow.set(\"num_resets\",num_resets);\n\n\nmsg = {payload:\n      {\n        mac_origin:msg.payload.mac,\n        deviceID:ID,\n        OTA_URL:URL,\n        mode:lamp_mode\n      },\n      url_name: URL_name,\n      IP_addr:IP,\n      num_resets_cpu:num_resets_current,\n      reset_reason_0:msg.payload.rst_0,\n      reset_reason_1:msg.payload.rst_1\n    }\n\nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":740,"wires":[["ffb08a85.05fa08","3db858f8.377c78","1396ffc9.b883c"]]},{"id":"f501bf9a.808ea8","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1030,"y":820,"wires":[]},{"id":"bd52ba4f.1e52e8","type":"json","z":"f2d0d6f7.e3639","name":"Json converter","property":"payload","action":"","pretty":false,"x":840,"y":740,"wires":[["5b496a6b.61dbfc","f501bf9a.808ea8"]]},{"id":"663a477a.168a3","type":"ui_button","z":"f2d0d6f7.e3639","name":"Online","group":"ba930eb2.97191","order":2,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":690,"y":1180,"wires":[[]]},{"id":"73420bac.e96374","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\") * 2;\n\nif((datetime - lamp_online[0]) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\",\n        payload: 1\n    }\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\",\n        payload: 0\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1180,"wires":[["663a477a.168a3","d8c9979.3ae6468"]]},{"id":"648ba6e2.72e4b8","type":"inject","z":"f2d0d6f7.e3639","name":"","topic":"","payload":"","payloadType":"date","repeat":"30","crontab":"","once":true,"onceDelay":0.1,"x":310,"y":1280,"wires":[["73420bac.e96374","5e6bf0d8.8d7828","63a79d52.005c84","2ea4f376.83c50c","edbf728d.641d88"]]},{"id":"4fa07c86.57a67c","type":"ui_button","z":"f2d0d6f7.e3639","name":"Online","group":"c221d889.38444","order":2,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":690,"y":1240,"wires":[[]]},{"id":"5e6bf0d8.8d7828","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\") * 2;\n\nif((datetime - lamp_online[1]) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\",\n        payload:1\n    }\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\",\n        payload:0\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1240,"wires":[["4fa07c86.57a67c"]]},{"id":"503ec90e.89617","type":"ui_button","z":"f2d0d6f7.e3639","name":"Online","group":"8a259194.fed238","order":1,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":690,"y":1320,"wires":[[]]},{"id":"63a79d52.005c84","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\") * 2;\n\nif((datetime - lamp_online[2]) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\",\n        payload:1\n    }\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\",\n        payload:0\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1320,"wires":[["503ec90e.89617","2e7b1c0a.ab0554"]]},{"id":"c9df1536.1604e8","type":"ui_button","z":"f2d0d6f7.e3639","name":"Online","group":"af9ce26a.3ce9b","order":1,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":690,"y":1380,"wires":[[]]},{"id":"2ea4f376.83c50c","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\") * 2;\n\nif((datetime - lamp_online[3]) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\",\n        payload:1\n    }\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\",\n        payload:0\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":1380,"wires":[["c9df1536.1604e8","2c4c1a4b.2c59c6"]]},{"id":"f90868c5.0d24b8","type":"ui_switch","z":"f2d0d6f7.e3639","name":"ON/OFF livingroom 1","label":"ON/OFF","tooltip":"","group":"8a259194.fed238","order":9,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":720,"y":2300,"wires":[["7f6d32ce.044acc"]]},{"id":"b9d282ae.52c8d","type":"ui_switch","z":"f2d0d6f7.e3639","name":"Group control livingroom 1","label":"Group control","tooltip":"","group":"8a259194.fed238","order":8,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":740,"y":2360,"wires":[["a5c308b6.16004"]]},{"id":"3f16d729.595608","type":"ui_text","z":"f2d0d6f7.e3639","group":"ba930eb2.97191","order":2,"width":0,"height":0,"name":"Lamp 1 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":1620,"y":780,"wires":[]},{"id":"3db858f8.377c78","type":"switch","z":"f2d0d6f7.e3639","name":"","property":"payload.deviceID","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"str"},{"t":"eq","v":"2","vt":"str"},{"t":"eq","v":"3","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":1420,"y":860,"wires":[["3f16d729.595608","65e723da.87a68c","5a338ab4.dc3fcc","30319c41.e92bd4"],["ac6de895.ba2618","a73f319c.e9618","45b121cb.6af418","6a62779f.1423b8"],["86d5b81f.e48f68","7f3294b5.81022c","e5e8c7fb.c2f9d","f4ad0516.c538c","75a1c7ac.b60ed8","f3ab60bd.f7e8f"],["e2dbae2c.68d558","883c12ff.24d0f8","b08e4bac.04f2a","38b735e0.f40952","2fd55217.325b06","5570c8d2.b98c7"]]},{"id":"65e723da.87a68c","type":"ui_text","z":"f2d0d6f7.e3639","group":"ba930eb2.97191","order":2,"width":0,"height":0,"name":"Lamp 1 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":1630,"y":820,"wires":[]},{"id":"5a338ab4.dc3fcc","type":"ui_text","z":"f2d0d6f7.e3639","group":"ba930eb2.97191","order":2,"width":0,"height":0,"name":"Lamp 1 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":1650,"y":860,"wires":[]},{"id":"ac6de895.ba2618","type":"ui_text","z":"f2d0d6f7.e3639","group":"c221d889.38444","order":2,"width":0,"height":0,"name":"Lamp 2 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":1620,"y":980,"wires":[]},{"id":"a73f319c.e9618","type":"ui_text","z":"f2d0d6f7.e3639","group":"c221d889.38444","order":2,"width":0,"height":0,"name":"Lamp 2 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":1630,"y":1020,"wires":[]},{"id":"45b121cb.6af418","type":"ui_text","z":"f2d0d6f7.e3639","group":"c221d889.38444","order":2,"width":0,"height":0,"name":"Lamp 2 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":1650,"y":1060,"wires":[]},{"id":"86d5b81f.e48f68","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":2,"width":0,"height":0,"name":"Livingroom 1 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":1640,"y":1160,"wires":[]},{"id":"7f3294b5.81022c","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":3,"width":0,"height":0,"name":"Livingroom 1 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":1650,"y":1200,"wires":[]},{"id":"e5e8c7fb.c2f9d","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":4,"width":0,"height":0,"name":"Livingroom 1 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":1660,"y":1240,"wires":[]},{"id":"e2dbae2c.68d558","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":2,"width":0,"height":0,"name":"Livingroom 2 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":1640,"y":1440,"wires":[]},{"id":"883c12ff.24d0f8","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":3,"width":0,"height":0,"name":"Livingroom 2 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":1650,"y":1480,"wires":[]},{"id":"b08e4bac.04f2a","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":4,"width":0,"height":0,"name":"Livingroom 2 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":1670,"y":1520,"wires":[]},{"id":"39e90cf4.389444","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar datetime = new Date();\nvar lamp_online = flow.get(\"lamp_online\");\n\nif(msg.payload == \"0\")\n{\n   lamp_online[0] = datetime\n}\nif(msg.payload == \"1\")\n{\n   lamp_online[1] = datetime\n}\nif(msg.payload == \"2\")\n{\n   lamp_online[2] = datetime\n}\nif(msg.payload == \"3\")\n{\n   lamp_online[3] = datetime\n}\n\nflow.set(\"lamp_online\",lamp_online)\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":900,"wires":[[]]},{"id":"fea97b9a.aa06c8","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Alive msg received","topic":"lamp_network/alive_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":270,"y":900,"wires":[["39e90cf4.389444","dd796c02.5e7fe"]]},{"id":"edbf728d.641d88","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Alive msg send","topic":"lamp_network/alive_rx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":520,"y":1100,"wires":[]},{"id":"8cf51245.a3fc98","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Init communication request received","topic":"lamp_network/initcommrx","qos":"2","broker":"e67c6dfd.2c6b98","x":980,"y":960,"wires":[["7343b81a.4a852"]]},{"id":"7343b81a.4a852","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1270,"y":960,"wires":[]},{"id":"6f6f40ba.9ef69","type":"mqtt out","z":"ebed6492.dd9558","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1260,"y":560,"wires":[]},{"id":"38b735e0.f40952","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":5,"width":0,"height":0,"name":"Livingroom 2 num resets","label":"Num resets","format":"{{msg.num_resets_cpu}}","layout":"row-spread","x":1670,"y":1560,"wires":[]},{"id":"2fd55217.325b06","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":6,"width":0,"height":0,"name":"Livingroom 2 reset reason","label":"Reset reason core 0","format":"{{msg.reset_reason_0}}","layout":"row-spread","x":1680,"y":1600,"wires":[]},{"id":"5570c8d2.b98c7","type":"ui_text","z":"f2d0d6f7.e3639","group":"af9ce26a.3ce9b","order":7,"width":0,"height":0,"name":"Livingroom 2 reset reason","label":"Reset reason core 1","format":"{{msg.reset_reason_1}}","layout":"row-spread","x":1680,"y":1640,"wires":[]},{"id":"a547cd94.f04bb8","type":"ui_button","z":"f2d0d6f7.e3639","name":"Reset","group":"7e057122.d766d8","order":2,"width":0,"height":0,"passthru":false,"label":"Clear num resets","tooltip":"","color":"","bgcolor":"","icon":"","payload":"","payloadType":"str","topic":"","x":750,"y":480,"wires":[["1fcb137d.b78d6d"]]},{"id":"1fcb137d.b78d6d","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar num_resets = [ 0, 0, 0, 0 ];\nvar lamp_online = [ 0, 0, 0, 0 ];\n\nflow.set(\"lamp_online\",lamp_online)\nflow.set(\"num_resets\",num_resets);\n\n ","outputs":1,"noerr":0,"x":1000,"y":480,"wires":[[]]},{"id":"1396ffc9.b883c","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1370,"y":620,"wires":[]},{"id":"f4ad0516.c538c","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":5,"width":0,"height":0,"name":"Livingroom 1 num resets","label":"Num resets","format":"{{msg.num_resets_cpu}}","layout":"row-spread","x":1670,"y":1280,"wires":[]},{"id":"75a1c7ac.b60ed8","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":6,"width":0,"height":0,"name":"Livingroom 1 reset reason","label":"Reset reason core 0","format":"{{msg.reset_reason_0}}","layout":"row-spread","x":1680,"y":1320,"wires":[]},{"id":"f3ab60bd.f7e8f","type":"ui_text","z":"f2d0d6f7.e3639","group":"8a259194.fed238","order":7,"width":0,"height":0,"name":"Livingroom 1 reset reason","label":"Reset reason core 1","format":"{{msg.reset_reason_1}}","layout":"row-spread","x":1680,"y":1360,"wires":[]},{"id":"7f6d32ce.044acc","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var mode;\nvar mask = 1 << 2;\n\nif(msg.payload)\n{\n    mode = 1\n}\nelse\n{\n    mode = 0\n}\n\nmsg = {payload:\n      {\n        mode:msg.payload,\n        id_mask:mask\n      }}\n     \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":2300,"wires":[["4b6ff7d4.c1adc8"]]},{"id":"a5c308b6.16004","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar target_mask = global.get(\"lamp_network_mask\") || 0;\n\nif(msg.payload)\n{\n    target_mask |= (1 << 2)\n}\nelse\n{\n    target_mask ^=  (1 << 2)\n}\n\nglobal.set(\"lamp_network_mask\",target_mask);\n","outputs":1,"noerr":0,"x":1000,"y":2360,"wires":[[]]},{"id":"4d74d781.0c2ed","type":"ui_colour_picker","z":"f2d0d6f7.e3639","name":"","label":"Lamp color","group":"8a259194.fed238","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":false,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":11,"width":0,"height":0,"passthru":true,"topic":"","x":690,"y":2420,"wires":[["a2fce7a3.78029"]]},{"id":"a2fce7a3.78029","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 2;\n\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":2420,"wires":[["12e8eace.73291d"]]},{"id":"12e8eace.73291d","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp color request","topic":"lamp_network/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1170,"y":2420,"wires":[]},{"id":"1ed20b58.3ad725","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Intensity","tooltip":"","group":"8a259194.fed238","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":680,"y":2500,"wires":[["657e8acd.b0b4a4"]]},{"id":"657e8acd.b0b4a4","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 2;\n\nmsg = {payload:\n      {\n        intensity:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":2500,"wires":[["906c9a02.097a58"]]},{"id":"906c9a02.097a58","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1190,"y":2500,"wires":[]},{"id":"4b6ff7d4.c1adc8","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1280,"y":2300,"wires":[]},{"id":"1d6d51a2.d68c06","type":"ui_switch","z":"f2d0d6f7.e3639","name":"ON/OFF livingroom 2","label":"ON/OFF","tooltip":"","group":"af9ce26a.3ce9b","order":9,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":720,"y":2600,"wires":[["a7e591f2.9bca08"]]},{"id":"b4fb1c58.07307","type":"ui_switch","z":"f2d0d6f7.e3639","name":"Group control livingroom 2","label":"Group control","tooltip":"","group":"af9ce26a.3ce9b","order":8,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":740,"y":2660,"wires":[["29e8f8d4.df3fd"]]},{"id":"a7e591f2.9bca08","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var mode;\nvar mask = 1 << 3;\n\nif(msg.payload)\n{\n    mode = 1\n}\nelse\n{\n    mode = 0\n}\n\nmsg = {payload:\n      {\n        mode:msg.payload,\n        id_mask:mask\n      }}\n     \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":2600,"wires":[["f70cae03.87cb38"]]},{"id":"29e8f8d4.df3fd","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar target_mask = global.get(\"lamp_network_mask\") || 0;\n\n\nif(msg.payload)\n{\n    target_mask |= (1 << 3)\n}\nelse\n{\n    target_mask ^=  (1 << 3)\n}\n\n\nglobal.set(\"lamp_network_mask\",target_mask);\n","outputs":1,"noerr":0,"x":1000,"y":2660,"wires":[[]]},{"id":"78cd599e.120a1","type":"ui_colour_picker","z":"f2d0d6f7.e3639","name":"","label":"Lamp color","group":"af9ce26a.3ce9b","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":false,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":11,"width":0,"height":0,"passthru":true,"topic":"","x":690,"y":2720,"wires":[["d894a5a2.afd18"]]},{"id":"d894a5a2.afd18","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 3;\n\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":2720,"wires":[["12441032.23b54"]]},{"id":"12441032.23b54","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp color request","topic":"lamp_network/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1170,"y":2720,"wires":[]},{"id":"83b22d13.3fa66","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Intensity","tooltip":"","group":"af9ce26a.3ce9b","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":680,"y":2800,"wires":[["4b32ce36.d402c"]]},{"id":"4b32ce36.d402c","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 3;\n\nmsg = {payload:\n      {\n        intensity:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":920,"y":2800,"wires":[["a0b9a058.b188b"]]},{"id":"a0b9a058.b188b","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1190,"y":2800,"wires":[]},{"id":"f70cae03.87cb38","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1280,"y":2600,"wires":[]},{"id":"76efbad6.c6b5fc","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Mode request sent","topic":"lamp_network/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":1530,"y":400,"wires":[["c31151e1.833818"]]},{"id":"c31151e1.833818","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1870,"y":400,"wires":[]},{"id":"43a599a8.2eaed8","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Init communication request received","topic":"lamp_network/light_color","qos":"2","broker":"e67c6dfd.2c6b98","x":1560,"y":80,"wires":[["15a7c60a.a9b662"]]},{"id":"15a7c60a.a9b662","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1830,"y":80,"wires":[]},{"id":"dd796c02.5e7fe","type":"debug","z":"f2d0d6f7.e3639","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":590,"y":960,"wires":[]},{"id":"275ebf9b.2225d","type":"ui_switch","z":"f2d0d6f7.e3639","name":"ON/OFF lamp 1","label":"ON/OFF","tooltip":"","group":"ba930eb2.97191","order":9,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":720,"y":1660,"wires":[["2e20d565.c397b2"]]},{"id":"a151ff39.f03db","type":"ui_switch","z":"f2d0d6f7.e3639","name":"Group control lamp 1","label":"Group control","tooltip":"","group":"ba930eb2.97191","order":8,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":740,"y":1720,"wires":[["287df2ef.232b26"]]},{"id":"2e20d565.c397b2","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var mode;\nvar mask = 1;\n\nif(msg.payload)\n{\n    mode = 1\n}\nelse\n{\n    mode = 0\n}\n\nmsg = {payload:\n      {\n        mode:msg.payload,\n        id_mask:mask\n      }}\n     \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":1660,"wires":[["1d9c18c7.c1ae17"]]},{"id":"287df2ef.232b26","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar target_mask = global.get(\"lamp_network_mask\") || 0;\n\n\n\nif(msg.payload)\n{\n    target_mask |= 1\n}\nelse\n{\n    target_mask ^=  1\n}\n\nglobal.set(\"lamp_network_mask\",target_mask);\n","outputs":1,"noerr":0,"x":1020,"y":1720,"wires":[[]]},{"id":"cb600c72.a95ca8","type":"ui_colour_picker","z":"f2d0d6f7.e3639","name":"Lamp 1 color","label":"Lamp color","group":"ba930eb2.97191","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":false,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":11,"width":0,"height":0,"passthru":true,"topic":"","x":710,"y":1780,"wires":[["2b71f8ba.3cf6e"]]},{"id":"2b71f8ba.3cf6e","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1;\n\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":1780,"wires":[["19737ca5.c0a0e3"]]},{"id":"19737ca5.c0a0e3","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp color request","topic":"lamp_network/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1190,"y":1780,"wires":[]},{"id":"c8c66ffa.3633a8","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Intensity","tooltip":"","group":"ba930eb2.97191","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":700,"y":1860,"wires":[["fda5eb59.bae4b8"]]},{"id":"fda5eb59.bae4b8","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1;\n\nmsg = {payload:\n      {\n        intensity:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":1860,"wires":[["381ca451.1498e4"]]},{"id":"381ca451.1498e4","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1210,"y":1860,"wires":[]},{"id":"1d9c18c7.c1ae17","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1300,"y":1660,"wires":[]},{"id":"7b68d95e.a26208","type":"ui_switch","z":"f2d0d6f7.e3639","name":"ON/OFF lamp 2","label":"ON/OFF","tooltip":"","group":"c221d889.38444","order":9,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":720,"y":1960,"wires":[["ca7aa41c.7e7cb8"]]},{"id":"f40bc482.5c3f","type":"ui_switch","z":"f2d0d6f7.e3639","name":"Group control lamp 2","label":"Group control","tooltip":"","group":"c221d889.38444","order":8,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":740,"y":2020,"wires":[["15ae049a.b2e0d3"]]},{"id":"ca7aa41c.7e7cb8","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"var mode;\nvar mask = 1 << 1;\n\nif(msg.payload)\n{\n    mode = 1\n}\nelse\n{\n    mode = 0\n}\n\nmsg = {payload:\n      {\n        mode:msg.payload,\n        id_mask:mask\n      }}\n     \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":1960,"wires":[["cbf5e89b.d18e5"]]},{"id":"15ae049a.b2e0d3","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar target_mask = global.get(\"lamp_network_mask\") || 0;\n\n\nif(msg.payload)\n{\n    target_mask |= (1 << 1)\n}\nelse\n{\n    target_mask ^=  (1 << 1)\n}\n\n\nglobal.set(\"lamp_network_mask\",target_mask);\n","outputs":1,"noerr":0,"x":1020,"y":2020,"wires":[[]]},{"id":"58cb3a6b.72824c","type":"ui_colour_picker","z":"f2d0d6f7.e3639","name":"","label":"Lamp color","group":"c221d889.38444","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":false,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":11,"width":0,"height":0,"passthru":true,"topic":"","x":710,"y":2080,"wires":[["97416bdc.02c828"]]},{"id":"97416bdc.02c828","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 1;\n\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":930,"y":2080,"wires":[["3a2c14a5.344ae4"]]},{"id":"3a2c14a5.344ae4","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp color request","topic":"lamp_network/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1190,"y":2080,"wires":[]},{"id":"8dbd850b.817e1","type":"ui_slider","z":"f2d0d6f7.e3639","name":"","label":"Intensity","tooltip":"","group":"c221d889.38444","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":700,"y":2160,"wires":[["2411bdb1.254392"]]},{"id":"2411bdb1.254392","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar mask = 1 << 1;\n\nmsg = {payload:\n      {\n        intensity:msg.payload,\n        id_mask:mask\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":2160,"wires":[["181ce8bc.4e2fa7"]]},{"id":"181ce8bc.4e2fa7","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp intensity request","topic":"lamp_network/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1210,"y":2160,"wires":[]},{"id":"cbf5e89b.d18e5","type":"mqtt out","z":"f2d0d6f7.e3639","name":"Lamp mode request","topic":"lamp_network/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1300,"y":1960,"wires":[]},{"id":"e6a39346.dbef7","type":"ui_colour_picker","z":"e9df2fe6.24247","name":"","label":"Lamp color","group":"f585547a.bc35d8","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":true,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":8,"width":0,"height":0,"passthru":true,"topic":"","x":810,"y":180,"wires":[["da43e07b.188c88"]]},{"id":"da43e07b.188c88","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":180,"wires":[["90ee5799.78ba88"]]},{"id":"90ee5799.78ba88","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp color request","topic":"terrace_node/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1290,"y":180,"wires":[]},{"id":"dac2ba85.f49078","type":"ui_slider","z":"e9df2fe6.24247","name":"","label":"Intensity","tooltip":"","group":"f585547a.bc35d8","order":9,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":800,"y":260,"wires":[["8cd3a08.70eb7e"]]},{"id":"8cd3a08.70eb7e","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nmsg = {payload:\n      {\n        intensity:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":260,"wires":[["e75f0351.049a1"]]},{"id":"e75f0351.049a1","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp intensity request","topic":"terrace_node/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1310,"y":260,"wires":[]},{"id":"dc327176.a917b","type":"ui_dropdown","z":"e9df2fe6.24247","name":"Mode","label":"","tooltip":"","place":"Select option","group":"f585547a.bc35d8","order":7,"width":0,"height":0,"passthru":false,"options":[{"label":"OFF","value":0,"type":"num"},{"label":"ON","value":"1","type":"str"},{"label":"TEST_EFFECT","value":"2","type":"str"},{"label":"STREAMING","value":"3","type":"str"},{"label":"RGB LOOP","value":"10","type":"str"},{"label":"FADE IN OUT","value":"11","type":"str"},{"label":"STROBE","value":"12","type":"str"},{"label":"FIRE","value":"13","type":"str"},{"label":"HALLOWEEN EYES","value":"14","type":"str"},{"label":"CYCLON BOUNCE","value":"15","type":"str"},{"label":"TWINKLE","value":"16","type":"str"},{"label":"TWINKLE RANDOM","value":"17","type":"str"},{"label":"SPARKLE","value":"18","type":"str"},{"label":"SNOW SPARKLE","value":"19","type":"str"},{"label":"RUNNING LIGHTS","value":"20","type":"str"},{"label":"COLOR WIPE","value":"21","type":"str"},{"label":"RAINBOW CYCLE","value":"22","type":"str"},{"label":"THEATER CHASE","value":"23","type":"str"},{"label":"THEATER CHASE RAINBOW","value":"24","type":"str"},{"label":"BOUNCING BALLS","value":"25","type":"str"},{"label":"METEOR RAIN","value":"26","type":"str"},{"label":"FADE TO BLACK","value":"27","type":"str"}],"payload":"","topic":"","x":790,"y":500,"wires":[["fb45d62.15e0228"]]},{"id":"fb45d62.15e0228","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nflow.set(\"mode\",msg.payload);\n\nmsg = {payload:\n      {\n        mode:msg.payload\n      }}\n     \n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":500,"wires":[["ef682235.cdff08"]]},{"id":"ef682235.cdff08","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp mode request","topic":"terrace_node/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1300,"y":500,"wires":[]},{"id":"11fc45c8.115ba2","type":"ui_slider","z":"e9df2fe6.24247","name":"","label":"Speed","tooltip":"","group":"f585547a.bc35d8","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":790,"y":340,"wires":[["a8542bbe.776f08"]]},{"id":"a8542bbe.776f08","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nmsg = {payload:\n      {\n        speed:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":340,"wires":[["b2243fa3.140358"]]},{"id":"b2243fa3.140358","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp intensity request","topic":"terrace_node/effect_speed","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1310,"y":340,"wires":[]},{"id":"2477577c.b29158","type":"ui_slider","z":"e9df2fe6.24247","name":"","label":"Delay","tooltip":"","group":"f585547a.bc35d8","order":11,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":790,"y":420,"wires":[["4198a61c.2266f"]]},{"id":"4198a61c.2266f","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nmsg = {payload:\n      {\n        delay:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":420,"wires":[["dbd15b59.417c2"]]},{"id":"dbd15b59.417c2","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp intensity request","topic":"terrace_node/effect_delay","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1310,"y":420,"wires":[]},{"id":"a6940c49.8b4798","type":"mqtt in","z":"e9df2fe6.24247","name":"Init communication request received","topic":"terrace_node/initcomm_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":520,"y":820,"wires":[["5fd0bdae.ceac7c"]]},{"id":"5fd0bdae.ceac7c","type":"delay","z":"e9df2fe6.24247","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":810,"y":820,"wires":[["e0ff570.e7036a8"]]},{"id":"56a6840c.32ca94","type":"mqtt out","z":"e9df2fe6.24247","name":"Lamp mode response","topic":"terrace_node/initcommrx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":1690,"y":820,"wires":[]},{"id":"dc44c578.28739","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"var ID = 1;\nvar URL = \"terrace_node\";\nvar URL_name = \"http://terrace_node.local\";\nvar IP = msg.payload.ip;\n\nvar num_resets = flow.get(\"num_resets\") || 0;\nvar num_resets_current = 0;\n\nvar datetime = new Date();\nvar lamp_mode = flow.get(\"mode\") || 0;\n\nvar msg;\n\n\nmsg = {payload:\n      {\n        mac_origin:msg.payload.mac,\n        deviceID:ID,\n        OTA_URL:URL,\n        mode:lamp_mode\n      },\n      url_name: URL_name,\n      IP_addr:IP,\n      num_resets_cpu:num_resets_current,\n      reset_reason_0:msg.payload.rst_0,\n      reset_reason_1:msg.payload.rst_1\n    }\n\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":820,"wires":[["56a6840c.32ca94","d478699d.0e3f38"]]},{"id":"8d0a5159.e5b9d","type":"debug","z":"e9df2fe6.24247","name":"Init Comm TX","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1240,"y":900,"wires":[]},{"id":"e0ff570.e7036a8","type":"json","z":"e9df2fe6.24247","name":"Json converter","property":"payload","action":"","pretty":false,"x":1040,"y":820,"wires":[["dc44c578.28739","8d0a5159.e5b9d"]]},{"id":"d0b6b1de.af3538","type":"ui_button","z":"e9df2fe6.24247","name":"Online","group":"f585547a.bc35d8","order":3,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":890,"y":1260,"wires":[[]]},{"id":"d885698.0911218","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\") * 2;\n\nif((datetime - lamp_online) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\"\n    }\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":1260,"wires":[["d0b6b1de.af3538"]]},{"id":"392e6587.b1f362","type":"function","z":"e9df2fe6.24247","name":"Set initial values","func":"flow.set(\"alive_time\",30000);","outputs":1,"noerr":0,"x":540,"y":1480,"wires":[[]]},{"id":"35e538bc.c232c8","type":"inject","z":"e9df2fe6.24247","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":350,"y":1480,"wires":[["392e6587.b1f362"]]},{"id":"bf225683.af5bf","type":"inject","z":"e9df2fe6.24247","name":"","topic":"","payload":"","payloadType":"date","repeat":"9","crontab":"","once":true,"onceDelay":0.1,"x":510,"y":1360,"wires":[["d885698.0911218","722b88b9.1f2e"]]},{"id":"8444c253.8b0cf","type":"ui_text","z":"e9df2fe6.24247","group":"f585547a.bc35d8","order":4,"width":0,"height":0,"name":"Lamp 1 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":1820,"y":900,"wires":[]},{"id":"d478699d.0e3f38","type":"switch","z":"e9df2fe6.24247","name":"","property":"payload.deviceID","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1620,"y":940,"wires":[["8444c253.8b0cf","6c478c71.f4a084","a6c37cd2.866c4"]]},{"id":"6c478c71.f4a084","type":"ui_text","z":"e9df2fe6.24247","group":"f585547a.bc35d8","order":5,"width":0,"height":0,"name":"Lamp 1 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":1830,"y":940,"wires":[]},{"id":"a6c37cd2.866c4","type":"ui_text","z":"e9df2fe6.24247","group":"f585547a.bc35d8","order":6,"width":0,"height":0,"name":"Lamp 1 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":1850,"y":980,"wires":[]},{"id":"4aa50b7f.14c524","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nvar datetime = new Date();\nvar lamp_online = flow.get(\"lamp_online\");\n\nlamp_online = datetime\n\n\nflow.set(\"lamp_online\",lamp_online)\n\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":980,"wires":[[]]},{"id":"798e7eb3.3561a8","type":"mqtt in","z":"e9df2fe6.24247","name":"Alive msg received","topic":"terrace_node/alive_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":470,"y":980,"wires":[["4aa50b7f.14c524","798e75f4.1e5ef4"]]},{"id":"722b88b9.1f2e","type":"mqtt out","z":"e9df2fe6.24247","name":"Alive msg send","topic":"terrace_node/alive_rx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":720,"y":1180,"wires":[]},{"id":"5d6ca6ef.0657b","type":"mqtt in","z":"e9df2fe6.24247","name":"Init communication request received","topic":"terrace_node/initcommrx","qos":"2","broker":"e67c6dfd.2c6b98","x":1180,"y":1040,"wires":[["59ef28ff.ebe1a8"]]},{"id":"59ef28ff.ebe1a8","type":"debug","z":"e9df2fe6.24247","name":"Init Comm RX","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1480,"y":1040,"wires":[]},{"id":"66db2c32.cc8ef4","type":"mqtt in","z":"e9df2fe6.24247","name":"Mode request sent","topic":"terrace_node/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":1570,"y":500,"wires":[["5a00da2e.2ecb54"]]},{"id":"5a00da2e.2ecb54","type":"debug","z":"e9df2fe6.24247","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1910,"y":500,"wires":[]},{"id":"90517a76.f28608","type":"mqtt in","z":"e9df2fe6.24247","name":"Init communication request received","topic":"terrace_node/light_color","qos":"2","broker":"e67c6dfd.2c6b98","x":1600,"y":180,"wires":[["3d3cc6cb.e48f62"]]},{"id":"3d3cc6cb.e48f62","type":"debug","z":"e9df2fe6.24247","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1870,"y":180,"wires":[]},{"id":"798e75f4.1e5ef4","type":"debug","z":"e9df2fe6.24247","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":790,"y":1040,"wires":[]},{"id":"9b83152f.826528","type":"debug","z":"e9df2fe6.24247","name":"Terrace: temperature msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":930,"y":1600,"wires":[]},{"id":"5501f0b.a427e1","type":"ui_gauge","z":"e9df2fe6.24247","name":"Temperature","group":"f585547a.bc35d8","order":1,"width":"4","height":"3","gtype":"gage","title":"Temperature","label":"ÂºC","format":"{{value}}","min":"6","max":"30","colors":["#50b500","#e6df00","#ca3838"],"seg1":"17","seg2":"23","x":890,"y":1660,"wires":[]},{"id":"e2f3ed57.07fcf","type":"mqtt in","z":"e9df2fe6.24247","name":"Temperature","topic":"terrace_node/temperature","qos":"2","broker":"e67c6dfd.2c6b98","x":510,"y":1660,"wires":[["5501f0b.a427e1","9b83152f.826528"]]},{"id":"8c674843.6b4ae","type":"mqtt in","z":"e9df2fe6.24247","name":"Humidity","topic":"terrace_node/humidity","qos":"2","broker":"e67c6dfd.2c6b98","x":500,"y":1880,"wires":[["d48af382.3e5ec"]]},{"id":"4e7d64.e4f15a9c","type":"mqtt in","z":"e9df2fe6.24247","name":"Light amount","topic":"terrace_node/light","qos":"2","broker":"e67c6dfd.2c6b98","x":510,"y":2100,"wires":[["2e9dd225.5b8b56"]]},{"id":"9ec26d96.263f28","type":"ui_gauge","z":"e9df2fe6.24247","name":"Light amount","group":"f585547a.bc35d8","order":2,"width":"4","height":"3","gtype":"wave","title":"Light","label":"Lx","format":"{{value}}","min":0,"max":"100","colors":["#50b500","#e6df00","#ca3838"],"seg1":"","seg2":"","x":990,"y":2100,"wires":[]},{"id":"58182e1b.055a3","type":"function","z":"e9df2fe6.24247","name":"Set light amount ","func":"\nglobal.set(\"light_amount_terrace\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":2280,"wires":[[]]},{"id":"8c6ed696.ff23b","type":"debug","z":"e9df2fe6.24247","name":"Received msg: light amount","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1040,"y":2040,"wires":[]},{"id":"2e9dd225.5b8b56","type":"json","z":"e9df2fe6.24247","name":"Json converter","property":"payload","action":"","pretty":false,"x":740,"y":2100,"wires":[["8c6ed696.ff23b","9ec26d96.263f28","58182e1b.055a3"]]},{"id":"d48af382.3e5ec","type":"debug","z":"e9df2fe6.24247","name":"Terrace: humidity msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":920,"y":1820,"wires":[]},{"id":"e349fd63.863ec","type":"mqtt in","z":"e9df2fe6.24247","name":"Balcony door","topic":"livingroom_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":150,"y":580,"wires":[["a3b5043a.84a32"]]},{"id":"a3b5043a.84a32","type":"function","z":"e9df2fe6.24247","name":"Set balcony_door_open","func":"\nvar mode = flow.get(\"mode\") || 0;\n\nif(msg.payload == \"1\")\n{\n    flow.set(\"balcony_door_open\", true)\n    var datetime = new Date();\n    flow.set(\"last_balcony_open\", datetime)\n    flow.set(\"long_time_open_published\", false)\n\n    if(mode == 0)\n    {\n        mode = 1;\n    }\n}\nelse \n{\n    flow.set(\"balcony_door_open\", false)\n}\n\nflow.set(\"mode\",mode);\n\nmsg = {payload:\n      {\n        mode:mode\n      }}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":580,"wires":[["5361ca40.b8fdec"]]},{"id":"6a62779f.1423b8","type":"ui_text","z":"f2d0d6f7.e3639","group":"c221d889.38444","order":5,"width":0,"height":0,"name":"Lamp 2 num resets","label":"Num resets","format":"{{msg.num_resets_cpu}}","layout":"row-spread","x":1650,"y":1100,"wires":[]},{"id":"30319c41.e92bd4","type":"ui_text","z":"f2d0d6f7.e3639","group":"ba930eb2.97191","order":5,"width":0,"height":0,"name":"Lamp 1 num resets","label":"Num resets","format":"{{msg.num_resets_cpu}}","layout":"row-spread","x":1650,"y":900,"wires":[]},{"id":"d05ad523.70ea1","type":"ui_colour_picker","z":"c7dd94f4.6cfe98","name":"","label":"Lamp color","group":"24098ce9.c81324","format":"rgb","outformat":"object","showSwatch":true,"showPicker":false,"showValue":true,"showHue":false,"showAlpha":false,"showLightness":true,"dynOutput":"false","order":8,"width":0,"height":0,"passthru":true,"topic":"","x":2050,"y":40,"wires":[["136113f.ee1db6c"]]},{"id":"136113f.ee1db6c","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nmsg = {payload:\n      {\n        R:msg.payload.r,\n        G:msg.payload.g,\n        B:msg.payload.b\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":2270,"y":40,"wires":[["a1c8217a.b90ce"]]},{"id":"a1c8217a.b90ce","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp color request","topic":"bedroom_node/light_color","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2530,"y":40,"wires":[]},{"id":"c04d64f6.1b5018","type":"ui_slider","z":"c7dd94f4.6cfe98","name":"","label":"Intensity","tooltip":"","group":"24098ce9.c81324","order":9,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":10,"step":1,"x":2040,"y":120,"wires":[["df1b2b21.6af75"]]},{"id":"df1b2b21.6af75","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nmsg = {payload:\n      {\n        intensity:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":120,"wires":[["a5d9458b.c8fb8"]]},{"id":"a5d9458b.c8fb8","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp intensity request","topic":"bedroom_node/light_intensity","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2550,"y":120,"wires":[]},{"id":"74625247.2ae56c","type":"ui_dropdown","z":"c7dd94f4.6cfe98","name":"Mode","label":"","tooltip":"","place":"Select option","group":"24098ce9.c81324","order":7,"width":0,"height":0,"passthru":false,"options":[{"label":"OFF","value":0,"type":"num"},{"label":"ON","value":"1","type":"str"},{"label":"TEST_EFFECT","value":"2","type":"str"},{"label":"STREAMING","value":"3","type":"str"},{"label":"RGB LOOP","value":"10","type":"str"},{"label":"FADE IN OUT","value":"11","type":"str"},{"label":"STROBE","value":"12","type":"str"},{"label":"FIRE","value":"13","type":"str"},{"label":"HALLOWEEN EYES","value":"14","type":"str"},{"label":"CYCLON BOUNCE","value":"15","type":"str"},{"label":"TWINKLE","value":"16","type":"str"},{"label":"TWINKLE RANDOM","value":"17","type":"str"},{"label":"SPARKLE","value":"18","type":"str"},{"label":"SNOW SPARKLE","value":"19","type":"str"},{"label":"RUNNING LIGHTS","value":"20","type":"str"},{"label":"COLOR WIPE","value":"21","type":"str"},{"label":"RAINBOW CYCLE","value":"22","type":"str"},{"label":"THEATER CHASE","value":"23","type":"str"},{"label":"THEATER CHASE RAINBOW","value":"24","type":"str"},{"label":"BOUNCING BALLS","value":"25","type":"str"},{"label":"METEOR RAIN","value":"26","type":"str"},{"label":"FADE TO BLACK","value":"27","type":"str"}],"payload":"","topic":"","x":2030,"y":360,"wires":[["11a7a26b.33e8de"]]},{"id":"11a7a26b.33e8de","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nflow.set(\"mode\",msg.payload);\n\nmsg = {payload:\n      {\n        mode:msg.payload\n      }}\n     \n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":360,"wires":[["813a3f58.91fa18","1f6aec6c.bf50f4"]]},{"id":"813a3f58.91fa18","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp mode request","topic":"bedroom_node/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2540,"y":360,"wires":[]},{"id":"44c8ff91.ec93b8","type":"ui_slider","z":"c7dd94f4.6cfe98","name":"","label":"Speed","tooltip":"","group":"24098ce9.c81324","order":10,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":2030,"y":200,"wires":[["a45e28b3.67556"]]},{"id":"a45e28b3.67556","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nmsg = {payload:\n      {\n        speed:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":200,"wires":[["a46b4e13.376ea"]]},{"id":"a46b4e13.376ea","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp intensity request","topic":"bedroom_node/effect_speed","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2550,"y":200,"wires":[]},{"id":"f7766ac7.a8a708","type":"ui_slider","z":"c7dd94f4.6cfe98","name":"","label":"Delay","tooltip":"","group":"24098ce9.c81324","order":11,"width":0,"height":0,"passthru":true,"outs":"end","topic":"","min":0,"max":"100","step":1,"x":2030,"y":280,"wires":[["5b4d07f7.c70758"]]},{"id":"5b4d07f7.c70758","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nmsg = {payload:\n      {\n        delay:msg.payload\n      }}\n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":280,"wires":[["e06eef2.e27091"]]},{"id":"e06eef2.e27091","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp intensity request","topic":"bedroom_node/effect_delay","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2550,"y":280,"wires":[]},{"id":"b04e1bb9.997558","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Init communication request received","topic":"bedroom_node/initcomm_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":2060,"y":780,"wires":[["2a3e67d3.e10e6"]]},{"id":"2a3e67d3.e10e6","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"100","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2350,"y":780,"wires":[["3d2bb4bb.7c89ec"]]},{"id":"a45a0121.cf4ed8","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp mode response","topic":"bedroom_node/initcommrx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":3230,"y":780,"wires":[]},{"id":"3e7586ef.1fab3a","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"var ID = 1;\nvar URL = \"bedroom_node\";\nvar URL_name = \"http://bedroom_node.local\";\nvar IP = msg.payload.ip;\n\nvar num_resets = flow.get(\"num_resets\") || 0;\nvar num_resets_current = 0;\n\nvar datetime = new Date();\nvar lamp_mode = flow.get(\"mode\") || 0;\n\nvar msg;\n\n\nmsg = {payload:\n      {\n        mac_origin:msg.payload.mac,\n        deviceID:ID,\n        OTA_URL:URL,\n        mode:lamp_mode\n      },\n      url_name: URL_name,\n      IP_addr:IP,\n      num_resets_cpu:num_resets_current,\n      reset_reason_0:msg.payload.rst_0,\n      reset_reason_1:msg.payload.rst_1\n    }\n\nreturn msg;","outputs":1,"noerr":0,"x":2920,"y":780,"wires":[["a45a0121.cf4ed8","a9ca421e.8f908"]]},{"id":"4d9c727.751120c","type":"debug","z":"c7dd94f4.6cfe98","name":"Init Comm TX","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2780,"y":860,"wires":[]},{"id":"3d2bb4bb.7c89ec","type":"json","z":"c7dd94f4.6cfe98","name":"Json converter","property":"payload","action":"","pretty":false,"x":2580,"y":780,"wires":[["3e7586ef.1fab3a","4d9c727.751120c"]]},{"id":"9b980d83.0074f8","type":"ui_button","z":"c7dd94f4.6cfe98","name":"Online","group":"f194e702.838568","order":3,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":2430,"y":1220,"wires":[[]]},{"id":"be34129f.6c1ea8","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"var lamp_online = flow.get(\"lamp_online\");\n\nvar lamp_connection_status = flow.get(\"lamp_connection_status\");\n\nvar msg;\nvar datetime = new Date()\nvar time_threshold = flow.get(\"alive_time\");\n\nif((datetime - lamp_online) < time_threshold)\n{\n    msg = {topic: \"ONLINE\",\n        background: \"GREEN\",\n        payload: 1\n    }\n    \n    if(!lamp_connection_status)\n    {\n        flow.set(\"connect_time\",datetime);\n    }\n    lamp_connection_status = true;\n}\nelse\n{\n    msg = {topic: \"OFFLINE\",\n        background: \"RED\",\n        payload: 0\n    }\n    if(lamp_connection_status)\n    {\n        flow.set(\"disconnect_time\",datetime);\n    }\n    lamp_connection_status = false;\n}\n\nflow.set(\"lamp_connection_status\",lamp_connection_status);\n\nreturn msg;","outputs":1,"noerr":0,"x":2260,"y":1220,"wires":[["9b980d83.0074f8","6b6aa2db.41fe5c","42b3adc3.97f68c","9ee5cb48.26eed","9fad3ffc.08781"]]},{"id":"e015775b.24b5b","type":"function","z":"c7dd94f4.6cfe98","name":"Set initial values","func":"\nflow.set(\"num_desconnect\",0);\nflow.set(\"alive_time\",30000);","outputs":1,"noerr":0,"x":2080,"y":1440,"wires":[[]]},{"id":"d2e2fc70.9991","type":"inject","z":"c7dd94f4.6cfe98","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":1890,"y":1440,"wires":[["e015775b.24b5b"]]},{"id":"26527b27.eab46c","type":"inject","z":"c7dd94f4.6cfe98","name":"","topic":"","payload":"","payloadType":"date","repeat":"30","crontab":"","once":true,"onceDelay":0.1,"x":2050,"y":1320,"wires":[["be34129f.6c1ea8","31633f64.d7e0a"]]},{"id":"5b8e9563.ceef94","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":4,"width":0,"height":0,"name":"Lamp 1 IP","label":"IP address","format":"{{msg.IP_addr}}","layout":"row-spread","x":3360,"y":860,"wires":[]},{"id":"a9ca421e.8f908","type":"switch","z":"c7dd94f4.6cfe98","name":"","property":"payload.deviceID","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":3160,"y":900,"wires":[["5b8e9563.ceef94","c2d995d2.2dd0b","82a396f.5bf1868"]]},{"id":"c2d995d2.2dd0b","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":5,"width":0,"height":0,"name":"Lamp 1 MAC","label":"MAC address","format":"{{msg.payload.mac_origin}}","layout":"row-spread","x":3370,"y":900,"wires":[]},{"id":"82a396f.5bf1868","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":6,"width":0,"height":0,"name":"Lamp 1 OTA URL","label":"OTA URL","format":"{{msg.url_name}}","layout":"row-spread","x":3390,"y":940,"wires":[]},{"id":"4a6da4e2.8c10ac","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nvar datetime = new Date();\nvar lamp_online = flow.get(\"lamp_online\");\n\nlamp_online = datetime\n\n\nflow.set(\"lamp_online\",lamp_online)\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2340,"y":940,"wires":[[]]},{"id":"b9eae5d.e0d1d98","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Alive msg received","topic":"bedroom_node/alive_tx","qos":"2","broker":"e67c6dfd.2c6b98","x":2010,"y":940,"wires":[["4a6da4e2.8c10ac","9e940327.58274"]]},{"id":"31633f64.d7e0a","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Alive msg send","topic":"bedroom_node/alive_rx","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2260,"y":1140,"wires":[]},{"id":"7810253b.69dc74","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Init communication request received","topic":"bedroom_node/initcommrx","qos":"2","broker":"e67c6dfd.2c6b98","x":2720,"y":1000,"wires":[["9834b662.cbe6e8"]]},{"id":"9834b662.cbe6e8","type":"debug","z":"c7dd94f4.6cfe98","name":"Init Comm RX","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":3020,"y":1000,"wires":[]},{"id":"4504294b.bc71d8","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Mode request sent","topic":"bedroom_node/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":2810,"y":440,"wires":[["fcd48223.c8967"]]},{"id":"fcd48223.c8967","type":"debug","z":"c7dd94f4.6cfe98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":3150,"y":440,"wires":[]},{"id":"5a50bae8.7568dc","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Init communication request received","topic":"bedroom_node/light_color","qos":"2","broker":"e67c6dfd.2c6b98","x":2840,"y":120,"wires":[["6e9d7b4b.fc4a5c"]]},{"id":"6e9d7b4b.fc4a5c","type":"debug","z":"c7dd94f4.6cfe98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":3110,"y":120,"wires":[]},{"id":"9e940327.58274","type":"debug","z":"c7dd94f4.6cfe98","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2330,"y":1000,"wires":[]},{"id":"e9d37ec9.e3a878","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Temperature","topic":"bedroom_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":130,"y":240,"wires":[["e1f0ba42.ff7cb"]]},{"id":"e1f0ba42.ff7cb","type":"debug","z":"c7dd94f4.6cfe98","name":"Bedroom: door msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":400,"y":240,"wires":[]},{"id":"e63206dd.59cfb8","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Bedroom window","topic":"bedroom_node/door_status","qos":"2","broker":"e67c6dfd.2c6b98","x":140,"y":60,"wires":[["eb996fc1.b45f1","ed6490cd.6eb8e"]]},{"id":"ed6490cd.6eb8e","type":"function","z":"c7dd94f4.6cfe98","name":"Create balcony open/closed command","func":"\n\nif(msg.payload == \"1\")\n{\n    msg.payload = \" -f /home/pi/Projects/audio_node/sounds/bedroom_door_open.mp3\"\n}\nelse\n{\n    msg.payload = \" -f /home/pi/Projects/audio_node/sounds/bedroom_door_closed.mp3\"\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":160,"wires":[["b81db17e.087cb"]]},{"id":"eb996fc1.b45f1","type":"function","z":"c7dd94f4.6cfe98","name":"Set bedroom_window_open","func":"\nif(msg.payload == \"1\")\n{\n    flow.set(\"bedroom_window_open\", true)\n    var datetime = new Date();\n    flow.set(\"last_bedroom_open\", datetime)\n    flow.set(\"long_time_open_published\", false)\n}\nelse \n{\n    flow.set(\"bedroom_window_open\", false)\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":60,"wires":[[]]},{"id":"b81db17e.087cb","type":"switch","z":"c7dd94f4.6cfe98","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":160,"wires":[["5279e404.a7acbc"]]},{"id":"5279e404.a7acbc","type":"exec","z":"c7dd94f4.6cfe98","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1190,"y":160,"wires":[[],[],[]]},{"id":"c91634e6.a9b4c","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Lamp mode feedback","topic":"bedroom_node/lamp_mode_feedback","qos":"2","broker":"e67c6dfd.2c6b98","x":1580,"y":360,"wires":[["9d65d6ed.347e6","830182ac.a93208"]]},{"id":"1f6aec6c.bf50f4","type":"debug","z":"c7dd94f4.6cfe98","name":"Lamp mode request","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":2540,"y":440,"wires":[]},{"id":"bc4afe8e.984fc8","type":"ui_switch","z":"c7dd94f4.6cfe98","name":"Clap detection","label":"Clap detection","tooltip":"","group":"24098ce9.c81324","order":5,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"1","onvalueType":"num","onicon":"","oncolor":"","offvalue":"0","offvalueType":"num","officon":"","offcolor":"","x":2060,"y":580,"wires":[["da65482b.f1b1b8"]]},{"id":"da65482b.f1b1b8","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\n\nmsg = {payload:\n      {\n        enable_clap:msg.payload\n      }}\n     \n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":580,"wires":[["6e57cc92.a871ac"]]},{"id":"6e57cc92.a871ac","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Clap enable","topic":"bedroom_node/enable_clap","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2510,"y":580,"wires":[]},{"id":"91026b1a.9357f","type":"mqtt out","z":"2159e868.08f748","name":"Presence changed","topic":"presence_detection/presence_changed","qos":"","retain":"","broker":"e67c6dfd.2c6b98","x":1030,"y":760,"wires":[]},{"id":"e241d7d5.cc738","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Presence detection change","topic":"presence_detection/presence_changed","qos":"2","broker":"e67c6dfd.2c6b98","x":1220,"y":580,"wires":[["7b8b85d5.6f725c"]]},{"id":"7b8b85d5.6f725c","type":"function","z":"c7dd94f4.6cfe98","name":"Check presence","func":"\nvar presence_cris = global.get(\"presence_cris\");\nvar presence_raul = global.get(\"presence_raul\");\n\nif(presence_cris || presence_raul)\n{\n    msg.payload = 1;\n}\nelse\n{\n    msg.payload = 0;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1480,"y":580,"wires":[["f5d39878.16361"]]},{"id":"f5d39878.16361","type":"switch","z":"c7dd94f4.6cfe98","name":"Event at change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":1690,"y":580,"wires":[["758bbebc.b5bcc8","bf6eb6b3.b0c6d8"]]},{"id":"bf6eb6b3.b0c6d8","type":"switch","z":"c7dd94f4.6cfe98","name":"Nobody there","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":2060,"y":660,"wires":[["383a9f21.6105c8","9d65d6ed.347e6"]]},{"id":"758bbebc.b5bcc8","type":"delay","z":"c7dd94f4.6cfe98","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1880,"y":580,"wires":[["bc4afe8e.984fc8"]]},{"id":"383a9f21.6105c8","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\n\nmsg = {payload:\n      {\n        mode:0\n      }}\n     \n\nreturn msg;","outputs":1,"noerr":0,"x":2280,"y":660,"wires":[["ba2bd655.2d9ac8"]]},{"id":"ba2bd655.2d9ac8","type":"mqtt out","z":"c7dd94f4.6cfe98","name":"Lamp mode request","topic":"bedroom_node/mode_request","qos":"2","retain":"","broker":"e67c6dfd.2c6b98","x":2540,"y":660,"wires":[]},{"id":"2263cbc4.e214c4","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Exit detected","topic":"entrance_node/exit_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":250,"y":2580,"wires":[["9302ffcb.4d4ae"]]},{"id":"d8f4b8a7.dc6a8","type":"function","z":"c7dd94f4.6cfe98","name":"Create balcony open reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/bedroom_window_reminder.mp3\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":2580,"wires":[["f5dd49d1.644bf8"]]},{"id":"9302ffcb.4d4ae","type":"switch","z":"c7dd94f4.6cfe98","name":"Switch warning","property":"bedroom_window_open","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":500,"y":2580,"wires":[["aeece623.896768"]]},{"id":"aeece623.896768","type":"switch","z":"c7dd94f4.6cfe98","name":"Switch rain forecast","property":"rain_forecast","propertyType":"global","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":750,"y":2580,"wires":[["78992708.435c4"],["d8f4b8a7.dc6a8"]]},{"id":"78992708.435c4","type":"function","z":"c7dd94f4.6cfe98","name":"Create rain reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/bedroom_rain_reminder.mp3\"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":2640,"wires":[["f5dd49d1.644bf8"]]},{"id":"ade793c4.9101f8","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Rain change event","topic":"rain_detection/change_event","qos":"2","broker":"e67c6dfd.2c6b98","x":270,"y":2660,"wires":[["9302ffcb.4d4ae"]]},{"id":"4649aca2.4aa43c","type":"mqtt out","z":"b5887534.3c6f4","name":"","topic":"rain_detection/change_event","qos":"","retain":"","broker":"e67c6dfd.2c6b98","x":1070,"y":500,"wires":[]},{"id":"e9113476.afdad8","type":"switch","z":"b5887534.3c6f4","name":"Check rain > 0","property":"rain_forecast","propertyType":"global","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":760,"y":500,"wires":[["4649aca2.4aa43c"]]},{"id":"19263ede.abb789","type":"mqtt in","z":"b5887534.3c6f4","name":"Rain change event","topic":"rain_detection/change_event","qos":"2","broker":"e67c6dfd.2c6b98","x":210,"y":980,"wires":[["50a0f202.5180fc"]]},{"id":"d97b6915.8df6c8","type":"mqtt in","z":"f2d0d6f7.e3639","name":"Lamp mode req","topic":"lamp_network/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":100,"y":240,"wires":[["5fffc992.6742e"]]},{"id":"bc6ef6ed.459748","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nmsg.payload = msg.payload.mode;\n\nglobal.set(\"lamp_network_state\",msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":400,"wires":[["84450b8d.719d38"]]},{"id":"5fffc992.6742e","type":"json","z":"f2d0d6f7.e3639","name":"Json converter","property":"payload","action":"","pretty":false,"x":320,"y":240,"wires":[["fa17c517.0875a"]]},{"id":"7d9631a2.e083a8","type":"mqtt in","z":"e9df2fe6.24247","name":"Lamp mode req","topic":"terrace_node/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":160,"y":500,"wires":[["88a06d69.b47268"]]},{"id":"5361ca40.b8fdec","type":"function","z":"e9df2fe6.24247","name":"Parse message","func":"\nmsg.payload = msg.payload.mode;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":500,"wires":[["dc327176.a917b"]]},{"id":"88a06d69.b47268","type":"json","z":"e9df2fe6.24247","name":"Json converter","property":"payload","action":"","pretty":false,"x":380,"y":500,"wires":[["5361ca40.b8fdec"]]},{"id":"9d65d6ed.347e6","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nflow.set(\"mode\",msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1840,"y":360,"wires":[["74625247.2ae56c","764633a0.f75294"]]},{"id":"62bcb673.797df8","type":"ui_text","z":"8874c4d3.200988","group":"63104382.eabef4","order":0,"width":0,"height":0,"name":"Livingroom OTA URL","label":"Livingroom node ","format":"http://livingroom_node.local","layout":"row-spread","x":1460,"y":140,"wires":[]},{"id":"d211677e.6da7","type":"ui_text","z":"8874c4d3.200988","group":"63104382.eabef4","order":0,"width":0,"height":0,"name":"Entrance OTA URL","label":"Entrance node ","format":"http://entrance_node.local","layout":"row-spread","x":1450,"y":260,"wires":[]},{"id":"bd944ae7.0ea2f","type":"ui_switch","z":"f2d0d6f7.e3639","name":"Light switch","label":"Light","tooltip":"","group":"66bb6238.405dac","order":2,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":310,"y":600,"wires":[["c6143af4.b5985"]]},{"id":"85bc54bf.9b453","type":"ui_switch","z":"474b74d5.8d1c2c","name":"Light switch","label":"Light","tooltip":"","group":"f933085d.8cad7","order":2,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":1270,"y":140,"wires":[["3d3f28fc.cf1238"]]},{"id":"3d3f28fc.cf1238","type":"switch","z":"474b74d5.8d1c2c","name":"Switch","property":"payload","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"false","repair":false,"outputs":2,"x":1450,"y":140,"wires":[["f011a699.a0014"],["d4bc742c.360138"]],"outputLabels":["message.topic = ",""]},{"id":"d4bc742c.360138","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"attic_light_on","key":"dab75ed.980752","x":1660,"y":180,"wires":[]},{"id":"f011a699.a0014","type":"ifttt out","z":"474b74d5.8d1c2c","eventName":"attic_light_off","key":"dab75ed.980752","x":1660,"y":100,"wires":[]},{"id":"6aeeac7.9d02754","type":"mqtt out","z":"474b74d5.8d1c2c","name":"","topic":"attic_node/light_state","qos":"","retain":"","broker":"e67c6dfd.2c6b98","x":1970,"y":840,"wires":[]},{"id":"c1ae15ed.893f08","type":"mqtt in","z":"474b74d5.8d1c2c","name":"","topic":"attic_node/light_state","qos":"2","broker":"e67c6dfd.2c6b98","x":860,"y":140,"wires":[["ddc3d76.c72a428"]]},{"id":"bf4fc66c.82be","type":"function","z":"474b74d5.8d1c2c","name":"Create attic light command","func":"\nmsg.payload = true\n\nreturn msg;","outputs":1,"noerr":0,"x":1670,"y":840,"wires":[["6aeeac7.9d02754"]]},{"id":"a22e7a8.337aa08","type":"mqtt out","z":"474b74d5.8d1c2c","name":"","topic":"attic_node/light_state","qos":"","retain":"","broker":"e67c6dfd.2c6b98","x":1190,"y":1140,"wires":[]},{"id":"c7369d51.a54bc8","type":"function","z":"474b74d5.8d1c2c","name":"Create attic light command","func":"\nmsg.payload = false\n\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":1140,"wires":[["a22e7a8.337aa08"]]},{"id":"d879b174.ff7578","type":"switch","z":"f2d0d6f7.e3639","name":"Event on change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":500,"wires":[["84450b8d.719d38","2c1e73af.45fa14"]]},{"id":"b2442f11.bc2d38","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nif(msg.payload.mode == 1)\n{\n    msg.payload = true;\n}\nelse\n{\n    msg.payload = false;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":120,"y":500,"wires":[["bd944ae7.0ea2f"]]},{"id":"c6143af4.b5985","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nif(msg.payload)\n{\n    msg.payload = 1;\n}\nelse\n{\n    msg.payload = 0;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[["d879b174.ff7578"]]},{"id":"28da889f.149bb","type":"ui_switch","z":"c7dd94f4.6cfe98","name":"Light switch","label":"Light","tooltip":"","group":"c4f8e805.745818","order":2,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":1850,"y":520,"wires":[["3264b182.3c797e"]]},{"id":"3264b182.3c797e","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nif(msg.payload)\n{\n    msg.payload = 1;\n}\nelse\n{\n    msg.payload = 0;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1880,"y":420,"wires":[["5816bf6a.77c768"]]},{"id":"5816bf6a.77c768","type":"switch","z":"c7dd94f4.6cfe98","name":"Event on change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":2090,"y":420,"wires":[["74625247.2ae56c","11a7a26b.33e8de"]]},{"id":"e6d4f6c4.4fa838","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nif(msg.payload == 1)\n{\n    msg.payload = true;\n}\nelse\n{\n    msg.payload = false;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1660,"y":420,"wires":[["28da889f.149bb"]]},{"id":"616010d8.e845f8","type":"ui_switch","z":"890e444f.7e4898","name":"Biomull","label":"Biomull","tooltip":"","group":"1c273207.0a0e3e","order":7,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":780,"y":1540,"wires":[["913555d5.95196"]]},{"id":"15dbec35.76b48c","type":"ui_switch","z":"890e444f.7e4898","name":"Gelbe sack","label":"Gelbe sack","tooltip":"","group":"1c273207.0a0e3e","order":3,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":790,"y":1620,"wires":[["e5dc6a5.8248398"]]},{"id":"840d181.64eafe8","type":"ui_switch","z":"890e444f.7e4898","name":"Contenedor","label":"Contenedor","tooltip":"","group":"1c273207.0a0e3e","order":9,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":790,"y":1700,"wires":[["8a04eef2.995d48"]]},{"id":"a6d7444.f86c3b8","type":"ui_switch","z":"890e444f.7e4898","name":"Bajar al trastero","label":"Bajar al trastero","tooltip":"","group":"1c273207.0a0e3e","order":11,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":800,"y":1780,"wires":[["37e05ecf.d0b5ba"]]},{"id":"c12acfc9.fb2968","type":"function","z":"890e444f.7e4898","name":"Create biomull command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/biomull_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":1560,"wires":[["1dfac6c1.08a4e9"]]},{"id":"92afeba0.c916e","type":"exec","z":"890e444f.7e4898","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2810,"y":1840,"wires":[[],[],[]]},{"id":"e9e230e0.c4b508","type":"function","z":"890e444f.7e4898","name":"Create gelbe sack command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/gelbe_sack_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2180,"y":1640,"wires":[["1dfac6c1.08a4e9"]]},{"id":"a7355ee7.1eac78","type":"function","z":"890e444f.7e4898","name":"Create contenedor command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/contenedor_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2180,"y":1720,"wires":[["1dfac6c1.08a4e9"]]},{"id":"30452ed0.39ce02","type":"function","z":"890e444f.7e4898","name":"Create trastero command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/keller_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":1800,"wires":[["1dfac6c1.08a4e9"]]},{"id":"f5ede48c.7449e8","type":"ui_switch","z":"890e444f.7e4898","name":"Personalizado","label":"Personalizado","tooltip":"","group":"1c273207.0a0e3e","order":21,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":660,"y":2300,"wires":[["261fb024.76d3c"]]},{"id":"2d035aaf.245fbe","type":"ui_text_input","z":"890e444f.7e4898","name":"","label":"Recordatorio personalizado: ","tooltip":"","group":"1c273207.0a0e3e","order":23,"width":"12","height":"1","passthru":true,"mode":"text","delay":"0","topic":"","x":620,"y":2360,"wires":[["c9a36f44.6d07a8"]]},{"id":"913555d5.95196","type":"function","z":"890e444f.7e4898","name":"Set biomull","func":"\nflow.set(\"biomull\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1540,"wires":[[]]},{"id":"e5dc6a5.8248398","type":"function","z":"890e444f.7e4898","name":"Set gelbe sack","func":"\nflow.set(\"gelbe_sack\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":1620,"wires":[[]]},{"id":"8a04eef2.995d48","type":"function","z":"890e444f.7e4898","name":"Set contenedor","func":"\nflow.set(\"contenedor\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":1700,"wires":[[]]},{"id":"37e05ecf.d0b5ba","type":"function","z":"890e444f.7e4898","name":"Set trastero","func":"\nflow.set(\"trastero\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1780,"wires":[[]]},{"id":"261fb024.76d3c","type":"function","z":"890e444f.7e4898","name":"Set reminder","func":"\nflow.set(\"personalizado\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":2300,"wires":[[]]},{"id":"c9a36f44.6d07a8","type":"function","z":"890e444f.7e4898","name":"Set reminder","func":"\nvar command = \"\"\ncommand += \"-d -f /home/pi/Projects/audio_node/sounds/custom_reminder.mp3 -t \"\ncommand += \"\\\"Recuerda: \"\ncommand += msg.payload\ncommand += \" \\\"\"\n\nmsg.payload = command\n\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":2360,"wires":[["30cc520.798432e"]]},{"id":"b4ab1015.606cc8","type":"switch","z":"890e444f.7e4898","name":"Check biomull","property":"biomull","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1600,"y":1560,"wires":[["e31c85a2.c77c98"]]},{"id":"ce611fd5.3f2bc","type":"mqtt in","z":"890e444f.7e4898","name":"Exit detected","topic":"entrance_node/exit_detected","qos":"2","broker":"e67c6dfd.2c6b98","x":1370,"y":1680,"wires":[["b4ab1015.606cc8","66508c36.f7c84c","a5e1b61e.22cb28","5d96b4e3.4222cc","a5ae2a4c.d970f","7a73ef3c.1bdaf8","56faeea8.c925a","197a515c.b20157","8e2f87d3.846838","73bbd84d.05215","97ad89fa.c77d08"]]},{"id":"66508c36.f7c84c","type":"switch","z":"890e444f.7e4898","name":"Check gelbe sack","property":"gelbe_sack","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1610,"y":1640,"wires":[["fe161a02.d9a008"]]},{"id":"a5e1b61e.22cb28","type":"switch","z":"890e444f.7e4898","name":"Check contenedor","property":"contenedor","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1610,"y":1720,"wires":[["86a31838.3d3498"]]},{"id":"5d96b4e3.4222cc","type":"switch","z":"890e444f.7e4898","name":"Check trastero","property":"trastero","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1600,"y":1800,"wires":[["4aaacaad.63a5a4"]]},{"id":"a5ae2a4c.d970f","type":"switch","z":"890e444f.7e4898","name":"Check reminder","property":"personalizado","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1600,"y":1920,"wires":[["e7168a31.cbc8a8"]]},{"id":"f6f771df.091a88","type":"function","z":"890e444f.7e4898","name":"Create custom reminder","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/custom_reminder.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":1920,"wires":[["1dfac6c1.08a4e9"]]},{"id":"1a9dade3.155282","type":"ui_switch","z":"890e444f.7e4898","name":"Bajar el cartÃ³n","label":"Bajar el cartÃ³n","tooltip":"","group":"1c273207.0a0e3e","order":13,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":800,"y":1860,"wires":[["f373f612.116ad8"]]},{"id":"f373f612.116ad8","type":"function","z":"890e444f.7e4898","name":"Set carton","func":"\nflow.set(\"carton\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1860,"wires":[[]]},{"id":"72eba3f.51c4d5c","type":"ui_switch","z":"890e444f.7e4898","name":"Bajar la basura normal","label":"Bajar la basura normal","tooltip":"","group":"1c273207.0a0e3e","order":15,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":820,"y":1940,"wires":[["fd2acd3f.c5e78"]]},{"id":"fd2acd3f.c5e78","type":"function","z":"890e444f.7e4898","name":"Set basura ","func":"\nflow.set(\"basura\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1940,"wires":[[]]},{"id":"d6f69e68.05d92","type":"function","z":"890e444f.7e4898","name":"Create carton command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/carton_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":2040,"wires":[["1dfac6c1.08a4e9"]]},{"id":"7a73ef3c.1bdaf8","type":"switch","z":"890e444f.7e4898","name":"Check carton","property":"carton","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1590,"y":2040,"wires":[["25f79afb.f23a36"]]},{"id":"6f3bfbad.062914","type":"function","z":"890e444f.7e4898","name":"Create basura command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/basura_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":2100,"wires":[["1dfac6c1.08a4e9"]]},{"id":"56faeea8.c925a","type":"switch","z":"890e444f.7e4898","name":"Check basura","property":"basura","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1590,"y":2100,"wires":[["cb3115cc.889fa8"]]},{"id":"3f5397a6.938e38","type":"ui_button","z":"890e444f.7e4898","name":"All ON","group":"1c273207.0a0e3e","order":1,"width":"6","height":"1","passthru":false,"label":"All ON","tooltip":"","color":"","bgcolor":"","icon":"","payload":"true","payloadType":"bool","topic":"","x":450,"y":1580,"wires":[["616010d8.e845f8","15dbec35.76b48c","840d181.64eafe8","a6d7444.f86c3b8","1a9dade3.155282","72eba3f.51c4d5c","f5ede48c.7449e8","30355bd4.bee8dc","824e9ff3.dfdc68","530ff282.4f331c"]]},{"id":"11d3a8e4.95154f","type":"ui_button","z":"890e444f.7e4898","name":"All OFF","group":"1c273207.0a0e3e","order":2,"width":"6","height":"1","passthru":true,"label":"All OFF","tooltip":"","color":"","bgcolor":"","icon":"","payload":"false","payloadType":"bool","topic":"","x":460,"y":1640,"wires":[["616010d8.e845f8","15dbec35.76b48c","840d181.64eafe8","a6d7444.f86c3b8","1a9dade3.155282","72eba3f.51c4d5c","f5ede48c.7449e8","30355bd4.bee8dc","824e9ff3.dfdc68","530ff282.4f331c"]]},{"id":"1bf06d6.436ec13","type":"inject","z":"890e444f.7e4898","name":"Trigger on Thursdays","topic":"","payload":"true","payloadType":"bool","repeat":"","crontab":"00 18 * * 4","once":false,"onceDelay":0.1,"x":440,"y":1760,"wires":[["840d181.64eafe8"]]},{"id":"de1e9e81.05d42","type":"ui_button","z":"890e444f.7e4898","name":"Delete","group":"1c273207.0a0e3e","order":24,"width":"12","height":"1","passthru":false,"label":"Delete","tooltip":"","color":"","bgcolor":"","icon":"","payload":" ","payloadType":"str","topic":"","x":390,"y":2360,"wires":[["2d035aaf.245fbe"]]},{"id":"30355bd4.bee8dc","type":"ui_switch","z":"890e444f.7e4898","name":"Recoger lavadora","label":"Recoger lavadora","tooltip":"","group":"1c273207.0a0e3e","order":17,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":810,"y":2020,"wires":[["117e9267.e3210e"]]},{"id":"117e9267.e3210e","type":"function","z":"890e444f.7e4898","name":"Set pick laundry","func":"flow.set(\"pick_laundry\",msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":2020,"wires":[[]]},{"id":"197a515c.b20157","type":"switch","z":"890e444f.7e4898","name":"Check pick laundry","property":"pick_laundry","propertyType":"flow","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":1610,"y":2180,"wires":[["bf82a764.703368"]]},{"id":"f33b6864.21599","type":"function","z":"890e444f.7e4898","name":"Create pick laundry command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/washmachine_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2180,"y":2180,"wires":[["1dfac6c1.08a4e9"]]},{"id":"8a56e361.a646f","type":"function","z":"890e444f.7e4898","name":"Set true payload","func":"msg.payload = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":2020,"wires":[["30355bd4.bee8dc"]]},{"id":"59e1ae7f.6f3098","type":"mqtt in","z":"890e444f.7e4898","name":"Washmachine finished","topic":"washmachine_node/finished","qos":"2","broker":"e67c6dfd.2c6b98","x":360,"y":2020,"wires":[["8a56e361.a646f"]]},{"id":"1dfac6c1.08a4e9","type":"switch","z":"890e444f.7e4898","name":"Check silent","property":"silent_mode","propertyType":"global","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":2490,"y":1840,"wires":[["92afeba0.c916e"]]},{"id":"30cc520.798432e","type":"exec","z":"890e444f.7e4898","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1190,"y":2360,"wires":[[],[],[]]},{"id":"824e9ff3.dfdc68","type":"ui_switch","z":"890e444f.7e4898","name":"Roomba","label":"Roomba","tooltip":"","group":"1c273207.0a0e3e","order":5,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":780,"y":1460,"wires":[["fa9eba46.3b717"]]},{"id":"fa9eba46.3b717","type":"function","z":"890e444f.7e4898","name":"Set roomba","func":"\nflow.set(\"roomba\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1460,"wires":[[]]},{"id":"8e2f87d3.846838","type":"switch","z":"890e444f.7e4898","name":"Check roomba","property":"roomba","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1600,"y":1480,"wires":[["567ffe9e.a4dd4"]]},{"id":"3033521f.fbd8a6","type":"function","z":"890e444f.7e4898","name":"Create roomba command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/roomba_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2170,"y":1480,"wires":[["1dfac6c1.08a4e9"]]},{"id":"94559c81.476b68","type":"function","z":"890e444f.7e4898","name":"Create heating reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_heating_reminder.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":2260,"wires":[["1dfac6c1.08a4e9"]]},{"id":"73bbd84d.05215","type":"switch","z":"890e444f.7e4898","name":"Check heating","property":"attic_heating","propertyType":"global","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":1600,"y":2260,"wires":[["94559c81.476b68"]]},{"id":"403d378.6fc6648","type":"debug","z":"474b74d5.8d1c2c","name":"Attic node: light state","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1320,"y":220,"wires":[]},{"id":"ddc3d76.c72a428","type":"json","z":"474b74d5.8d1c2c","name":"Json converter","property":"payload","action":"","pretty":false,"x":1080,"y":140,"wires":[["85bc54bf.9b453","403d378.6fc6648"]]},{"id":"a73f41db.0ff94","type":"ui_text","z":"8874c4d3.200988","group":"63104382.eabef4","order":0,"width":0,"height":0,"name":"Attic OTA URL","label":"Attic node ","format":"http://attic_node.local","layout":"row-spread","x":1440,"y":200,"wires":[]},{"id":"830182ac.a93208","type":"debug","z":"c7dd94f4.6cfe98","name":"Lamp mode request","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1800,"y":280,"wires":[]},{"id":"764633a0.f75294","type":"switch","z":"c7dd94f4.6cfe98","name":"Filter ON/OFF event","property":"payload","propertyType":"msg","rules":[{"t":"lt","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1460,"y":420,"wires":[["e6d4f6c4.4fa838"]]},{"id":"fa17c517.0875a","type":"switch","z":"f2d0d6f7.e3639","name":"Event on change","property":"payload.id_mask","propertyType":"msg","rules":[{"t":"eq","v":"255","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":240,"wires":[["bc6ef6ed.459748","b2442f11.bc2d38"]]},{"id":"1287cc4e.79a33c","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":4,"width":0,"height":0,"name":"","label":"Number of desconnections","format":"{{msg.payload}}","layout":"row-spread","x":2840,"y":1300,"wires":[]},{"id":"6b6aa2db.41fe5c","type":"switch","z":"c7dd94f4.6cfe98","name":"","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":2430,"y":1300,"wires":[["63994256.6d26fc"]]},{"id":"63994256.6d26fc","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"var num_desconnect = flow.get(\"num_desconnect\");\n\nmsg.payload = num_desconnect;\n\nnum_desconnect++;\n\nflow.set(\"num_desconnect\",num_desconnect)\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2600,"y":1300,"wires":[["1287cc4e.79a33c"]]},{"id":"85c5d0e6.a50038","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":4,"width":0,"height":0,"name":"","label":"Connection time","format":"{{msg.payload}}","layout":"row-spread","x":2800,"y":1380,"wires":[]},{"id":"42b3adc3.97f68c","type":"switch","z":"c7dd94f4.6cfe98","name":"","property":"connect_time","propertyType":"flow","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":2430,"y":1380,"wires":[["c1430d19.2c2d2"]]},{"id":"c1430d19.2c2d2","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"var connect_time = flow.get(\"connect_time\");\n\nmsg.payload = connect_time;\n\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2600,"y":1380,"wires":[["85c5d0e6.a50038"]]},{"id":"1760cd98.b6cd0a","type":"ui_text","z":"c7dd94f4.6cfe98","group":"f194e702.838568","order":4,"width":0,"height":0,"name":"","label":"Disconnection time","format":"{{msg.payload}}","layout":"row-spread","x":2810,"y":1440,"wires":[]},{"id":"9ee5cb48.26eed","type":"switch","z":"c7dd94f4.6cfe98","name":"","property":"disconnect_time","propertyType":"flow","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":2430,"y":1440,"wires":[["7a34a805.4e5c2"]]},{"id":"7a34a805.4e5c2","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"var disconnect_time = flow.get(\"disconnect_time\");\n\nmsg.payload = disconnect_time;\n\nreturn msg;","outputs":1,"noerr":0,"x":2600,"y":1440,"wires":[["1760cd98.b6cd0a"]]},{"id":"df14cfee.763f3","type":"ui_chart","z":"c7dd94f4.6cfe98","name":"Connection status","group":"9bf50add.2132b8","order":2,"width":"12","height":"7","label":"Connection status","chartType":"line","legend":"true","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"2","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":2750,"y":1140,"wires":[[],[]]},{"id":"dc80717c.6c044","type":"ui_chart","z":"f2d0d6f7.e3639","name":"Connection status","group":"7f57cfa9.8614c","order":2,"width":"12","height":"7","label":"Connection status","chartType":"line","legend":"true","xformat":"HH:mm:ss","interpolate":"linear","nodata":"","dot":false,"ymin":"0","ymax":"2","removeOlder":1,"removeOlderPoints":"","removeOlderUnit":"86400","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":1170,"y":1260,"wires":[[],[]]},{"id":"9fad3ffc.08781","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"msg = {topic: \"LAMP\",\n       payload: msg.payload\n    }\nreturn msg;","outputs":1,"noerr":0,"x":2480,"y":1140,"wires":[["df14cfee.763f3"]]},{"id":"d8c9979.3ae6468","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\n\nmsg = {topic: \"LAMP_1\",\n       payload: msg.payload\n    }\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":1100,"wires":[["dc80717c.6c044"]]},{"id":"2e7b1c0a.ab0554","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"msg = {topic: \"LIVINGROOM_1\",\n       payload: msg.payload\n    }\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":1260,"wires":[["dc80717c.6c044"]]},{"id":"2c4c1a4b.2c59c6","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"msg = {topic: \"LIVINGROOM_2\",\n       payload: msg.payload\n    }\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":1340,"wires":[["dc80717c.6c044"]]},{"id":"2eba6c3c.014064","type":"mqtt in","z":"c7dd94f4.6cfe98","name":"Lamp mode req","topic":"bedroom_node/mode_request","qos":"2","broker":"e67c6dfd.2c6b98","x":1140,"y":280,"wires":[["68275378.d6a3ec"]]},{"id":"7a6b4761.ba7cb8","type":"function","z":"c7dd94f4.6cfe98","name":"Parse message","func":"\nmsg.payload = msg.payload.mode;\n\nreturn msg;","outputs":1,"noerr":0,"x":1580,"y":280,"wires":[["830182ac.a93208","9d65d6ed.347e6"]]},{"id":"68275378.d6a3ec","type":"json","z":"c7dd94f4.6cfe98","name":"Json converter","property":"payload","action":"","pretty":false,"x":1360,"y":280,"wires":[["7a6b4761.ba7cb8"]]},{"id":"567ffe9e.a4dd4","type":"switch","z":"890e444f.7e4898","name":"Check roomba exit enabled","property":"roomba_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":1480,"wires":[["3033521f.fbd8a6"]]},{"id":"e31c85a2.c77c98","type":"switch","z":"890e444f.7e4898","name":"Check biomull exit enabled","property":"biomull_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":1560,"wires":[["c12acfc9.fb2968"]]},{"id":"fe161a02.d9a008","type":"switch","z":"890e444f.7e4898","name":"Check gelbe sack exit enabled","property":"gelbe_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1890,"y":1640,"wires":[["e9e230e0.c4b508"]]},{"id":"86a31838.3d3498","type":"switch","z":"890e444f.7e4898","name":"Check contenedor exit enabled","property":"contenedor_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1890,"y":1720,"wires":[["a7355ee7.1eac78"]]},{"id":"4aaacaad.63a5a4","type":"switch","z":"890e444f.7e4898","name":"Check trastero exit enabled","property":"trastero_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":1800,"wires":[["30452ed0.39ce02"]]},{"id":"e7168a31.cbc8a8","type":"switch","z":"890e444f.7e4898","name":"Check reminder exit enabled","property":"personalizado_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":1920,"wires":[["f6f771df.091a88"]]},{"id":"25f79afb.f23a36","type":"switch","z":"890e444f.7e4898","name":"Check carton exit enabled","property":"carton_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":2040,"wires":[["d6f69e68.05d92"]]},{"id":"cb3115cc.889fa8","type":"switch","z":"890e444f.7e4898","name":"Check basura exit enabled","property":"basura_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":2100,"wires":[["6f3bfbad.062914"]]},{"id":"bf82a764.703368","type":"switch","z":"890e444f.7e4898","name":"Check laundry exit enabled","property":"laundry_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1880,"y":2180,"wires":[["f33b6864.21599"]]},{"id":"97ad89fa.c77d08","type":"switch","z":"890e444f.7e4898","name":"Check lavaplatos","property":"lavaplatos","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1610,"y":2340,"wires":[["21cb2137.b84bbe"]]},{"id":"2d0bfee1.4756f2","type":"function","z":"890e444f.7e4898","name":"Create lavaplatos command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/dishwasher_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":2340,"wires":[["1dfac6c1.08a4e9"]]},{"id":"21cb2137.b84bbe","type":"switch","z":"890e444f.7e4898","name":"Check lavaplatos exit enabled","property":"lavaplatos_exit_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1890,"y":2340,"wires":[["2d0bfee1.4756f2"]]},{"id":"1276a83e.5a6c58","type":"function","z":"890e444f.7e4898","name":"Create biomull command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/biomull_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":280,"wires":[["4afe6369.8a409c"]]},{"id":"9f410b5a.59f608","type":"exec","z":"890e444f.7e4898","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":2990,"y":560,"wires":[[],[],[]]},{"id":"c7ffd895.c87ab8","type":"function","z":"890e444f.7e4898","name":"Create gelbe sack command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/gelbe_sack_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":360,"wires":[["4afe6369.8a409c"]]},{"id":"3f208acf.fdca46","type":"function","z":"890e444f.7e4898","name":"Create contenedor command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/contenedor_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":440,"wires":[["4afe6369.8a409c"]]},{"id":"759ba00.05d5c6","type":"function","z":"890e444f.7e4898","name":"Create trastero command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/keller_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":520,"wires":[["4afe6369.8a409c"]]},{"id":"db21f9c6.d68b98","type":"switch","z":"890e444f.7e4898","name":"Check biomull","property":"biomull","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1560,"y":280,"wires":[["a891180.89ad2e8"]]},{"id":"b2c1dcdd.c123f","type":"mqtt in","z":"890e444f.7e4898","name":"Goodnight event","topic":"reminder_node/goodnight","qos":"2","broker":"e67c6dfd.2c6b98","x":1240,"y":420,"wires":[["db21f9c6.d68b98","ba393fa7.f8238","267dd65d.e3e50a","b5457652.4e5d88","97a60809.a61d58","b215398e.9944f8","b931848b.01ed98","4dd42d75.eb6954","5b766c4a.3107e4","319ed384.5d6dfc","62846f28.93112","e10eabbe.cf1ff8","7ed2cb64.c6c3e4","eeadd830.e6e9d8"]]},{"id":"ba393fa7.f8238","type":"switch","z":"890e444f.7e4898","name":"Check gelbe sack","property":"gelbe_sack","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1570,"y":360,"wires":[["90e7143d.d69b48"]]},{"id":"267dd65d.e3e50a","type":"switch","z":"890e444f.7e4898","name":"Check contenedor","property":"contenedor","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1570,"y":440,"wires":[["c7cd24bb.7f0ca8"]]},{"id":"b5457652.4e5d88","type":"switch","z":"890e444f.7e4898","name":"Check trastero","property":"trastero","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1560,"y":520,"wires":[["3add5adc.b3a696"]]},{"id":"97a60809.a61d58","type":"switch","z":"890e444f.7e4898","name":"Check reminder","property":"personalizado","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1560,"y":640,"wires":[["69827f29.bb7d1"]]},{"id":"d3ff5de2.64667","type":"function","z":"890e444f.7e4898","name":"Create custom reminder","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/custom_reminder.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":640,"wires":[["4afe6369.8a409c"]]},{"id":"a6cff3c5.86387","type":"function","z":"890e444f.7e4898","name":"Create carton command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/carton_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":760,"wires":[["4afe6369.8a409c"]]},{"id":"b215398e.9944f8","type":"switch","z":"890e444f.7e4898","name":"Check carton","property":"carton","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1550,"y":760,"wires":[["7cc66c5f.b5f9c4"]]},{"id":"4e794cb5.f8a024","type":"function","z":"890e444f.7e4898","name":"Create basura command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/basura_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":820,"wires":[["4afe6369.8a409c"]]},{"id":"b931848b.01ed98","type":"switch","z":"890e444f.7e4898","name":"Check basura","property":"basura","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1550,"y":820,"wires":[["bbd8795d.7ce8a8"]]},{"id":"4dd42d75.eb6954","type":"switch","z":"890e444f.7e4898","name":"Check pick laundry","property":"pick_laundry","propertyType":"flow","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":1570,"y":900,"wires":[["3cc151f8.818d4e"]]},{"id":"851be0e4.774b1","type":"function","z":"890e444f.7e4898","name":"Create pick laundry command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/washmachine_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2200,"y":900,"wires":[["4afe6369.8a409c"]]},{"id":"5b766c4a.3107e4","type":"switch","z":"890e444f.7e4898","name":"Check roomba","property":"roomba","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1560,"y":200,"wires":[["84dd8359.a619c"]]},{"id":"e98f1290.bbb57","type":"function","z":"890e444f.7e4898","name":"Create roomba command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/roomba_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2190,"y":200,"wires":[["4afe6369.8a409c"]]},{"id":"19d63f57.445b51","type":"function","z":"890e444f.7e4898","name":"Create heating reminder command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/attic_heating_reminder.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":2220,"y":980,"wires":[["4afe6369.8a409c"]]},{"id":"319ed384.5d6dfc","type":"switch","z":"890e444f.7e4898","name":"Check heating","property":"attic_heating","propertyType":"global","rules":[{"t":"true"}],"checkall":"false","repair":false,"outputs":1,"x":1560,"y":980,"wires":[["19d63f57.445b51"]]},{"id":"84dd8359.a619c","type":"switch","z":"890e444f.7e4898","name":"Check roomba goodnight enabled","property":"roomba_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":200,"wires":[["e98f1290.bbb57"]]},{"id":"a891180.89ad2e8","type":"switch","z":"890e444f.7e4898","name":"Check biomull goodnight enabled","property":"biomull_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":280,"wires":[["1276a83e.5a6c58"]]},{"id":"90e7143d.d69b48","type":"switch","z":"890e444f.7e4898","name":"Check gelbe sack goodnight enabled","property":"gelbe_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1870,"y":360,"wires":[["c7ffd895.c87ab8"]]},{"id":"c7cd24bb.7f0ca8","type":"switch","z":"890e444f.7e4898","name":"Check contenedor goodnight enabled","property":"contenedor_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1870,"y":440,"wires":[["3f208acf.fdca46"]]},{"id":"3add5adc.b3a696","type":"switch","z":"890e444f.7e4898","name":"Check trastero goodnight enabled","property":"trastero_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":520,"wires":[["759ba00.05d5c6"]]},{"id":"69827f29.bb7d1","type":"switch","z":"890e444f.7e4898","name":"Check reminder goodnight enabled","property":"personalizado_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":640,"wires":[["d3ff5de2.64667"]]},{"id":"7cc66c5f.b5f9c4","type":"switch","z":"890e444f.7e4898","name":"Check carton goodnight enabled","property":"carton_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":760,"wires":[["a6cff3c5.86387"]]},{"id":"bbd8795d.7ce8a8","type":"switch","z":"890e444f.7e4898","name":"Check basura goodnight enabled","property":"basura_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":820,"wires":[["4e794cb5.f8a024"]]},{"id":"3cc151f8.818d4e","type":"switch","z":"890e444f.7e4898","name":"Check laundry goodnight enabled","property":"laundry_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":900,"wires":[["851be0e4.774b1"]]},{"id":"62846f28.93112","type":"switch","z":"890e444f.7e4898","name":"Check lavaplatos","property":"lavaplatos","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1570,"y":1060,"wires":[["a52ffb88.19cd18"]]},{"id":"474d957.9a65e6c","type":"function","z":"890e444f.7e4898","name":"Create lavaplatos command","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/dishwasher_reminder.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":2220,"y":1060,"wires":[["4afe6369.8a409c"]]},{"id":"a52ffb88.19cd18","type":"switch","z":"890e444f.7e4898","name":"Check lavaplatos goodnight enabled","property":"lavaplatos_goodnight_enabled","propertyType":"flow","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1870,"y":1060,"wires":[["474d957.9a65e6c"]]},{"id":"530ff282.4f331c","type":"ui_switch","z":"890e444f.7e4898","name":"Lavaplatos","label":"Lavaplatos","tooltip":"","group":"1c273207.0a0e3e","order":19,"width":"8","height":"1","passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":790,"y":2080,"wires":[["1125bce6.0c0153"]]},{"id":"1125bce6.0c0153","type":"function","z":"890e444f.7e4898","name":"Set lavaplatos","func":"\nflow.set(\"lavaplatos\",msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":2080,"wires":[[]]},{"id":"bdebacee.dc9ff","type":"function","z":"890e444f.7e4898","name":"Set biomull","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"biomull_exit_enabled\",false);\n    flow.set(\"biomull_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"biomull_exit_enabled\",true);\n    flow.set(\"biomull_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"biomull_exit_enabled\",false);\n    flow.set(\"biomull_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"biomull_exit_enabled\",true);\n    flow.set(\"biomull_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":810,"y":340,"wires":[[]]},{"id":"f95cc4ac.9ebec8","type":"function","z":"890e444f.7e4898","name":"Set gelbe sack","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"gelbe_exit_enabled\",false);\n    flow.set(\"gelbe_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"gelbe_exit_enabled\",true);\n    flow.set(\"gelbe_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"gelbe_exit_enabled\",false);\n    flow.set(\"gelbe_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"gelbe_exit_enabled\",true);\n    flow.set(\"gelbe_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":820,"y":420,"wires":[[]]},{"id":"efa75356.308b9","type":"function","z":"890e444f.7e4898","name":"Set contenedor","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"contenedor_exit_enabled\",false);\n    flow.set(\"contenedor_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"contenedor_exit_enabled\",true);\n    flow.set(\"contenedor_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"contenedor_exit_enabled\",false);\n    flow.set(\"contenedor_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"contenedor_exit_enabled\",true);\n    flow.set(\"contenedor_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":820,"y":500,"wires":[[]]},{"id":"b0e1cd4c.83c21","type":"function","z":"890e444f.7e4898","name":"Set trastero","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"trastero_exit_enabled\",false);\n    flow.set(\"trastero_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"trastero_exit_enabled\",true);\n    flow.set(\"trastero_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"trastero_exit_enabled\",false);\n    flow.set(\"trastero_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"trastero_exit_enabled\",true);\n    flow.set(\"trastero_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":810,"y":580,"wires":[[]]},{"id":"b9fd1b4c.7dfb58","type":"function","z":"890e444f.7e4898","name":"Set carton","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"carton_exit_enabled\",false);\n    flow.set(\"carton_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"carton_exit_enabled\",true);\n    flow.set(\"carton_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"carton_exit_enabled\",false);\n    flow.set(\"carton_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"carton_exit_enabled\",true);\n    flow.set(\"carton_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":810,"y":660,"wires":[[]]},{"id":"474ca7a.2aa3c58","type":"function","z":"890e444f.7e4898","name":"Set basura ","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"basura_exit_enabled\",false);\n    flow.set(\"basura_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"basura_exit_enabled\",true);\n    flow.set(\"basura_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"basura_exit_enabled\",false);\n    flow.set(\"basura_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"basura_exit_enabled\",true);\n    flow.set(\"basura_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":810,"y":740,"wires":[[]]},{"id":"bd99585.89fd8a8","type":"function","z":"890e444f.7e4898","name":"Set pick laundry","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"laundry_exit_enabled\",false);\n    flow.set(\"laundry_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"laundry_exit_enabled\",true);\n    flow.set(\"laundry_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"laundry_exit_enabled\",false);\n    flow.set(\"laundry_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"laundry_exit_enabled\",true);\n    flow.set(\"laundry_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":820,"y":820,"wires":[[]]},{"id":"db89a26b.8c3f7","type":"function","z":"890e444f.7e4898","name":"Set roomba","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"roomba_exit_enabled\",false);\n    flow.set(\"roomba_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"roomba_exit_enabled\",true);\n    flow.set(\"roomba_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"roomba_exit_enabled\",false);\n    flow.set(\"roomba_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"roomba_exit_enabled\",true);\n    flow.set(\"roomba_goodnight_enabled\",true);\n}\n\n\n\n","outputs":1,"noerr":0,"x":810,"y":260,"wires":[[]]},{"id":"d7270a08.c15c68","type":"function","z":"890e444f.7e4898","name":"Set lavaplatos","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"lavaplatos_exit_enabled\",false);\n    flow.set(\"lavaplatos_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"lavaplatos_exit_enabled\",true);\n    flow.set(\"lavaplatos_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"lavaplatos_exit_enabled\",false);\n    flow.set(\"lavaplatos_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"lavaplatos_exit_enabled\",true);\n    flow.set(\"lavaplatos_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":820,"y":900,"wires":[[]]},{"id":"1f09f424.a3015c","type":"ui_dropdown","z":"890e444f.7e4898","name":"Roomba mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":6,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":620,"y":260,"wires":[["db89a26b.8c3f7"]]},{"id":"65c1acf3.ac7b84","type":"ui_dropdown","z":"890e444f.7e4898","name":"Biomull mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":8,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":620,"y":340,"wires":[["bdebacee.dc9ff"]]},{"id":"3547c6e0.7cbbca","type":"ui_dropdown","z":"890e444f.7e4898","name":"Gelbe sack mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":4,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":630,"y":420,"wires":[["f95cc4ac.9ebec8"]]},{"id":"36ef0cc7.b5ced4","type":"ui_dropdown","z":"890e444f.7e4898","name":"Contenedor mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":10,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":630,"y":500,"wires":[["efa75356.308b9"]]},{"id":"d74d5b42.a98658","type":"ui_dropdown","z":"890e444f.7e4898","name":"Trastero mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":12,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":620,"y":580,"wires":[["b0e1cd4c.83c21"]]},{"id":"6442230c.5bc6ac","type":"ui_dropdown","z":"890e444f.7e4898","name":"Carton mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":14,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":610,"y":660,"wires":[["b9fd1b4c.7dfb58"]]},{"id":"49663df5.88d204","type":"ui_dropdown","z":"890e444f.7e4898","name":"Basura mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":16,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":610,"y":740,"wires":[["474ca7a.2aa3c58"]]},{"id":"1c85b.4b7e77a5b","type":"ui_dropdown","z":"890e444f.7e4898","name":"Laundry mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":18,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":620,"y":820,"wires":[["bd99585.89fd8a8"]]},{"id":"ef58334c.906c7","type":"ui_dropdown","z":"890e444f.7e4898","name":"Lavaplatos mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":20,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":610,"y":900,"wires":[["d7270a08.c15c68"]]},{"id":"35fd2dcb.aee0f2","type":"function","z":"890e444f.7e4898","name":"Set personalizado","func":"\nif(msg.payload == 0)\n{\n    flow.set(\"personalizado_exit_enabled\",false);\n    flow.set(\"personalizado_goodnight_enabled\",false);\n}\nelse if(msg.payload == 1)\n{\n    flow.set(\"personalizado_exit_enabled\",true);\n    flow.set(\"personalizado_goodnight_enabled\",false);\n}\nelse if(msg.payload == 2)\n{\n    flow.set(\"personalizado_exit_enabled\",false);\n    flow.set(\"personalizado_goodnight_enabled\",true);\n}\nelse if(msg.payload == 3)\n{\n    flow.set(\"personalizado_exit_enabled\",true);\n    flow.set(\"personalizado_goodnight_enabled\",true);\n}\n","outputs":1,"noerr":0,"x":830,"y":980,"wires":[[]]},{"id":"a56be079.4fdea","type":"ui_dropdown","z":"890e444f.7e4898","name":"Personaliazdo mode","label":"","tooltip":"","place":"Select option","group":"1c273207.0a0e3e","order":22,"width":"4","height":"1","passthru":true,"options":[{"label":"NONE","value":0,"type":"num"},{"label":"GOOD BYE","value":1,"type":"num"},{"label":"GOOD NIGHT","value":2,"type":"num"},{"label":"ALL","value":3,"type":"num"}],"payload":"","topic":"","x":620,"y":980,"wires":[["35fd2dcb.aee0f2"]]},{"id":"e10eabbe.cf1ff8","type":"debug","z":"890e444f.7e4898","name":"Goodnight event","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1210,"y":280,"wires":[]},{"id":"7ed2cb64.c6c3e4","type":"function","z":"890e444f.7e4898","name":"Goodnight reminder start","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/goodnight_start.mp3 \"\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1590,"y":140,"wires":[["9f410b5a.59f608"]]},{"id":"4afe6369.8a409c","type":"delay","z":"890e444f.7e4898","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2650,"y":560,"wires":[["9f410b5a.59f608"]]},{"id":"b2d4ea04.3dbec","type":"mqtt in","z":"b5887534.3c6f4","name":"Goodnight event","topic":"reminder_node/goodnight","qos":"2","broker":"e67c6dfd.2c6b98","x":160,"y":1060,"wires":[["8fd86436.57bbe8"]]},{"id":"8fd86436.57bbe8","type":"delay","z":"b5887534.3c6f4","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":340,"y":1060,"wires":[["50a0f202.5180fc"]]},{"id":"6b99cfa8.3ff53","type":"inject","z":"474b74d5.8d1c2c","name":"Initial set","topic":"","payload":"false","payloadType":"bool","repeat":"","crontab":"","once":true,"onceDelay":"0.1","x":280,"y":2460,"wires":[["17daefb2.179eb"]]},{"id":"eeadd830.e6e9d8","type":"function","z":"890e444f.7e4898","name":"Goodnight reminder start","func":"\nmsg.payload = \" -f /home/pi/Projects/audio_node/sounds/goodnight_end.mp3 \"\n\nreturn msg;","outputs":1,"noerr":0,"x":1590,"y":80,"wires":[["3084b2e6.bfdf4e"]]},{"id":"3084b2e6.bfdf4e","type":"delay","z":"890e444f.7e4898","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":2020,"y":80,"wires":[["9f410b5a.59f608"]]},{"id":"7532ba4e.b97b24","type":"mqtt in","z":"890e444f.7e4898","name":"Disable reminders","topic":"reminder_node/disableAll","qos":"2","broker":"e67c6dfd.2c6b98","x":90,"y":1640,"wires":[["c64fe15e.31a3e"]]},{"id":"c64fe15e.31a3e","type":"function","z":"890e444f.7e4898","name":"Set false payload","func":"msg.payload = false;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":1640,"wires":[["11d3a8e4.95154f"]]},{"id":"ab349f29.61c71","type":"inject","z":"f2d0d6f7.e3639","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":250,"y":1500,"wires":[["ecfcc492.3a1288"]]},{"id":"ecfcc492.3a1288","type":"function","z":"f2d0d6f7.e3639","name":"Parse message","func":"\nvar lamp_online = [0,0,0,0];\nflow.set(\"lamp_online\",lamp_online);\n\nflow.set(\"alive_time\",30000);\n","outputs":1,"noerr":0,"x":480,"y":1500,"wires":[[]]},{"id":"d3cf2332.21fe28","type":"debug","z":"2159e868.08f748","name":"Presence detector: Guest presence msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":680,"y":220,"wires":[]},{"id":"1cd56a09.5fc92e","type":"mqtt in","z":"2159e868.08f748","name":"Guest presence","topic":"presence_detection/guest","qos":"2","broker":"e67c6dfd.2c6b98","x":160,"y":220,"wires":[["7fe9cfdc.3491","d3cf2332.21fe28"]]},{"id":"7fe9cfdc.3491","type":"function","z":"2159e868.08f748","name":"Set payload Guest","func":"\nvar datetime = new Date()\n\nglobal.set(\"last_detection_guest\", datetime)\n\nvar last_entrance_guest = global.get(\"last_entrance_guest\") || 0;\nvar threshold = global.get(\"detection_threshold\") || 0;\n\nvar timedif = datetime - last_entrance_guest;\n\nif(timedif > 1.5*threshold) global.set(\"guest_greeted\",false);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":280,"wires":[["e9c74b28.518da8"]]},{"id":"68425043.04f848","type":"function","z":"2159e868.08f748","name":"Check payload Guest","func":"var datetime = new Date()\n\nvar last_detection = global.get(\"last_detection_guest\") || 0;\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\n\nvar time_since_last_detection = datetime - last_detection\nnode.error(time_since_last_detection)\n\nif( time_since_last_detection > detection_threshold )\n{\n    msg.payload = false\n    msg.topic = \"Exit: \"\n    global.set(\"presence_guest\",false)\n}\nelse\n{\n    msg.payload = true\n    msg.topic = \"Came: \"\n    global.set(\"presence_guest\",true)\n}\n\nvar seconds = datetime.getSeconds()\nvar minutes = datetime.getMinutes()\nvar hours = datetime.getHours()\nvar day = datetime.getDate()\nvar month = datetime.getMonth() + 1\nvar year = datetime.getFullYear()\n\nvar time_parsed = hours.toString()\ntime_parsed += \":\"\nif(minutes < 10) time_parsed += \"0\"\ntime_parsed += minutes.toString()\ntime_parsed += \":\"\nif(seconds < 10) time_parsed += \"0\"\ntime_parsed += seconds.toString()\ntime_parsed += \"  \"\nif(day < 10) time_parsed += \"0\"\ntime_parsed += day.toString()\ntime_parsed += \"/\"\nif(month < 10) time_parsed += \"0\"\ntime_parsed += month.toString()\ntime_parsed += \"/\"\ntime_parsed += year.toString()\nmsg.timestamp = time_parsed\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":1360,"wires":[["97c7436d.7e363","b8e50d3e.09981"]]},{"id":"97c7436d.7e363","type":"switch","z":"2159e868.08f748","name":"Event at change","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"prev"}],"checkall":"true","repair":false,"outputs":1,"x":850,"y":1300,"wires":[["fcf480c2.ab8e5"]]},{"id":"fcf480c2.ab8e5","type":"switch","z":"2159e868.08f748","name":"Decide IN/OUT","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1060,"y":1300,"wires":[["1b49964a.458c92"],[]]},{"id":"ab0f135f.ec7d1","type":"ifttt out","z":"2159e868.08f748","eventName":"guest_at_home","key":"59f1345a.5292fc","x":1280,"y":1160,"wires":[]},{"id":"cee0404d.bcf81","type":"ifttt out","z":"2159e868.08f748","eventName":"guest_left_home","key":"59f1345a.5292fc","x":1290,"y":1420,"wires":[]},{"id":"1b49964a.458c92","type":"function","z":"2159e868.08f748","name":"Set greet message Guest","func":"var datetime = new Date()\n\nvar detection_threshold = global.get(\"detection_threshold\") || 0;\nvar entrance_detection_time = global.get(\"entrance_detection_time\") || 0;\n\nvar timedif = datetime - entrance_detection_time\n\nvar guest_greeted = global.get(\"guest_greeted\") || 0;\n\nnode.error(timedif)\n\nvar new_msg = {payload: \"\", greet: false}\n\n\nif((timedif < detection_threshold) && !guest_greeted)\n{\n    new_msg.greet = true;\n    global.set(\"guest_greeted\",true);\n}\n\n\nglobal.set(\"last_entrance_guest\", datetime)\n\nnew_msg.payload = \" -e hello -p guest\"\n\nreturn new_msg;","outputs":1,"noerr":0,"x":1480,"y":1200,"wires":[["4c70f5db.a81754"]]},{"id":"4c70f5db.a81754","type":"switch","z":"2159e868.08f748","name":"Decide to greet","property":"greet","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":1720,"y":1200,"wires":[["bbd96316.eee1"]]},{"id":"81ca9bea.f4e0b","type":"switch","z":"ebed6492.dd9558","name":"Greet Guest","property":"greet_guest","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":970,"y":700,"wires":[["9cbf9b63.e144f8"]]},{"id":"9cbf9b63.e144f8","type":"function","z":"ebed6492.dd9558","name":"Create greet command Guest","func":"\nmsg.payload = \" -e hello -p guest\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":700,"wires":[["b40c7bfe.d1b458"]]},{"id":"485d8a8e.09304c","type":"function","z":"ebed6492.dd9558","name":"Create goodbye command Guest","func":"\nmsg.payload = \" -e goodbye -p guest\"\n\nreturn msg;","outputs":1,"noerr":0,"x":1220,"y":1160,"wires":[["b40c7bfe.d1b458"]]},{"id":"fc34c5a2.90436","type":"ui_switch","z":"8874c4d3.200988","name":"Enable guest","label":"Enable guest","tooltip":"","group":"98675b2a.e610b","order":2,"width":0,"height":0,"passthru":true,"decouple":"false","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":360,"y":1300,"wires":[["96e247f3.b98c58"]]},{"id":"e4839656.7fd4f","type":"ui_text_input","z":"8874c4d3.200988","name":"Guest name","label":"Guest name","tooltip":"","group":"98675b2a.e610b","order":1,"width":0,"height":0,"passthru":false,"mode":"text","delay":"0","topic":"","x":350,"y":1360,"wires":[["251b167e.f594ea","89b98212.4dde48"]]},{"id":"20cff5cc.3eb962","type":"exec","z":"8874c4d3.200988","command":"/home/pi/Projects/audio_node/audio_node_offline","addpay":true,"append":"","useSpawn":"false","timer":"","oldrc":false,"name":"","x":1070,"y":1440,"wires":[["de3bf36b.d81908"],["de3bf36b.d81908"],["de3bf36b.d81908","66130f67.a8a418"]]},{"id":"8dfef724.e6179","type":"function","z":"8874c4d3.200988","name":"Generate guest audio commands","func":"\nvar guest_enable = global.get(\"guest_enable\");\nvar guest_name = flow.get(\"guest_name\");\n\nif(guest_enable)\n{\n    var command = \"-d -g \"\n    command += \"\\\"\"\n    command += guest_name\n    command += \"\\\"\"\n    \n    msg.payload = command\n\n    return msg;\n}\n\n\n\n","outputs":1,"noerr":0,"x":640,"y":1440,"wires":[["20cff5cc.3eb962","8c8d1f45.52bc98"]]},{"id":"d0fc94e6.9bb78","type":"ui_button","z":"8874c4d3.200988","name":"Delete","group":"1c273207.0a0e3e","order":24,"width":"12","height":"1","passthru":false,"label":"Delete","tooltip":"","color":"","bgcolor":"","icon":"","payload":"false","payloadType":"bool","topic":"","x":170,"y":1360,"wires":[["fc34c5a2.90436","e4839656.7fd4f"]]},{"id":"251b167e.f594ea","type":"function","z":"8874c4d3.200988","name":"Set guest name","func":"\nflow.set(\"guest_name\", msg.payload)\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":1360,"wires":[["dfac3255.4adb68"]]},{"id":"96e247f3.b98c58","type":"function","z":"8874c4d3.200988","name":"Set guest enable","func":"\nglobal.set(\"guest_enable\", msg.payload)\n","outputs":1,"noerr":0,"x":570,"y":1300,"wires":[["89b98212.4dde48"]]},{"id":"8c8d1f45.52bc98","type":"function","z":"8874c4d3.200988","name":"Set icon red","func":"\nmsg = {topic: \"Downloading...\",\n        background: \"RED\"\n    }\n\nreturn msg;","outputs":1,"noerr":0,"x":570,"y":1520,"wires":[["204071fe.1b83ae"]]},{"id":"e9c74b28.518da8","type":"switch","z":"2159e868.08f748","name":"Guest enabled","property":"guest_enable","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":440,"y":1240,"wires":[["68425043.04f848"]]},{"id":"c0825a6e.c66b78","type":"switch","z":"ebed6492.dd9558","name":"Guest enabled","property":"guest_enable","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":960,"y":1160,"wires":[["485d8a8e.09304c"]]},{"id":"49746e12.2f502","type":"switch","z":"ebed6492.dd9558","name":"Guest enabled","property":"guest_enable","propertyType":"global","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":760,"y":700,"wires":[["81ca9bea.f4e0b"]]},{"id":"dbe28fe6.8e23d","type":"mqtt in","z":"8874c4d3.200988","name":"Download complete","topic":"audio_node/download_complete","qos":"2","broker":"e67c6dfd.2c6b98","x":180,"y":1580,"wires":[["66130f67.a8a418","c65f48f7.10e69"]]},{"id":"66130f67.a8a418","type":"function","z":"8874c4d3.200988","name":"Set icon blue","func":"msg = {topic: \"Updated\",\n        background: \"GREEN\"\n    }\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1580,"wires":[["204071fe.1b83ae"]]},{"id":"de3bf36b.d81908","type":"debug","z":"8874c4d3.200988","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1430,"y":1440,"wires":[]},{"id":"204071fe.1b83ae","type":"ui_button","z":"8874c4d3.200988","name":"Online","group":"98675b2a.e610b","order":2,"width":0,"height":0,"passthru":false,"label":"{{msg.topic}}","tooltip":"","color":"","bgcolor":"{{msg.background}}","icon":"","payload":"","payloadType":"str","topic":"","x":390,"y":1440,"wires":[["8dfef724.e6179"]]},{"id":"6c4076f3.7153d8","type":"inject","z":"8874c4d3.200988","name":"Trigger once","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"0.1","x":190,"y":1660,"wires":[["66130f67.a8a418"]]},{"id":"c65f48f7.10e69","type":"debug","z":"8874c4d3.200988","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":440,"y":1680,"wires":[]},{"id":"b8e50d3e.09981","type":"ui_switch","z":"2159e868.08f748","name":"Guest","label":"Guest","tooltip":"","group":"c086012c.2407d8","order":3,"width":0,"height":0,"passthru":false,"decouple":"true","topic":"","style":"","onvalue":"true","onvalueType":"bool","onicon":"","oncolor":"","offvalue":"false","offvalueType":"bool","officon":"","offcolor":"","x":810,"y":1380,"wires":[[]]},{"id":"dfac3255.4adb68","type":"debug","z":"8874c4d3.200988","name":"Guest name","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":750,"y":1360,"wires":[]},{"id":"89b98212.4dde48","type":"function","z":"8874c4d3.200988","name":"Reset button state","func":"\n\nmsg = {topic: \"Update\",\n        background: \"BLUE\"\n        }\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":1440,"wires":[["204071fe.1b83ae"]]}]
